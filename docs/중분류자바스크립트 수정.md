// ì„œëŒ€ë¦¬ ê¸´ê¸‰ ìˆ˜ì •: ê¸°ì¡´ JavaScript ë¶€ë¶„ì„ ì´ ì½”ë“œë¡œ ì™„ì „ êµì²´

// ACIUApp ë„¤ì„ìŠ¤í˜ì´ìŠ¤ êµ¬ì¡° (ìˆ˜ì •ëœ ë²„ì „)
const ACIUApp = {
    // íƒ€ì´ë¨¸ ê´€ë¦¬
    timers: {
        timeUpdate: null,
        quoteUpdate: null,
        ddayUpdate: null
    },

    // ë¸Œë¼ìš°ì € í˜¸í™˜ì„± í™•ì¸
    compatibility: {
        checkBrowserSupport() {
            if (!window.localStorage) {
                ACIUApp.ui.showErrorMessage('localStorageë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.');
                return false;
            }
            return true;
        }
    },

    // ë°ì´í„° ê´€ë¦¬
    data: {
        questions: [],
        userSettings: {
            name: 'ì¡°ëŒ€í‘œë‹˜',
            examDate: '2025-10-25',
            lastUpdated: new Date().toISOString()
        },
        learningHistory: {
            attempts: {},
            lastUpdated: new Date().toISOString()
        },
        
        // ì¤‘ë¶„ë¥˜ í•™ìŠµìš© ë°ì´í„° êµ¬ì¡° (ë…¸íŒ€ì¥ í™•ì •)
        mainCategories: {
            '06ì¬ì‚°ë³´í—˜': [
                { name: 'í™”ì¬ë³´í—˜', count: 188 },
                { name: 'ì¬ë¬¼ë³´í—˜ì¬ë³´í—˜', count: 130 },
                { name: 'íŒ¨í‚¤ì§€ë³´í—˜', count: 53 }
            ],
            '07íŠ¹ì¢…ë³´í—˜': [
                { name: 'ë¯¸í™•ì¸', count: 110 },
                { name: 'ê¸°ìˆ ë³´í—˜', count: 93 },
                { name: 'ë²”ì£„ë³´í—˜', count: 51 }
            ],
            '08ë°°ìƒì±…ì„ë³´í—˜': [], // 50ë¬¸ì œ ì´ìƒ ì—†ìŒ
            '09í•´ìƒë³´í—˜': [
                { name: 'ë¯¸í™•ì¸', count: 165 },
                { name: 'í•´ìƒë³´í—˜ì¡°ê±´ê³¼ë³´ìƒë²”ìœ„', count: 57 },
                { name: 'í•´ìƒë³´í—˜ì˜ì†í•´ì‚¬ì •', count: 53 }
            ]
        },
        
        otherCategories: {
            '06ì¬ì‚°ë³´í—˜': [
                { name: 'ë™ì‚°ì¢…í•©ë³´í—˜', count: 15 },
                { name: 'ê¸°ì—…íœ´ì§€ë³´í—˜', count: 8 },
                { name: 'ì¬ë¬¼ë³´í—˜', count: 5 }
            ],
            '07íŠ¹ì¢…ë³´í—˜': [
                { name: 'ê¸°íƒ€íŠ¹ì¢…ë³´í—˜', count: 26 },
                { name: 'ì¢…í•©ë³´í—˜', count: 8 },
                { name: 'ê°œìš”', count: 4 }
            ],
            '08ë°°ìƒì±…ì„ë³´í—˜': [
                { name: 'ë³´ê´€ìë°°ìƒì±…ì„', count: 49 },
                { name: 'ì „ë¬¸ì§ì—…ë°°ìƒ', count: 47 },
                { name: 'ê°œìš”', count: 37 },
                { name: 'ë„ê¸‰ì—…ìë°°ìƒì±…ì„', count: 33 },
                { name: 'ì„ì›ë°°ìƒ', count: 32 },
                { name: 'ì‹œì„¤ì†Œìœ ê´€ë¦¬ì', count: 26 },
                { name: 'ìƒì‚°ë¬¼ë°°ìƒì±…ì„', count: 24 },
                { name: 'ê¸°íƒ€ì£¼ìš”ë³´í—˜', count: 20 }
            ],
            '09í•´ìƒë³´í—˜': [
                { name: 'ì í•˜ë³´í—˜', count: 42 },
                { name: 'í•´ìƒë³´í—˜ê¸°ì´ˆ', count: 33 },
                { name: 'ê³„ì•½ì˜ ì²´ê²°ê³¼ ë³´í—˜ë£Œ', count: 23 },
                { name: 'ì„ ë°•ë³´í—˜', count: 23 },
                { name: 'ìš´ì†¡ë³´í—˜', count: 20 },
                { name: 'í•´ìƒë³´í—˜ì¡°ê±´', count: 4 }
            ]
        },

        // CSV ë°ì´í„° ë¡œë”©
        async loadQuestions() {
            try {
                const response = await fetch('ins_master_db.csv');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const csvContent = await response.text();
                
                const parsed = Papa.parse(csvContent, {
                    header: true,
                    dynamicTyping: false,
                    skipEmptyLines: true,
                    delimiter: ',',
                    quoteChar: '"',
                    fastMode: true
                });

                // í•„í„°ë§: QCODEê°€ ìˆê³  SOURCEê°€ 'ì¸ìŠ¤êµì¬' ë˜ëŠ” 'ì¤‘ê°œì‚¬ì‹œí—˜'ì¸ ê²½ìš°
                this.questions = parsed.data.filter(row =>
                    row.QCODE && 
                    (row.SOURCE === 'ì¸ìŠ¤êµì¬' || row.SOURCE === 'ì¤‘ê°œì‚¬ì‹œí—˜')
                );

                console.log(`ë°ì´í„° ë¡œë”© ì™„ë£Œ: ${this.questions.length}ê°œ ë¬¸ì œ`);
                
                // ë°ì´í„° ë¡œë”© ì™„ë£Œ í›„ UI ì—…ë°ì´íŠ¸
                ACIUApp.ui.updateQuestionCounts();
                ACIUApp.ui.updateStatistics();
            } catch (error) {
                console.error('ë°ì´í„° ë¡œë”© ì‹¤íŒ¨:', error);
                ACIUApp.ui.showErrorMessage('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. íŒŒì¼ ê²½ë¡œë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
            }
        },

        // ì‚¬ìš©ì ì„¤ì • ë¡œë”©
        loadUserSettings() {
            try {
                const saved = localStorage.getItem('aciu_user_settings');
                if (saved) {
                    this.userSettings = { ...this.userSettings, ...JSON.parse(saved) };
                }
            } catch (error) {
                console.error('ì‚¬ìš©ì ì„¤ì • ë¡œë”© ì‹¤íŒ¨:', error);
            }
        },

        // ì‚¬ìš©ì ì„¤ì • ì €ì¥
        saveUserSettings() {
            try {
                localStorage.setItem('aciu_user_settings', JSON.stringify(this.userSettings));
            } catch (error) {
                console.error('ì‚¬ìš©ì ì„¤ì • ì €ì¥ ì‹¤íŒ¨:', error);
            }
        },

        // í•™ìŠµ ì´ë ¥ ë¡œë”©
        loadLearningHistory() {
            try {
                const saved = localStorage.getItem('aciu_learning_history');
                if (saved) {
                    this.learningHistory = { ...this.learningHistory, ...JSON.parse(saved) };
                }
            } catch (error) {
                console.error('í•™ìŠµ ì´ë ¥ ë¡œë”© ì‹¤íŒ¨:', error);
            }
        }
    },

    // UI ê´€ë¦¬
    ui: {
        // ì´ˆê¸°í™”
        init() {
            this.updateHeader();
            this.updateQuestionCounts();
            this.updateStatistics();
            this.updateQuote();
            this.updateCurrentTime();
            this.updateDdayCount();
        },

        // í—¤ë” ì—…ë°ì´íŠ¸
        updateHeader() {
            const userInfo = document.getElementById('user-info');
            const examDday = document.getElementById('exam-dday');
            
            if (userInfo) userInfo.textContent = `ì‚¬ìš©ì: ${ACIUApp.data.userSettings.name}`;
            
            const examDate = new Date(ACIUApp.data.userSettings.examDate);
            const today = new Date();
            const diffTime = examDate.getTime() - today.getTime();
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (examDday) examDday.textContent = `D-${Math.max(0, diffDays)}ì¼`;
        },

        // ì†ŒìŠ¤ë³„ ë¬¸ì œ ìˆ˜ ì—…ë°ì´íŠ¸
        updateQuestionCounts() {
            const questions = ACIUApp.data.questions;
            
            // ì†ŒìŠ¤ë³„ ë¬¸ì œ ìˆ˜ ê³„ì‚°
            const insQuestions = questions.filter(q => q.SOURCE === 'ì¸ìŠ¤êµì¬').length;
            const examQuestions = questions.filter(q => q.SOURCE === 'ì¤‘ê°œì‚¬ì‹œí—˜').length;
            const totalQuestions = questions.length;
            
            // UI ì—…ë°ì´íŠ¸
            const insElement = document.getElementById('ins-questions');
            const examElement = document.getElementById('exam-questions');
            const totalElement = document.getElementById('total-questions');
            
            if (insElement) insElement.textContent = insQuestions.toLocaleString();
            if (examElement) examElement.textContent = examQuestions.toLocaleString();
            if (totalElement) totalElement.textContent = totalQuestions.toLocaleString();
        },

        // í†µê³„ ì—…ë°ì´íŠ¸
        updateStatistics() {
            const totalQuestions = ACIUApp.data.questions.length;
            const solvedQcodes = new Set(Object.keys(ACIUApp.data.learningHistory.attempts));
            const overallRate = totalQuestions > 0 ? Math.round((solvedQcodes.size / totalQuestions) * 100) : 0;
            
            // ì¼ì¼ ì§„ë„ìœ¨
            const today = new Date().toISOString().slice(0, 10);
            const todayData = Object.values(ACIUApp.data.learningHistory.attempts)
                .filter(attempt => attempt.timestamp && attempt.timestamp.slice(0, 10) === today);
            const todaySolved = todayData.length;
            const todayCorrect = todayData.filter(attempt => attempt.correct).length;
            const dailyRate = todaySolved > 0 ? Math.round((todayCorrect / todaySolved) * 100) : 0;
            
            // UI ì—…ë°ì´íŠ¸
            const completedElement = document.getElementById('completed-questions');
            const overallElement = document.getElementById('overall-progress-rate');
            const dailyElement = document.getElementById('daily-progress-rate');
            
            if (completedElement) completedElement.textContent = solvedQcodes.size.toLocaleString();
            if (overallElement) overallElement.textContent = `${overallRate}%`;
            if (dailyElement) dailyElement.textContent = `${dailyRate}%`;
        },

        // í˜„ì¬ ì‹œê°„ ì—…ë°ì´íŠ¸
        updateCurrentTime() {
            const now = new Date();
            const timeString = now.toLocaleString('ko-KR', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                weekday: 'long',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: true
            });
            const timeElement = document.getElementById('current-time');
            if (timeElement) timeElement.textContent = timeString;
        },

        // ëª…ì–¸ ì—…ë°ì´íŠ¸
        updateQuote() {
            const quotes = [
                "í•™ìŠµì€ ê°€ì¥ ì¢‹ì€ íˆ¬ìì…ë‹ˆë‹¤.",
                "ê¾¸ì¤€í•¨ì´ ìµœê³ ì˜ ì¬ëŠ¥ì…ë‹ˆë‹¤.",
                "ì˜¤ëŠ˜ì˜ ë…¸ë ¥ì´ ë‚´ì¼ì˜ ì„±ê³µì„ ë§Œë“­ë‹ˆë‹¤.",
                "ì‹¤íŒ¨ëŠ” ì„±ê³µì˜ ì–´ë¨¸ë‹ˆì…ë‹ˆë‹¤.",
                "ì‘ì€ ì§„ì „ë„ í° ì„±ì·¨ì˜ ì‹œì‘ì…ë‹ˆë‹¤."
            ];
            
            const randomQuote = quotes[Math.floor(Math.random() * quotes.length)];
            const quoteElement = document.getElementById('quote-of-day');
            if (quoteElement) quoteElement.textContent = `"${randomQuote}"`;
        },

        // D-Day ì—…ë°ì´íŠ¸
        updateDdayCount() {
            const examDate = new Date(ACIUApp.data.userSettings.examDate);
            const today = new Date();
            const diffTime = examDate.getTime() - today.getTime();
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            const ddayElement = document.getElementById('exam-dday');
            if (ddayElement) ddayElement.textContent = `D-${Math.max(0, diffDays)}ì¼`;
        },

        // ì„¤ì • ëª¨ë‹¬ í‘œì‹œ
        showSettingsModal() {
            const nameInput = document.getElementById('user-name-input');
            const dateInput = document.getElementById('exam-date-input');
            const modal = document.getElementById('settings-modal');
            
            if (nameInput) nameInput.value = ACIUApp.data.userSettings.name;
            if (dateInput) dateInput.value = ACIUApp.data.userSettings.examDate;
            if (modal) modal.classList.remove('hidden');
        },

        // ì„¤ì • ëª¨ë‹¬ ìˆ¨ê¸°ê¸°
        hideSettingsModal() {
            const modal = document.getElementById('settings-modal');
            if (modal) modal.classList.add('hidden');
        },

        // ì„¤ì • ì €ì¥
        saveSettings() {
            const nameInput = document.getElementById('user-name-input');
            const dateInput = document.getElementById('exam-date-input');
            
            const name = nameInput ? nameInput.value.trim() : '';
            const examDate = dateInput ? dateInput.value : '';
            
            if (name) {
                ACIUApp.data.userSettings.name = name;
            }
            if (examDate) {
                ACIUApp.data.userSettings.examDate = examDate;
            }
            
            ACIUApp.data.userSettings.lastUpdated = new Date().toISOString();
            ACIUApp.data.saveUserSettings();
            this.updateHeader();
            this.hideSettingsModal();
        },

        // í†µê³„ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
        loadStatisticsData() {
            console.log('í†µê³„ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹œì‘');
            
            // í†µê³„ ì„¹ì…˜ í‘œì‹œ
            const statsSection = document.getElementById('statistics-section');
            if (statsSection) statsSection.classList.remove('hidden');
            
            console.log('í†µê³„ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ');
        },

        // ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ
        showErrorMessage(message) {
            alert(message);
        },

        // í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°
        goToHome() {
            console.log('í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°');
            
            // ëª¨ë“  í•™ìŠµ í™”ë©´ ìˆ¨ê¸°ê¸°
            const screens = [
                'basic-learning-screen',
                'large-category-learning-screen', 
                'mid-category-learning-screen'
            ];
            
            screens.forEach(screenId => {
                const screen = document.getElementById(screenId);
                if (screen) screen.classList.add('hidden');
            });
            
            // í˜„ì¬ ëª¨ë“œ ì—…ë°ì´íŠ¸
            const modeElement = document.getElementById('current-mode');
            if (modeElement) modeElement.textContent = 'ëª¨ë“œ ì„ íƒ';
        },

        // ì¤‘ë¶„ë¥˜ ì„ íƒ ê´€ë¦¬ì
        categorySelection: {
            selectedLargeCategory: null,
            selectedMidCategory: null,
            isOtherCategoryOpen: false,
            
            // ëŒ€ë¶„ë¥˜ ì„ íƒ ì‹œ ì¤‘ë¶„ë¥˜ í‘œì‹œ
            showMidCategories(largeCategory) {
                console.log('showMidCategories í˜¸ì¶œ:', largeCategory);
                
                this.selectedLargeCategory = largeCategory;
                this.selectedMidCategory = null;
                this.isOtherCategoryOpen = false;
                
                const container = document.querySelector('.main-category-buttons');
                if (!container) {
                    console.error('main-category-buttons ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                    return;
                }
                
                container.innerHTML = '';
                
                // ë©”ì¸ ì¹´í…Œê³ ë¦¬ ë²„íŠ¼ë“¤ ìƒì„±
                const mainCats = ACIUApp.data.mainCategories[largeCategory] || [];
                mainCats.forEach(cat => {
                    const button = this.createMainCategoryButton(cat.name, cat.count);
                    container.appendChild(button);
                });
                
                // ê¸°íƒ€ ë²„íŠ¼ ìƒì„± (ê¸°íƒ€ ì¹´í…Œê³ ë¦¬ê°€ ìˆëŠ” ê²½ìš°)
                const otherCats = ACIUApp.data.otherCategories[largeCategory] || [];
                if (otherCats.length > 0) {
                    const otherCount = otherCats.reduce((sum, cat) => sum + cat.count, 0);
                    const otherButton = this.createOtherButton(otherCount);
                    container.appendChild(otherButton);
                }
                
                console.log('ì¤‘ë¶„ë¥˜ ë²„íŠ¼ ìƒì„± ì™„ë£Œ');
            },
            
            // ë©”ì¸ ì¹´í…Œê³ ë¦¬ ë²„íŠ¼ ìƒì„±
            createMainCategoryButton(name, count) {
                const button = document.createElement('button');
                button.className = 'main-category-button';
                button.innerHTML = `
                    ${name}
                    <span class="category-count">(${count}ë¬¸ì œ)</span>
                `;
                button.onclick = () => {
                    console.log('ì¤‘ë¶„ë¥˜ ë²„íŠ¼ í´ë¦­:', name);
                    this.selectMidCategory(name);
                };
                return button;
            },
            
            // ê¸°íƒ€ ë²„íŠ¼ ìƒì„±
            createOtherButton(totalCount) {
                const button = document.createElement('button');
                button.className = 'main-category-button other-button';
                button.innerHTML = `
                    ê¸°íƒ€ ì„¸ë¶€ë¶„ë¥˜
                    <span class="category-count">(${totalCount}ë¬¸ì œ)</span>
                `;
                button.onclick = () => {
                    console.log('ê¸°íƒ€ ë²„íŠ¼ í´ë¦­');
                    this.toggleOtherCategories();
                };
                return button;
            },
            
            // ì¤‘ë¶„ë¥˜ ì„ íƒ ì²˜ë¦¬
            selectMidCategory(categoryName) {
                console.log('selectMidCategory í˜¸ì¶œ:', categoryName);
                this.selectedMidCategory = categoryName;
                this.updateBreadcrumb();
                this.startQuestionMode();
            },
            
            // ë¸Œë ˆë“œí¬ëŸ¼ ì—…ë°ì´íŠ¸
            updateBreadcrumb() {
                const largeCatElement = document.getElementById('selected-large-category');
                const midCatElement = document.getElementById('selected-mid-category');
                
                if (largeCatElement) largeCatElement.textContent = this.selectedLargeCategory || 'ì—†ìŒ';
                if (midCatElement) midCatElement.textContent = this.selectedMidCategory || 'ì—†ìŒ';
            },
            
            // ë¬¸ì œ ëª¨ë“œ ì‹œì‘
            startQuestionMode() {
                console.log('startQuestionMode í˜¸ì¶œ');
                
                // ë¬¸ì œ í‘œì‹œ ì˜ì—­ í‘œì‹œ
                const questionArea = document.getElementById('mid-category-question-area');
                if (questionArea) {
                    questionArea.classList.remove('hidden');
                    
                    // ë”ë¯¸ ë¬¸ì œ í‘œì‹œ
                    const questionText = document.getElementById('mid-category-question-text');
                    if (questionText) {
                        questionText.textContent = `${this.selectedLargeCategory} > ${this.selectedMidCategory} ê´€ë ¨ ë”ë¯¸ ë¬¸ì œì…ë‹ˆë‹¤.`;
                    }
                    
                    // ë”ë¯¸ ë‹µì•ˆ ë²„íŠ¼ ìƒì„±
                    this.createDummyAnswerButtons();
                    
                    console.log('ë¬¸ì œ í‘œì‹œ ì™„ë£Œ');
                } else {
                    console.error('ë¬¸ì œ í‘œì‹œ ì˜ì—­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                }
            },
            
            // ë”ë¯¸ ë‹µì•ˆ ë²„íŠ¼ ìƒì„±
            createDummyAnswerButtons() {
                const container = document.getElementById('mid-category-answer-buttons');
                if (!container) return;
                
                container.innerHTML = '';
                container.className = 'grid grid-cols-2 gap-4 mb-6';
                
                // ì§„ìœ„í˜• ë²„íŠ¼ ìƒì„±
                const oButton = document.createElement('button');
                oButton.className = 'answer-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg';
                oButton.textContent = 'O';
                oButton.onclick = () => alert('O ì„ íƒë¨ (ë”ë¯¸)');
                container.appendChild(oButton);
                
                const xButton = document.createElement('button');
                xButton.className = 'answer-btn bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-lg';
                xButton.textContent = 'X';
                xButton.onclick = () => alert('X ì„ íƒë¨ (ë”ë¯¸)');
                container.appendChild(xButton);
            },
            
            // ê¸°íƒ€ ì¹´í…Œê³ ë¦¬ í† ê¸€
            toggleOtherCategories() {
                console.log('toggleOtherCategories í˜¸ì¶œ');
                // ê¸°íƒ€ ì¹´í…Œê³ ë¦¬ í† ê¸€ ë¡œì§ (í–¥í›„ êµ¬í˜„)
            }
        }
    },

    // í•™ìŠµ ì—”ì§„
    learning: {
        // í•™ìŠµ ìƒíƒœ ë³€ìˆ˜
        currentQuestionIndex: 0,
        filteredQuestions: [],
        selectedAnswer: null,
        currentQuestion: null,

        // í•™ìŠµ ëª¨ë“œ ì‹œì‘
        startMode(mode) {
            console.log(`í•™ìŠµ ëª¨ë“œ ì‹œì‘: ${mode}`);
            
            try {
                if (mode === 'basic') {
                    this.startBasicLearning();
                } else if (mode === 'layer1') {
                    this.startLargeCategoryLearning();
                } else if (mode === 'layer2') {
                    this.startMidCategoryLearning();
                } else {
                    alert(`${mode} ëª¨ë“œê°€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.`);
                }
            } catch (error) {
                console.error('í•™ìŠµ ëª¨ë“œ ì‹œì‘ ì—ëŸ¬:', error);
                alert('í•™ìŠµ ëª¨ë“œ ì‹œì‘ ì¤‘ ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        },

        // ê¸°ë³¸ í•™ìŠµ ì‹œì‘
        startBasicLearning() {
            console.log('ê¸°ë³¸ í•™ìŠµ ëª¨ë“œ ì‹œì‘');
            
            // ê¸°ë³¸ í•™ìŠµ í™”ë©´ í‘œì‹œ
            const screen = document.getElementById('basic-learning-screen');
            if (screen) {
                screen.classList.remove('hidden');
                console.log('ê¸°ë³¸ í•™ìŠµ í™”ë©´ í‘œì‹œë¨');
            } else {
                console.error('ê¸°ë³¸ í•™ìŠµ í™”ë©´ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
            }
            
            // í˜„ì¬ ëª¨ë“œ ì—…ë°ì´íŠ¸
            const modeElement = document.getElementById('current-mode');
            if (modeElement) modeElement.textContent = 'ê¸°ë³¸ í•™ìŠµ';
        },

        // ëŒ€ë¶„ë¥˜ í•™ìŠµ ì‹œì‘
        startLargeCategoryLearning() {
            console.log('ëŒ€ë¶„ë¥˜ í•™ìŠµ ëª¨ë“œ ì‹œì‘');
            
            // ëŒ€ë¶„ë¥˜ í•™ìŠµ í™”ë©´ í‘œì‹œ
            const screen = document.getElementById('large-category-learning-screen');
            if (screen) {
                screen.classList.remove('hidden');
                console.log('ëŒ€ë¶„ë¥˜ í•™ìŠµ í™”ë©´ í‘œì‹œë¨');
            } else {
                console.error('ëŒ€ë¶„ë¥˜ í•™ìŠµ í™”ë©´ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
            }
            
            // í˜„ì¬ ëª¨ë“œ ì—…ë°ì´íŠ¸
            const modeElement = document.getElementById('current-mode');
            if (modeElement) modeElement.textContent = 'ëŒ€ë¶„ë¥˜ í•™ìŠµ';
        },

        // ì¤‘ë¶„ë¥˜ í•™ìŠµ ì‹œì‘
        startMidCategoryLearning() {
            console.log('ì¤‘ë¶„ë¥˜ í•™ìŠµ ëª¨ë“œ ì‹œì‘');
            
            // ì¤‘ë¶„ë¥˜ í•™ìŠµ í™”ë©´ í‘œì‹œ
            const screen = document.getElementById('mid-category-learning-screen');
            if (screen) {
                screen.classList.remove('hidden');
                console.log('ì¤‘ë¶„ë¥˜ í•™ìŠµ í™”ë©´ í‘œì‹œë¨');
            } else {
                console.error('ì¤‘ë¶„ë¥˜ í•™ìŠµ í™”ë©´ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                return;
            }
            
            // í˜„ì¬ ëª¨ë“œ ì—…ë°ì´íŠ¸
            const modeElement = document.getElementById('current-mode');
            if (modeElement) modeElement.textContent = 'ì¤‘ë¶„ë¥˜ í•™ìŠµ';
            
            // ëŒ€ë¶„ë¥˜ ë²„íŠ¼ë“¤ ìƒì„±
            this.createLargeCategoryButtons();
        },

        // ëŒ€ë¶„ë¥˜ ë²„íŠ¼ë“¤ ìƒì„±
        createLargeCategoryButtons() {
            console.log('ëŒ€ë¶„ë¥˜ ë²„íŠ¼ ìƒì„± ì‹œì‘');
            
            const container = document.querySelector('.main-category-buttons');
            if (!container) {
                console.error('main-category-buttons ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                return;
            }
            
            container.innerHTML = '';
            
            const largeCategories = ['06ì¬ì‚°ë³´í—˜', '07íŠ¹ì¢…ë³´í—˜', '08ë°°ìƒì±…ì„ë³´í—˜', '09í•´ìƒë³´í—˜'];
            
            largeCategories.forEach(category => {
                const button = document.createElement('button');
                button.className = 'main-category-button';
                button.innerHTML = `
                    ${category}
                    <span class="category-count">(${this.getTotalQuestionCount(category)}ë¬¸ì œ)</span>
                `;
                button.onclick = () => {
                    console.log('ëŒ€ë¶„ë¥˜ ë²„íŠ¼ í´ë¦­:', category);
                    ACIUApp.ui.categorySelection.showMidCategories(category);
                };
                container.appendChild(button);
            });
            
            console.log('ëŒ€ë¶„ë¥˜ ë²„íŠ¼ ìƒì„± ì™„ë£Œ');
        },

        // ëŒ€ë¶„ë¥˜ë³„ ì´ ë¬¸ì œ ìˆ˜ ê³„ì‚°
        getTotalQuestionCount(largeCategory) {
            const mainCats = ACIUApp.data.mainCategories[largeCategory] || [];
            const otherCats = ACIUApp.data.otherCategories[largeCategory] || [];
            
            const mainCount = mainCats.reduce((sum, cat) => sum + cat.count, 0);
            const otherCount = otherCats.reduce((sum, cat) => sum + cat.count, 0);
            
            return mainCount + otherCount;
        }
    }
};

// ACIUApp ì´ˆê¸°í™” í•¨ìˆ˜
ACIUApp.init = async function() {
    console.log('ACIUApp ì´ˆê¸°í™” ì‹œì‘');
    
    try {
        // ë¸Œë¼ìš°ì € í˜¸í™˜ì„± í™•ì¸
        this.compatibility.checkBrowserSupport();
        
        // ë°ì´í„° ë¡œë”©
        await this.data.loadQuestions();
        this.data.loadUserSettings();
        this.data.loadLearningHistory();
        
        // UI ì´ˆê¸°í™”
        this.ui.init();
        
        // íƒ€ì´ë¨¸ ì„¤ì •
        this.timers.timeUpdate = setInterval(() => this.ui.updateCurrentTime(), 1000);
        this.timers.quoteUpdate = setInterval(() => this.ui.updateQuote(), 300000); // 5ë¶„ë§ˆë‹¤
        this.timers.ddayUpdate = setInterval(() => this.ui.updateDdayCount(), 3600000); // 1ì‹œê°„ë§ˆë‹¤
        
        console.log('ACIUApp ì´ˆê¸°í™” ì™„ë£Œ');
        
    } catch (error) {
        console.error('ACIUApp ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
        alert('ì•± ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
    }
};

// í…ŒìŠ¤íŠ¸ í•¨ìˆ˜ë“¤
window.testMidCategoryFunction = function() {
    console.log('=== ì¤‘ë¶„ë¥˜ í•™ìŠµ í…ŒìŠ¤íŠ¸ ì‹œì‘ ===');
    console.log('ACIUApp ì¡´ì¬ ì—¬ë¶€:', typeof ACIUApp !== 'undefined');
    console.log('ACIUApp.learning ì¡´ì¬ ì—¬ë¶€:', typeof ACIUApp.learning !== 'undefined');
    console.log('ACIUApp.learning.startMode ì¡´ì¬ ì—¬ë¶€:', typeof ACIUApp.learning.startMode !== 'undefined');
    console.log('mid-category-learning-screen ìš”ì†Œ ì¡´ì¬ ì—¬ë¶€:', !!document.getElementById('mid-category-learning-screen'));
    console.log('=== í…ŒìŠ¤íŠ¸ ì™„ë£Œ ===');
};

window.testMidCategoryButton = function() {
    console.log('=== ì¤‘ë¶„ë¥˜ í•™ìŠµ ë²„íŠ¼ í´ë¦­ í…ŒìŠ¤íŠ¸ ===');
    
    try {
        // 1. ACIUApp ì¡´ì¬ í™•ì¸
        if (typeof ACIUApp === 'undefined') {
            console.error('âŒ ACIUAppì´ ì •ì˜ë˜ì§€ ì•ŠìŒ');
            alert('ACIUAppì´ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
            return;
        }
        console.log('âœ… ACIUApp ì¡´ì¬ í™•ì¸');
        
        // 2. learning ê°ì²´ í™•ì¸
        if (typeof ACIUApp.learning === 'undefined') {
            console.error('âŒ ACIUApp.learningì´ ì •ì˜ë˜ì§€ ì•ŠìŒ');
            alert('í•™ìŠµ ëª¨ë“ˆì´ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
            return;
        }
        console.log('âœ… ACIUApp.learning ì¡´ì¬ í™•ì¸');
        
        // 3. startMode í•¨ìˆ˜ í™•ì¸
        if (typeof ACIUApp.learning.startMode !== 'function') {
            console.error('âŒ startMode í•¨ìˆ˜ê°€ ì •ì˜ë˜ì§€ ì•ŠìŒ');
            alert('í•™ìŠµ ëª¨ë“œ ì‹œì‘ í•¨ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }
        console.log('âœ… startMode í•¨ìˆ˜ ì¡´ì¬ í™•ì¸');
        
        // 4. ì¤‘ë¶„ë¥˜ í•™ìŠµ í™”ë©´ ìš”ì†Œ í™•ì¸
        const midCategoryScreen = document.getElementById('mid-category-learning-screen');
        if (!midCategoryScreen) {
            console.error('âŒ ì¤‘ë¶„ë¥˜ í•™ìŠµ í™”ë©´ ìš”ì†Œê°€ ì—†ìŒ');
            alert('ì¤‘ë¶„ë¥˜ í•™ìŠµ í™”ë©´ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }
        console.log('âœ… ì¤‘ë¶„ë¥˜ í•™ìŠµ í™”ë©´ ìš”ì†Œ ì¡´ì¬ í™•ì¸');
        
        // 5. ì‹¤ì œ í•¨ìˆ˜ í˜¸ì¶œ
        console.log('ğŸ”„ startMode("layer2") í˜¸ì¶œ ì‹œë„...');
        ACIUApp.learning.startMode('layer2');
        console.log('âœ… startMode("layer2") í˜¸ì¶œ ì™„ë£Œ');
        
    } catch (error) {
        console.error('âŒ ì—ëŸ¬ ë°œìƒ:', error);
        alert('ì¤‘ë¶„ë¥˜ í•™ìŠµ ì‹œì‘ ì¤‘ ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
    }
};

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
window.addEventListener('load', function() {
    ACIUApp.init();
});