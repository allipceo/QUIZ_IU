<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AICU QUIZ 앱 v3.8.5</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Papa Parse 라이브러리 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    
    <style>
        /* 기본 스타일 */
        .hidden {
            display: none !important;
        }
        
        .answer-btn {
            transition: all 0.3s ease;
        }
        
        .answer-btn:hover {
            transform: translateY(-2px);
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- 기본 컨테이너 -->
    <div id="app" class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-8">
            AICU QUIZ 앱 v3.8.5
        </h1>
        
        <!-- 홈 화면 (모듈 3.1) -->
        <div id="home-screen" class="bg-white rounded-lg shadow-md p-8">
            <!-- 첫 번째 박스 - D-day 카운터와 명언 -->
            <div class="bg-white rounded-lg shadow-lg p-8 mb-6">
                <!-- 상단 정보 -->
                <div class="flex justify-between items-start mb-6">
                    <!-- 좌측상단: 사용자명과 시험명 -->
                    <div class="text-left">
                        <div class="text-lg font-semibold text-gray-800" id="user-name-display">사용자: 조대표님</div>
                        <div class="text-sm text-gray-600">시험명: ACIU</div>
                    </div>
                    
                    <!-- 우측상단: 시험일 -->
                    <div class="text-right">
                        <div class="text-sm text-gray-600">시험일</div>
                        <div class="text-lg font-semibold text-gray-800" id="exam-date-display">2025년 12월 15일</div>
                    </div>
                </div>
                
                <!-- D-day 카운터 -->
                <div class="text-center mb-6">
                    <div class="text-6xl font-bold text-blue-600 mb-2" id="d-day-display">D-138일</div>
                    <div class="text-sm text-gray-600">시험까지 남은 일수</div>
                </div>
                
                <!-- 오늘의 명언 -->
                <div class="text-center">
                    <p class="text-3xl text-gray-700 italic font-medium" id="quote-of-day">
                        "꾸준함이 최고의 재능입니다."
                    </p>
                </div>
            </div>

            <!-- 설정 버튼과 통계 데이터 불러오기 버튼 -->
            <div class="flex justify-end mb-4 space-x-3">
                <button onclick="loadStatisticsData()" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded text-sm">
                    📊 통계 데이터 불러오기
                </button>
                <button onclick="openUserSettings()" class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-2 rounded text-sm">
                    ⚙️ 설정
                </button>
            </div>

            <!-- 보유 문제수 현황 -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">보유 문제수 현황</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="text-center">
                        <div class="text-2xl font-bold text-blue-600" id="ins-questions">0</div>
                        <div class="text-sm text-gray-600">인스교재</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-green-600" id="exam-questions">0</div>
                        <div class="text-sm text-gray-600">보험중개사시험</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-purple-600" id="total-questions">0</div>
                        <div class="text-sm text-gray-600">합계</div>
                    </div>
                </div>
            </div>

            <!-- 학습 진도 현황 -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">학습 진도 현황</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="text-center">
                        <div class="text-2xl font-bold text-blue-600" id="completed-questions">0</div>
                        <div class="text-sm text-gray-600">완료한 문제</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-green-600" id="overall-progress-rate">0%</div>
                        <div class="text-sm text-gray-600">전체 진도율</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-orange-600" id="daily-progress-rate">0%</div>
                        <div class="text-sm text-gray-600">오늘 진도율</div>
                    </div>
                </div>
            </div>

            <!-- 학습 모드 선택 -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">학습 모드를 선택해주세요</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-4">
                    <button onclick="selectLearningMode('basic')" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-4 px-6 rounded-lg">
                        기본 학습
                    </button>
                    <button onclick="selectLearningMode('large-category')" class="bg-green-500 hover:bg-green-600 text-white font-bold py-4 px-6 rounded-lg">
                        대분류 학습
                    </button>
                    <button onclick="selectLearningMode('sub-category')" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-4 px-6 rounded-lg">
                        중분류 학습
                    </button>
                    <button onclick="selectLearningMode('choice')" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-4 px-6 rounded-lg">
                        선택형 학습
                    </button>
                    <button onclick="selectLearningMode('truefalse')" class="bg-red-500 hover:bg-red-600 text-white font-bold py-4 px-6 rounded-lg">
                        진위형 학습
                    </button>
                    <button onclick="selectLearningMode('mock')" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-4 px-6 rounded-lg">
                        모의고사
                    </button>
                </div>
            </div>


        </div>
        
        <!-- 사용자 설정 모달 -->
        <div id="user-settings-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
            <div class="bg-white rounded-lg p-8 max-w-md w-full mx-4">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-semibold text-gray-800">사용자 설정</h3>
                    <button onclick="closeUserSettings()" class="text-gray-500 hover:text-gray-700 text-2xl">
                        ×
                    </button>
                </div>
                
                <form id="user-settings-form" class="space-y-4">
                    <div>
                        <label for="user-name" class="block text-sm font-medium text-gray-700 mb-2">사용자 이름 *</label>
                        <input type="text" id="user-name" name="user-name" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="이름을 입력하세요">
                    </div>
                    
                    <div>
                        <label for="user-phone" class="block text-sm font-medium text-gray-700 mb-2">휴대폰 번호 *</label>
                        <input type="tel" id="user-phone" name="user-phone" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="010-1234-5678">
                    </div>
                    
                    <div>
                        <label for="exam-subject" class="block text-sm font-medium text-gray-700 mb-2">응시 과목</label>
                        <input type="text" id="exam-subject" name="exam-subject" readonly
                               class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100"
                               value="ACIU">
                        <p class="text-xs text-gray-500 mt-1">ACIU로 확정되었습니다</p>
                    </div>
                    
                    <div>
                        <label for="exam-date" class="block text-sm font-medium text-gray-700 mb-2">응시일 *</label>
                        <input type="date" id="exam-date" name="exam-date" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div class="flex space-x-3 pt-4">
                        <button type="submit" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">
                            저장
                        </button>
                        <button type="button" onclick="closeUserSettings()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded">
                            취소
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- 기본학습 화면 (모듈 3.2) -->
        <div id="basic-learning-screen" class="bg-white rounded-lg shadow-md p-8 hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-semibold">기본학습</h2>
                <button onclick="goHome()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">
                    홈으로
                </button>
            </div>
            
            <!-- 학습 방식 선택 -->
            <div class="mb-8">
                <h3 class="text-lg font-semibold mb-4">학습 방식 선택</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <button onclick="selectBasicLearningMode('continue')" class="bg-blue-500 hover:bg-blue-600 text-white p-4 rounded-lg text-center">
                        <div class="text-2xl mb-2">🔄</div>
                        <div class="font-semibold">이어풀기</div>
                        <div class="text-sm opacity-90">이전 진행상황부터 계속</div>
                    </button>
                    <button onclick="selectBasicLearningMode('restart')" class="bg-green-500 hover:bg-green-600 text-white p-4 rounded-lg text-center">
                        <div class="text-2xl mb-2">🔄</div>
                        <div class="font-semibold">처음풀기</div>
                        <div class="text-sm opacity-90">처음부터 다시 시작</div>
                    </button>
                    <button onclick="selectBasicLearningMode('random')" class="bg-purple-500 hover:bg-purple-600 text-white p-4 rounded-lg text-center">
                        <div class="text-2xl mb-2">🎲</div>
                        <div class="font-semibold">랜덤풀기</div>
                        <div class="text-sm opacity-90">무작위 순서로 학습</div>
                    </button>
                </div>
            </div>
            
            <!-- 기본학습 문제 표시 영역 -->
            <div id="basic-question-area" class="hidden">
                <h3 class="text-lg font-semibold mb-4">문제 풀이</h3>
                
                <!-- 문제 정보 -->
                <div class="mb-4 p-4 bg-gray-50 rounded">
                    <div class="flex justify-between items-center mb-2">
                        <span id="question-type" class="text-sm text-blue-600 font-medium">진위형</span>
                        <span id="question-code" class="text-sm text-gray-600">Q001</span>
                    </div>
                    <div id="layer-info" class="text-sm text-gray-500 mb-2">재산보험 > 일반재산보험</div>
                    <div id="question-text" class="text-lg font-medium">문제 텍스트가 여기에 표시됩니다.</div>
                </div>
                
                <!-- 답안 버튼 영역 -->
                <div id="answer-buttons" class="mb-4">
                    <!-- 동적으로 생성될 답안 버튼들 -->
                </div>
                
                <!-- 결과 표시 영역 -->
                <div id="result-area" class="hidden">
                    <div id="result-message" class="p-3 rounded font-medium"></div>
                </div>
                
                <!-- 네비게이션 버튼 -->
                <div class="flex justify-between mt-4">
                    <button onclick="prevQuestion('basic')" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">
                        이전 문제
                    </button>
                    <button onclick="checkAnswer('basic')" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">
                        정답 확인
                    </button>
                    <button onclick="nextQuestion('basic')" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">
                        다음 문제
                    </button>
                </div>
                

            </div>
        </div>
        
        <!-- 대분류학습 화면 (모듈 3.3) -->
        <div id="large-category-screen" class="bg-white rounded-lg shadow-md p-8 hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-semibold">대분류학습</h2>
                <div class="flex items-center space-x-4">
                    <div id="large-category-total-stats" class="text-sm text-gray-600">
                        <span>전체: 0문제</span> | <span>정답: 0개</span> | <span>정답률: 0%</span>
                    </div>
                    <button onclick="goHome()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">
                        홈으로
                    </button>
                </div>
            </div>
            
            <!-- 카테고리 선택 -->
            <div class="mb-8">
                <h3 class="text-lg font-semibold mb-4">카테고리 선택</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <button onclick="selectLargeCategory('재산보험')" class="bg-blue-500 hover:bg-blue-600 text-white p-4 rounded-lg text-center">
                        <div class="text-2xl mb-2">🏢</div>
                        <div class="font-semibold">재산보험</div>
                        <div class="text-sm opacity-90">일반재산보험</div>
                        <div class="mt-2 text-xs opacity-75">
                            <div>누적: 0문제 | 정답: 0개</div>
                            <div>금일: 0문제 | 정답: 0개</div>
                        </div>
                    </button>
                    <button onclick="selectLargeCategory('특종보험')" class="bg-green-500 hover:bg-green-600 text-white p-4 rounded-lg text-center">
                        <div class="text-2xl mb-2">🚗</div>
                        <div class="font-semibold">특종보험</div>
                        <div class="text-sm opacity-90">자동차보험</div>
                        <div class="mt-2 text-xs opacity-75">
                            <div>누적: 0문제 | 정답: 0개</div>
                            <div>금일: 0문제 | 정답: 0개</div>
                        </div>
                    </button>
                    <button onclick="selectLargeCategory('배상책임보험')" class="bg-yellow-500 hover:bg-yellow-600 text-white p-4 rounded-lg text-center">
                        <div class="text-2xl mb-2">⚖️</div>
                        <div class="font-semibold">배상책임보험</div>
                        <div class="text-sm opacity-90">책임보험</div>
                        <div class="mt-2 text-xs opacity-75">
                            <div>누적: 0문제 | 정답: 0개</div>
                            <div>금일: 0문제 | 정답: 0개</div>
                        </div>
                    </button>
                    <button onclick="selectLargeCategory('해상보험')" class="bg-purple-500 hover:bg-purple-600 text-white p-4 rounded-lg text-center">
                        <div class="text-2xl mb-2">🚢</div>
                        <div class="font-semibold">해상보험</div>
                        <div class="text-sm opacity-90">해상보험</div>
                        <div class="mt-2 text-xs opacity-75">
                            <div>누적: 0문제 | 정답: 0개</div>
                            <div>금일: 0문제 | 정답: 0개</div>
                        </div>
                    </button>
                </div>
            </div>
            
            <!-- 대분류학습 문제 표시 영역 -->
            <div id="large-category-question-area" class="hidden">
                <h3 class="text-lg font-semibold mb-4">문제 풀이</h3>
                
                <!-- 문제 정보 -->
                <div class="mb-4 p-4 bg-gray-50 rounded">
                    <div class="flex justify-between items-center mb-2">
                        <span id="large-category-question-type" class="text-sm text-blue-600 font-medium">진위형</span>
                        <span id="large-category-question-code" class="text-sm text-gray-600">Q001</span>
                    </div>
                    <div id="large-category-layer-info" class="text-sm text-gray-500 mb-2">재산보험 > 일반재산보험</div>
                    <div id="large-category-question-text" class="text-lg font-medium">문제 텍스트가 여기에 표시됩니다.</div>
                </div>
                
                <!-- 답안 버튼 영역 -->
                <div id="large-category-answer-buttons" class="mb-4">
                    <!-- 동적으로 생성될 답안 버튼들 -->
                </div>
                
                <!-- 결과 표시 영역 -->
                <div id="large-category-result-area" class="hidden">
                    <div id="large-category-result-message" class="p-3 rounded font-medium"></div>
                </div>
                
                <!-- 네비게이션 버튼 -->
                <div class="flex justify-between mt-4">
                    <button onclick="prevQuestion('large-category')" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">
                        이전 문제
                    </button>
                    <button onclick="checkAnswer('large-category')" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">
                        정답 확인
                    </button>
                    <button onclick="nextQuestion('large-category')" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">
                        다음 문제
                    </button>
                </div>
                
                <!-- 통계 정보 -->
                <div class="mt-6 p-4 bg-green-50 rounded">
                    <h4 class="font-semibold mb-2">학습 통계</h4>
                    <div class="grid grid-cols-3 gap-4 text-center">
                        <div>
                            <div class="text-2xl font-bold text-green-600" id="large-total-questions">0</div>
                            <div class="text-sm text-gray-600">총 문제</div>
                        </div>
                        <div>
                            <div class="text-2xl font-bold text-green-600" id="large-correct-answers">0</div>
                            <div class="text-sm text-gray-600">정답</div>
                        </div>
                        <div>
                            <div class="text-2xl font-bold text-red-600" id="large-incorrect-answers">0</div>
                            <div class="text-sm text-gray-600">오답</div>
                        </div>
                    </div>
                </div>
                
                <!-- 통계 정보 -->
                <div class="mt-6 p-4 bg-blue-50 rounded">
                    <h4 class="font-semibold mb-2">학습 통계</h4>
                    <div class="grid grid-cols-3 gap-4 text-center">
                        <div>
                            <div class="text-2xl font-bold text-blue-600" id="basic-total-questions">0</div>
                            <div class="text-sm text-gray-600">총 문제</div>
                        </div>
                        <div>
                            <div class="text-2xl font-bold text-green-600" id="basic-correct-answers">0</div>
                            <div class="text-sm text-gray-600">정답</div>
                        </div>
                        <div>
                            <div class="text-2xl font-bold text-red-600" id="basic-incorrect-answers">0</div>
                            <div class="text-sm text-gray-600">오답</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 기본 상태 표시 -->
        <div id="status" class="text-center text-gray-600 mb-4">
            앱 초기화 중...
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // 모듈 1.2: 모드별 설정 객체
        const MODE_CONFIG = {
            'basic': {
                resultArea: 'result-area',
                questionText: 'question-text',
                questionCode: 'question-code',
                questionType: 'question-type',
                layerInfo: 'layer-info',
                answerButtons: 'answer-buttons',
                resultMessage: 'result-message',
                prevButton: 'prev-button',
                nextButton: 'next-button',
                checkButton: 'check-button'
            },
            'large-category': {
                resultArea: 'large-category-result-area',
                questionText: 'large-category-question-text',
                questionCode: 'large-category-question-code',
                questionType: 'large-category-question-type',
                layerInfo: 'large-category-layer-info',
                answerButtons: 'large-category-answer-buttons',
                resultMessage: 'large-category-result-message',
                prevButton: 'large-category-prev-button',
                nextButton: 'large-category-next-button',
                checkButton: 'large-category-check-button'
            }
        };

        // 모듈 1.3: 데이터 로드 함수
        function loadCategoryData(category) {
            console.log(`=== ${category} 카테고리 데이터 로드 시작 ===`);
            
            // 카테고리별 파일명 매핑
            const fileMap = {
                '재산보험': 'ins_1db.csv',
                '특종보험': 'ins_2db.csv',
                '배상책임보험': 'ins_3db.csv',
                '해상보험': 'ins_4db.csv'
            };
            
            const filename = fileMap[category];
            if (!filename) {
                console.error(`알 수 없는 카테고리: ${category}`);
                return;
            }
            
            console.log(`${category} 카테고리 파일 로드: ${filename}`);
            
            Papa.parse(filename, {
                download: true,
                header: true,
                complete: (results) => {
                    console.log(`${category} CSV 데이터 로드 완료:`, results.data.length, '개 문제');
                    console.log('첫 번째 데이터 샘플:', results.data[0]);
                    
                    // 데이터 필터링 - 빈 행 제거
                    const filteredData = results.data.filter(row =>
                        row.QCODE && row.QUESTION && row.ANSWER && row.QCODE.trim() !== ''
                    );
                    
                    console.log(`필터링 후 문제 수: ${filteredData.length}개`);
                    console.log('필터링 후 첫 번째 문제:', filteredData[0]);
                    
                    // 전역 변수에 저장 (테스트용)
                    window.currentCategoryData = {
                        category: category,
                        data: filteredData,
                        filename: filename,
                        totalCount: filteredData.length
                    };
                    
                    // 테스트 결과 업데이트
                    updateDataLoadTest(category, filteredData.length, true);
                    
                    console.log(`=== ${category} 카테고리 데이터 로드 완료 ===`);
                },
                error: (error) => {
                    console.error('CSV 로드 오류:', error);
                    updateDataLoadTest(category, 0, false, error.message);
                }
            });
        }
        
        // 데이터 로드 테스트 결과 업데이트
        function updateDataLoadTest(category, count, success, errorMessage = '') {
            const testElement = document.getElementById('data-load-test');
            if (success) {
                testElement.textContent = `데이터 로드: ✅ ${category} (${count}개 문제)`;
                testElement.classList.add('text-green-600');
            } else {
                testElement.textContent = `데이터 로드: ❌ ${category} - ${errorMessage}`;
                testElement.classList.add('text-red-600');
            }
        }

        // 모듈 2.1: 문제 표시 함수
        function displayQuestion(mode = 'large-category', questionIndex = 0) {
            console.log(`=== 문제 표시 함수 실행 (모드: ${mode}, 인덱스: ${questionIndex}) ===`);
            
            // 현재 카테고리 데이터 확인
            if (!window.currentCategoryData || !window.currentCategoryData.data) {
                console.error('로드된 데이터가 없습니다. 먼저 카테고리를 선택해주세요.');
                updateDisplayTest('데이터 없음', false);
                return;
            }
            
            const questions = window.currentCategoryData.data;
            if (questionIndex >= questions.length) {
                console.error('문제 인덱스가 범위를 벗어났습니다.');
                updateDisplayTest('인덱스 오류', false);
                return;
            }
            
            const question = questions[questionIndex];
            console.log('표시할 문제:', question);
            
            // 모드별 설정 가져오기
            const config = MODE_CONFIG[mode];
            if (!config) {
                console.error(`알 수 없는 모드: ${mode}`);
                updateDisplayTest('모드 오류', false);
                return;
            }
            
            try {
                // 문제 정보 업데이트
                document.getElementById(config.questionType).textContent = 
                    question.TYPE === '진위형' ? '진위형' : '선택형';
                document.getElementById(config.questionCode).textContent = question.QCODE;
                document.getElementById(config.layerInfo).textContent = 
                    `${question.LAYER1} > ${question.LAYER2}`;
                document.getElementById(config.questionText).textContent = question.QUESTION;
                
                // 답안 버튼 생성
                createAnswerButtons(question, mode);
                
                // 문제 표시 영역 표시
                document.getElementById('large-category-question-area').classList.remove('hidden');
                
                // 결과 영역 숨기기
                document.getElementById(config.resultArea).classList.add('hidden');
                
                // 전역 변수 업데이트
                window.currentQuestionIndex = questionIndex;
                window.currentQuestion = question;
                window.currentMode = mode;
                
                // 진도 업데이트
                updateProgress();
                
                console.log(`문제 ${questionIndex + 1}/${questions.length} 표시 완료`);
                updateDisplayTest(`문제 ${questionIndex + 1} 표시 성공`, true);
                
            } catch (error) {
                console.error('문제 표시 중 오류:', error);
                updateDisplayTest('표시 오류', false);
            }
        }
        
        // 답안 버튼 생성 함수
        function createAnswerButtons(question, mode) {
            const config = MODE_CONFIG[mode];
            const buttonsContainer = document.getElementById(config.answerButtons);
            
            // 기존 버튼 제거
            buttonsContainer.innerHTML = '';
            
            if (question.TYPE === '진위형') {
                // 진위형 버튼 생성
                const oButton = document.createElement('button');
                oButton.className = 'answer-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg mr-4';
                oButton.textContent = 'O';
                oButton.setAttribute('data-answer', 'O');
                oButton.onclick = () => selectAnswer('O', mode);
                
                const xButton = document.createElement('button');
                xButton.className = 'answer-btn bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-lg';
                xButton.textContent = 'X';
                xButton.setAttribute('data-answer', 'X');
                xButton.onclick = () => selectAnswer('X', mode);
                
                buttonsContainer.appendChild(oButton);
                buttonsContainer.appendChild(xButton);
                
            } else {
                // 선택형 버튼 생성 (1-4번)
                for (let i = 1; i <= 4; i++) {
                    const button = document.createElement('button');
                    button.className = 'answer-btn bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg mr-4';
                    button.textContent = i.toString();
                    button.setAttribute('data-answer', i.toString());
                    button.onclick = () => selectAnswer(i.toString(), mode);
                    buttonsContainer.appendChild(button);
                }
            }
        }
        
        // 문제 표시 테스트 함수
        function testDisplayQuestion() {
            console.log('=== 문제 표시 테스트 시작 ===');
            
            // 더미 데이터로 테스트
            if (!window.currentCategoryData) {
                // 테스트용 더미 데이터 생성
                window.currentCategoryData = {
                    category: '재산보험',
                    data: [{
                        QCODE: 'Q001',
                        QUESTION: '재산보험의 기본 원리는 대인배상과 대물배상의 분리 원칙이다.',
                        ANSWER: 'O',
                        TYPE: '진위형',
                        LAYER1: '재산보험',
                        LAYER2: '일반재산보험'
                    }],
                    filename: 'ins_1db.csv',
                    totalCount: 1
                };
            }
            
            // 첫 번째 문제 표시
            displayQuestion('large-category', 0);
        }
        
        // 문제 표시 테스트 결과 업데이트
        function updateDisplayTest(message, success) {
            const testElement = document.getElementById('display-test');
            if (success) {
                testElement.textContent = `문제 표시: ✅ ${message}`;
                testElement.classList.add('text-green-600');
            } else {
                testElement.textContent = `문제 표시: ❌ ${message}`;
                testElement.classList.add('text-red-600');
            }
        }

        // 모듈 2.2: 답안 선택 함수
        function selectAnswer(answer, mode) {
            console.log(`=== 답안 선택 함수 실행 (답안: ${answer}, 모드: ${mode}) ===`);
            
            // 모드별 설정 가져오기
            const config = MODE_CONFIG[mode];
            if (!config) {
                console.error(`알 수 없는 모드: ${mode}`);
                return;
            }
            
            try {
                // 선택된 답안 저장
                window.selectedAnswer = answer;
                console.log('선택된 답안:', answer);
                
                // 모든 답안 버튼 초기화
                resetAnswerButtons(mode);
                
                // 선택된 버튼 하이라이트
                const selectedButton = document.querySelector(`[data-answer="${answer}"]`);
                if (selectedButton) {
                    selectedButton.classList.remove('bg-blue-500', 'bg-red-500', 'bg-gray-500');
                    selectedButton.classList.add('bg-yellow-500');
                    console.log('선택된 버튼 하이라이트 완료');
                } else {
                    console.error('선택된 답안 버튼을 찾을 수 없습니다.');
                }
                
                // 테스트 결과 업데이트
                updateSelectTest(`답안 "${answer}" 선택 성공`, true);
                
            } catch (error) {
                console.error('답안 선택 중 오류:', error);
                updateSelectTest('선택 오류', false);
            }
        }
        
        // 답안 버튼 초기화 함수
        function resetAnswerButtons(mode) {
            const config = MODE_CONFIG[mode];
            const buttons = document.querySelectorAll('.answer-btn');
            
            buttons.forEach(button => {
                const answer = button.getAttribute('data-answer');
                button.classList.remove('bg-yellow-500');
                
                // 기본 색상으로 복원
                if (answer === 'O') {
                    button.classList.add('bg-blue-500');
                } else if (answer === 'X') {
                    button.classList.add('bg-red-500');
                } else {
                    button.classList.add('bg-gray-500');
                }
            });
        }
        
        // 답안 선택 테스트 함수
        function testSelectAnswer() {
            console.log('=== 답안 선택 테스트 시작 ===');
            
            // 먼저 문제 표시
            if (!window.currentQuestion) {
                testDisplayQuestion();
                setTimeout(() => {
                    // O 답안 선택 테스트
                    selectAnswer('O', 'large-category');
                }, 500);
            } else {
                // O 답안 선택 테스트
                selectAnswer('O', 'large-category');
            }
        }
        
        // 답안 선택 테스트 결과 업데이트
        function updateSelectTest(message, success) {
            const testElement = document.getElementById('select-test');
            if (success) {
                testElement.textContent = `답안 선택: ✅ ${message}`;
                testElement.classList.add('text-green-600');
            } else {
                testElement.textContent = `답안 선택: ❌ ${message}`;
                testElement.classList.add('text-red-600');
            }
        }

        // 모듈 2.3: 정답 확인 함수
        function checkAnswer(mode) {
            console.log(`=== 정답 확인 함수 실행 (모드: ${mode}) ===`);
            
            // 선택된 답안 확인
            if (!window.selectedAnswer) {
                alert('답안을 선택해주세요.');
                updateCheckTest('답안 미선택', false);
                return;
            }
            
            // 현재 문제 확인
            if (!window.currentQuestion) {
                console.error('현재 문제가 없습니다.');
                updateCheckTest('문제 없음', false);
                return;
            }
            
            // 모드별 설정 가져오기
            const config = MODE_CONFIG[mode];
            if (!config) {
                console.error(`알 수 없는 모드: ${mode}`);
                updateCheckTest('모드 오류', false);
                return;
            }
            
            try {
                // 정답 비교
                const isCorrect = window.selectedAnswer === window.currentQuestion.ANSWER;
                console.log(`선택한 답안: ${window.selectedAnswer}, 정답: ${window.currentQuestion.ANSWER}, 정답여부: ${isCorrect}`);
                
                // 정답 확인 상태 저장
                window.isAnswerChecked = true;
                
                // 결과 메시지 생성
                const resultMessage = isCorrect ? 
                    '정답입니다! 🎉' : 
                    `오답입니다. 정답은 "${window.currentQuestion.ANSWER}"입니다.`;
                
                // 결과 영역 표시
                const resultArea = document.getElementById(config.resultArea);
                const resultMessageElement = document.getElementById(config.resultMessage);
                
                resultArea.classList.remove('hidden');
                resultMessageElement.textContent = resultMessage;
                resultMessageElement.className = `p-3 rounded font-medium ${isCorrect ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`;
                
                // 답안 버튼 색상 업데이트
                updateAnswerButtonColors(mode, isCorrect);
                
                // === 새로운 통계 업데이트 시스템 사용 ===
                const category = window.currentCategoryData?.category || null;
                updateAllStatistics(isCorrect, mode, category);
                
                // 기존 통계 업데이트 (호환성 유지)
                updateStatistics(isCorrect);
                
                // 모드별 통계 업데이트 (기존)
                if (mode === 'basic') {
                    updateBasicStatistics();
                } else if (mode === 'large-category') {
                    updateLargeCategoryStatistics();
                }
                
                console.log('정답 확인 완료');
                updateCheckTest(`정답 확인 완료 (${isCorrect ? '정답' : '오답'})`, true);
                
            } catch (error) {
                console.error('정답 확인 중 오류:', error);
                updateCheckTest('확인 오류', false);
            }
        }
        
        // 답안 버튼 색상 업데이트 함수
        function updateAnswerButtonColors(mode, isCorrect) {
            const buttons = document.querySelectorAll('.answer-btn');
            const correctAnswer = window.currentQuestion.ANSWER;
            const selectedAnswer = window.selectedAnswer;
            
            buttons.forEach(button => {
                const answer = button.getAttribute('data-answer');
                
                if (answer === correctAnswer) {
                    // 정답 버튼은 항상 초록색
                    button.classList.remove('bg-blue-500', 'bg-red-500', 'bg-gray-500', 'bg-yellow-500');
                    button.classList.add('bg-green-500');
                } else if (answer === selectedAnswer && !isCorrect) {
                    // 선택했지만 틀린 답안은 빨간색
                    button.classList.remove('bg-blue-500', 'bg-red-500', 'bg-gray-500', 'bg-yellow-500');
                    button.classList.add('bg-red-500');
                }
            });
        }
        
        // 통계 업데이트 함수 (실시간 대문 업데이트 포함)
        function updateStatistics(isCorrect) {
            if (!window.statistics) {
                window.statistics = {
                    total: 0,
                    correct: 0,
                    incorrect: 0
                };
            }
            
            window.statistics.total++;
            if (isCorrect) {
                window.statistics.correct++;
            } else {
                window.statistics.incorrect++;
            }
            
            console.log('기존 통계 업데이트:', window.statistics);
            
            // 정답률 표시 업데이트
            updateAccuracyDisplay();
            
            // 저장 및 대문 업데이트 (에러 처리 포함)
            try {
                saveProgress();
                // 대문이 표시되어 있을 때만 업데이트
                if (!document.getElementById('home-screen').classList.contains('hidden')) {
                    updateProgressData();
                    updateQuestionCounts();
                }
            } catch (error) {
                console.error('통계 업데이트 실패:', error);
            }
        }
        
        // 정답 확인 테스트 함수
        function testCheckAnswer() {
            console.log('=== 정답 확인 테스트 시작 ===');
            
            // 먼저 문제 표시 및 답안 선택
            if (!window.currentQuestion) {
                testDisplayQuestion();
                setTimeout(() => {
                    selectAnswer('O', 'large-category');
                    setTimeout(() => {
                        checkAnswer('large-category');
                    }, 500);
                }, 500);
            } else if (!window.selectedAnswer) {
                selectAnswer('O', 'large-category');
                setTimeout(() => {
                    checkAnswer('large-category');
                }, 500);
            } else {
                checkAnswer('large-category');
            }
        }
        
        // 정답 확인 테스트 결과 업데이트
        function updateCheckTest(message, success) {
            const testElement = document.getElementById('check-test');
            if (success) {
                testElement.textContent = `정답 확인: ✅ ${message}`;
                testElement.classList.add('text-green-600');
            } else {
                testElement.textContent = `정답 확인: ❌ ${message}`;
                testElement.classList.add('text-red-600');
            }
        }

        // 모듈 2.4: 다음 문제 함수
        function nextQuestion(mode) {
            console.log(`=== 다음 문제 함수 실행 (모드: ${mode}) ===`);
            
            // 현재 카테고리 데이터 확인
            if (!window.currentCategoryData || !window.currentCategoryData.data) {
                console.error('로드된 데이터가 없습니다.');
                updateNextTest('데이터 없음', false);
                return;
            }
            
            const questions = window.currentCategoryData.data;
            const currentIndex = window.currentQuestionIndex || 0;
            
            // 마지막 문제 확인
            if (currentIndex >= questions.length - 1) {
                alert('마지막 문제입니다.');
                updateNextTest('마지막 문제', false);
                return;
            }
            
            // 모드별 설정 가져오기
            const config = MODE_CONFIG[mode];
            if (!config) {
                console.error(`알 수 없는 모드: ${mode}`);
                updateNextTest('모드 오류', false);
                return;
            }
            
            try {
                // 다음 문제 인덱스 계산
                const nextIndex = currentIndex + 1;
                console.log(`현재 문제: ${currentIndex + 1}, 다음 문제: ${nextIndex + 1}`);
                
                // 다음 문제 표시
                displayQuestion(mode, nextIndex);
                
                // 선택된 답안 초기화
                window.selectedAnswer = null;
                window.isAnswerChecked = false;
                
                // 결과 영역 숨기기
                const resultArea = document.getElementById(config.resultArea);
                resultArea.classList.add('hidden');
                
                console.log('다음 문제로 이동 완료');
                updateNextTest(`다음 문제로 이동 (${nextIndex + 1}/${questions.length})`, true);
                
            } catch (error) {
                console.error('다음 문제 이동 중 오류:', error);
                updateNextTest('이동 오류', false);
            }
        }
        
        // 이전 문제 함수
        function prevQuestion(mode) {
            console.log(`=== 이전 문제 함수 실행 (모드: ${mode}) ===`);
            
            // 현재 카테고리 데이터 확인
            if (!window.currentCategoryData || !window.currentCategoryData.data) {
                console.error('로드된 데이터가 없습니다.');
                updateNextTest('데이터 없음', false);
                return;
            }
            
            const questions = window.currentCategoryData.data;
            const currentIndex = window.currentQuestionIndex || 0;
            
            // 첫 번째 문제 확인
            if (currentIndex <= 0) {
                alert('첫 번째 문제입니다.');
                updateNextTest('첫 번째 문제', false);
                return;
            }
            
            // 모드별 설정 가져오기
            const config = MODE_CONFIG[mode];
            if (!config) {
                console.error(`알 수 없는 모드: ${mode}`);
                updateNextTest('모드 오류', false);
                return;
            }
            
            try {
                // 이전 문제 인덱스 계산
                const prevIndex = currentIndex - 1;
                console.log(`현재 문제: ${currentIndex + 1}, 이전 문제: ${prevIndex + 1}`);
                
                // 이전 문제 표시
                displayQuestion(mode, prevIndex);
                
                // 선택된 답안 초기화
                window.selectedAnswer = null;
                window.isAnswerChecked = false;
                
                // 결과 영역 숨기기
                const resultArea = document.getElementById(config.resultArea);
                resultArea.classList.add('hidden');
                
                console.log('이전 문제로 이동 완료');
                updateNextTest(`이전 문제로 이동 (${prevIndex + 1}/${questions.length})`, true);
                
            } catch (error) {
                console.error('이전 문제 이동 중 오류:', error);
                updateNextTest('이동 오류', false);
            }
        }
        
        // 다음 문제 테스트 함수
        function testNextQuestion() {
            console.log('=== 다음 문제 테스트 시작 ===');
            
            // 더미 데이터로 여러 문제 생성
            if (!window.currentCategoryData) {
                window.currentCategoryData = {
                    category: '재산보험',
                    data: [
                        {
                            QCODE: 'Q001',
                            QUESTION: '재산보험의 기본 원리는 대인배상과 대물배상의 분리 원칙이다.',
                            ANSWER: 'O',
                            TYPE: '진위형',
                            LAYER1: '재산보험',
                            LAYER2: '일반재산보험'
                        },
                        {
                            QCODE: 'Q002',
                            QUESTION: '재산보험에서 보험사고가 발생하면 보험금을 지급한다.',
                            ANSWER: 'O',
                            TYPE: '진위형',
                            LAYER1: '재산보험',
                            LAYER2: '일반재산보험'
                        },
                        {
                            QCODE: 'Q003',
                            QUESTION: '재산보험의 보험료는 위험도에 따라 결정된다.',
                            ANSWER: 'O',
                            TYPE: '진위형',
                            LAYER1: '재산보험',
                            LAYER2: '일반재산보험'
                        }
                    ],
                    filename: 'ins_1db.csv',
                    totalCount: 3
                };
            }
            
            // 첫 번째 문제 표시 후 다음 문제로 이동
            displayQuestion('large-category', 0);
            setTimeout(() => {
                nextQuestion('large-category');
            }, 1000);
        }
        
        // 다음 문제 테스트 결과 업데이트
        function updateNextTest(message, success) {
            const testElement = document.getElementById('next-test');
            if (success) {
                testElement.textContent = `다음 문제: ✅ ${message}`;
                testElement.classList.add('text-green-600');
            } else {
                testElement.textContent = `다음 문제: ❌ ${message}`;
                testElement.classList.add('text-red-600');
            }
        }

        // 모듈 3.1: 학습 모드 선택 함수 (대문 기능 통합)
        
        // 모듈 3.2: 기본학습 모드 선택 함수
        function selectBasicLearningMode(mode) {
            console.log(`=== 기본학습 모드 선택: ${mode} ===`);
            
            // 기본학습 화면 표시
            document.getElementById('basic-learning-screen').classList.remove('hidden');
            
            // 문제 표시 영역 표시
            document.getElementById('basic-question-area').classList.remove('hidden');
            
            // 모드별 데이터 로드
            loadBasicLearningData(mode);
            
            // 상태 업데이트
            document.getElementById('status').textContent = `기본학습 - ${mode === 'continue' ? '이어풀기' : mode === 'restart' ? '처음풀기' : '랜덤풀기'}`;
            document.getElementById('status').className = 'text-center text-blue-600 mb-4 font-semibold';
        }
        
        // 기본학습 데이터 로드 함수
        function loadBasicLearningData(mode) {
            console.log(`기본학습 데이터 로드: ${mode}`);
            
            // 마스터 DB 파일명
            const filename = 'ins_master_db.csv';
            
            console.log(`기본학습 마스터 DB 로드: ${filename}`);
            
            Papa.parse(filename, {
                download: true,
                header: true,
                complete: (results) => {
                    console.log(`기본학습 CSV 데이터 로드 완료:`, results.data.length, '개 문제');
                    console.log('첫 번째 데이터 샘플:', results.data[0]);
                    
                    // 데이터 필터링 - 빈 행 제거
                    const filteredData = results.data.filter(row =>
                        row.QCODE && row.QUESTION && row.ANSWER && row.QCODE.trim() !== ''
                    );
                    
                    console.log(`필터링 후 문제 수: ${filteredData.length}개`);
                    console.log('필터링 후 첫 번째 문제:', filteredData[0]);
                    
                    // 모드별 데이터 처리
                    let processedData = [...filteredData];
                    
                    if (mode === 'random') {
                        // 랜덤 순서로 섞기
                        processedData = processedData.sort(() => Math.random() - 0.5);
                    } else if (mode === 'continue') {
                        // 이어풀기 - 저장된 진행상황이 있으면 그대로 사용
                        // 저장된 진행상황이 없으면 처음부터
                    } else if (mode === 'start') {
                        // 처음풀기 - 인덱스를 0으로 리셋
                        window.currentQuestionIndex = 0;
                    }
                    
                    // 전역 변수에 저장
                    window.currentCategoryData = {
                        category: '기본학습',
                        data: processedData,
                        filename: filename,
                        totalCount: processedData.length,
                        mode: mode
                    };
                    
                    // 첫 번째 문제 표시
                    displayQuestion('basic', 0);
                    
                    // 통계 초기화 (총 문제수 설정)
                    const stats = statisticsCache.get();
                    if (stats && window.currentCategoryData && window.currentCategoryData.data) {
                        stats.stats.modes.basic.cumulative.attempted = window.currentCategoryData.data.length;
                        statisticsCache.set(stats);
                        statisticsCache.flush();
                    }
                    updateBasicStatistics();
                    
                    console.log(`=== 기본학습 마스터 DB 로드 완료 ===`);
                },
                error: (error) => {
                    console.error('기본학습 CSV 로드 오류:', error);
                    alert('기본학습 데이터 로드 중 오류가 발생했습니다: ' + error.message);
                }
            });
        }
        
        // 기본학습 통계 업데이트 함수
        function updateBasicStatistics() {
            const stats = statisticsCache.get();
            if (stats) {
                updateBasicStats(stats);
            }
        }

        // 모듈 3.3: 대분류학습 카테고리 선택 함수
        function selectLargeCategory(category) {
            console.log(`=== 대분류학습 카테고리 선택: ${category} ===`);
            
            // 대분류학습 화면 표시
            document.getElementById('large-category-screen').classList.remove('hidden');
            
            // 문제 표시 영역 표시
            document.getElementById('large-category-question-area').classList.remove('hidden');
            
            // 카테고리별 데이터 로드
            loadCategoryData(category);
            
            // 통계 초기화
            updateLargeCategoryStatistics();
            
            // 상태 업데이트
            document.getElementById('status').textContent = `대분류학습 - ${category}`;
            document.getElementById('status').className = 'text-center text-green-600 mb-4 font-semibold';
        }
        
        // 대분류학습 통계 업데이트 함수
        function updateLargeCategoryStatistics() {
            const stats = statisticsCache.get();
            if (stats) {
                updateLargeCategoryStats(stats);
            }
        }

        // 대분류학습 화면 표시 함수
        function showLargeCategoryScreen() {
            console.log('대분류학습 화면 표시');
            
            // 홈 화면 숨기기
            document.getElementById('home-screen').classList.add('hidden');
            
            // 대분류학습 화면 표시
            document.getElementById('large-category-screen').classList.remove('hidden');
            
            // 상태 업데이트
            document.getElementById('status').textContent = '대분류학습 모드';
            document.getElementById('status').className = 'text-center text-green-600 mb-4 font-semibold';
        }
        
        // 기본학습 화면 표시 함수
        function showBasicLearningScreen() {
            console.log('기본학습 화면 표시');
            
            // 홈 화면 숨기기
            document.getElementById('home-screen').classList.add('hidden');
            
            // 기본학습 화면 표시
            document.getElementById('basic-learning-screen').classList.remove('hidden');
            
            // 상태 업데이트
            document.getElementById('status').textContent = '기본학습 모드';
            document.getElementById('status').className = 'text-center text-blue-600 mb-4 font-semibold';
        }

        // 홈 화면으로 돌아가기 함수
        function goHome() {
            console.log('홈 화면으로 돌아가기');
            
            // 모든 화면 숨기기
            const screens = ['home-screen', 'basic-learning-screen', 'large-category-screen'];
            screens.forEach(screenId => {
                const screen = document.getElementById(screenId);
                if (screen) {
                    screen.classList.add('hidden');
                }
            });
            
            // 홈 화면 표시
            document.getElementById('home-screen').classList.remove('hidden');
            
            // 상태 초기화
            document.getElementById('status').textContent = '홈 화면';
            document.getElementById('status').className = 'text-center text-gray-600 mb-4';
        }

        // 모듈 4.1: 진도 관리 함수
        function updateProgress() {
            console.log('=== 진도 관리 업데이트 ===');
            
            if (!window.currentCategoryData || !window.currentCategoryData.data) {
                console.log('진도 업데이트: 데이터 없음');
                return;
            }
            
            const totalQuestions = window.currentCategoryData.data.length;
            const currentIndex = window.currentQuestionIndex || 0;
            const completedQuestions = currentIndex + 1;
            const progressPercentage = Math.round((completedQuestions / totalQuestions) * 100);
            
            console.log(`진도: ${completedQuestions}/${totalQuestions} (${progressPercentage}%)`);
            
            // 진도 표시 업데이트
            updateProgressDisplay(completedQuestions, totalQuestions, progressPercentage);
            
            // 로컬 스토리지에 진도 저장
            saveProgressToStorage();
        }
        
        // 진도 표시 업데이트 함수
        function updateProgressDisplay(completed, total, percentage) {
            // 기본학습 진도 표시
            const basicProgressElement = document.getElementById('basic-progress');
            if (basicProgressElement) {
                basicProgressElement.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm font-medium">진도</span>
                        <span class="text-sm text-gray-600">${completed}/${total}</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-blue-600 h-2 rounded-full" style="width: ${percentage}%"></div>
                    </div>
                    <div class="text-xs text-gray-500 mt-1">${percentage}% 완료</div>
                `;
            }
            
            // 대분류학습 진도 표시
            const largeProgressElement = document.getElementById('large-progress');
            if (largeProgressElement) {
                largeProgressElement.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm font-medium">진도</span>
                        <span class="text-sm text-gray-600">${completed}/${total}</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-green-600 h-2 rounded-full" style="width: ${percentage}%"></div>
                    </div>
                    <div class="text-xs text-gray-500 mt-1">${percentage}% 완료</div>
                `;
            }
        }
        
        // 로컬 스토리지에 진도 저장
        function saveProgressToStorage() {
            if (!window.currentCategoryData) return;
            
            const progressData = {
                category: window.currentCategoryData.category,
                currentIndex: window.currentQuestionIndex || 0,
                totalQuestions: window.currentCategoryData.data.length,
                timestamp: new Date().toISOString(),
                mode: window.currentCategoryData.mode || 'unknown'
            };
            
            try {
                localStorage.setItem('aicu_progress', JSON.stringify(progressData));
                console.log('진도 저장 완료:', progressData);
            } catch (error) {
                console.error('진도 저장 실패:', error);
            }
        }
        
        // 로컬 스토리지에서 진도 로드
        function loadProgressFromStorage() {
            try {
                const savedProgress = localStorage.getItem('aicu_progress');
                if (savedProgress) {
                    const progressData = JSON.parse(savedProgress);
                    console.log('저장된 진도 로드:', progressData);
                    return progressData;
                }
            } catch (error) {
                console.error('진도 로드 실패:', error);
            }
            return null;
        }
        
        // 진도 테스트 함수
        function testProgress() {
            console.log('=== 진도 관리 테스트 ===');
            
            // 더미 데이터로 테스트
            if (!window.currentCategoryData) {
                window.currentCategoryData = {
                    category: '테스트',
                    data: [
                        { QCODE: 'Q001', QUESTION: '테스트 문제 1', ANSWER: 'O' },
                        { QCODE: 'Q002', QUESTION: '테스트 문제 2', ANSWER: 'X' },
                        { QCODE: 'Q003', QUESTION: '테스트 문제 3', ANSWER: 'O' }
                    ],
                    totalCount: 3
                };
            }
            
            // 진도 업데이트 테스트
            window.currentQuestionIndex = 1; // 두 번째 문제
            updateProgress();
            
            console.log('진도 관리 테스트 완료');
        }

        // 모듈 4.2: 정답률 계산 함수
        function calculateAccuracy() {
            console.log('=== 정답률 계산 ===');
            
            if (!window.statistics) {
                console.log('통계 데이터 없음');
                return 0;
            }
            
            const { total, correct } = window.statistics;
            if (total === 0) {
                console.log('총 문제 수가 0');
                return 0;
            }
            
            const accuracy = Math.round((correct / total) * 100);
            console.log(`정답률: ${correct}/${total} = ${accuracy}%`);
            
            return accuracy;
        }
        
        // 정답률 표시 업데이트 함수
        function updateAccuracyDisplay() {
            const accuracy = calculateAccuracy();
            
            // 기본학습 정답률 표시
            const basicAccuracyElement = document.getElementById('basic-accuracy');
            if (basicAccuracyElement) {
                basicAccuracyElement.innerHTML = `
                    <div class="text-center">
                        <div class="text-2xl font-bold text-blue-600">${accuracy}%</div>
                        <div class="text-sm text-gray-600">정답률</div>
                    </div>
                `;
            }
            
            // 대분류학습 정답률 표시
            const largeAccuracyElement = document.getElementById('large-accuracy');
            if (largeAccuracyElement) {
                largeAccuracyElement.innerHTML = `
                    <div class="text-center">
                        <div class="text-2xl font-bold text-green-600">${accuracy}%</div>
                        <div class="text-sm text-gray-600">정답률</div>
                    </div>
                `;
            }
            
            // 상세 통계 표시
            updateDetailedStatistics();
        }
        
        // 상세 통계 표시 함수
        function updateDetailedStatistics() {
            if (!window.statistics) return;
            
            const { total, correct, incorrect } = window.statistics;
            
            // 기본학습 상세 통계 업데이트
            const basicTotalElement = document.getElementById('total-questions');
            const basicCorrectElement = document.getElementById('correct-answers');
            const basicIncorrectElement = document.getElementById('incorrect-answers');
            
            if (basicTotalElement) basicTotalElement.textContent = total;
            if (basicCorrectElement) basicCorrectElement.textContent = correct;
            if (basicIncorrectElement) basicIncorrectElement.textContent = incorrect;
            
            // 대분류학습 상세 통계 업데이트
            const largeTotalElement = document.getElementById('large-total-questions');
            const largeCorrectElement = document.getElementById('large-correct-answers');
            const largeIncorrectElement = document.getElementById('large-incorrect-answers');
            
            if (largeTotalElement) largeTotalElement.textContent = total;
            if (largeCorrectElement) largeCorrectElement.textContent = correct;
            if (largeIncorrectElement) largeIncorrectElement.textContent = incorrect;
            
            console.log(`상세 통계 업데이트: 총 ${total}개, 정답 ${correct}개, 오답 ${incorrect}개`);
        }
        
        // 정답률 테스트 함수
        function testAccuracy() {
            console.log('=== 정답률 계산 테스트 ===');
            
            // 테스트 통계 설정
            window.statistics = {
                total: 10,
                correct: 7,
                incorrect: 3
            };
            
            // 정답률 계산 및 표시
            const accuracy = calculateAccuracy();
            updateAccuracyDisplay();
            
            console.log(`테스트 정답률: ${accuracy}%`);
            console.log('정답률 계산 테스트 완료');
        }

        // 모듈 4.3: 로컬 스토리지 함수
        function saveProgress() {
            console.log('=== 진행상황 저장 ===');
            
            const saveData = {
                // 현재 카테고리 정보
                category: window.currentCategoryData?.category || '',
                currentIndex: window.currentQuestionIndex || 0,
                totalQuestions: window.currentCategoryData?.data?.length || 0,
                
                // 통계 정보
                statistics: window.statistics || {
                    total: 0,
                    correct: 0,
                    incorrect: 0
                },
                
                // 선택된 답안
                selectedAnswer: window.selectedAnswer || null,
                
                // 현재 문제 정보
                currentQuestion: window.currentQuestion || null,
                
                // 모드 정보
                mode: window.currentMode || '',
                
                // 저장 시간
                timestamp: new Date().toISOString()
            };
            
            try {
                localStorage.setItem('aicu_save_data', JSON.stringify(saveData));
                console.log('진행상황 저장 완료:', saveData);
                return true;
            } catch (error) {
                console.error('진행상황 저장 실패:', error);
                return false;
            }
        }
        
        // 로컬 스토리지에서 진행상황 로드
        function loadProgress() {
            console.log('=== 진행상황 로드 ===');
            
            try {
                const savedData = localStorage.getItem('aicu_save_data');
                if (!savedData) {
                    console.log('저장된 진행상황 없음');
                    return false;
                }
                
                const data = JSON.parse(savedData);
                console.log('저장된 진행상황 로드:', data);
                
                // 데이터 복원
                if (data.statistics) {
                    window.statistics = data.statistics;
                }
                
                if (data.currentQuestion) {
                    window.currentQuestion = data.currentQuestion;
                }
                
                if (data.selectedAnswer !== null) {
                    window.selectedAnswer = data.selectedAnswer;
                }
                
                if (data.mode) {
                    window.currentMode = data.mode;
                }
                
                // 화면 복원
                restoreScreenFromSaveData(data);
                
                console.log('진행상황 복원 완료');
                return true;
                
            } catch (error) {
                console.error('진행상황 로드 실패:', error);
                return false;
            }
        }
        
        // 저장된 데이터로 화면 복원
        function restoreScreenFromSaveData(data) {
            if (!data.category) return;
            
            // 카테고리별 화면 복원
            if (data.category === '기본학습') {
                showBasicLearningScreen();
                // 기본학습 모드 선택 화면 숨기고 문제 표시
                document.getElementById('basic-question-area').classList.remove('hidden');
                
                // 저장된 인덱스로 문제 표시
                if (data.currentIndex !== undefined) {
                    displayQuestion('basic', data.currentIndex);
                }
                
            } else if (data.category.includes('보험')) {
                showLargeCategoryScreen();
                // 대분류학습 문제 표시 영역 표시
                document.getElementById('large-category-question-area').classList.remove('hidden');
                
                // 저장된 인덱스로 문제 표시
                if (data.currentIndex !== undefined) {
                    displayQuestion('large-category', data.currentIndex);
                }
            }
            
            // 통계 표시 업데이트
            updateAccuracyDisplay();
            updateProgress();
        }
        
        // 진행상황 삭제
        function clearProgress() {
            console.log('=== 진행상황 삭제 ===');
            
            try {
                localStorage.removeItem('aicu_save_data');
                localStorage.removeItem('aicu_progress');
                console.log('진행상황 삭제 완료');
                return true;
            } catch (error) {
                console.error('진행상황 삭제 실패:', error);
                return false;
            }
        }
        
        // 자동 저장 설정
        function setupAutoSave() {
            // 페이지 언로드 시 자동 저장
            window.addEventListener('beforeunload', function() {
                saveProgress();
            });
            
            // 30초마다 자동 저장
            setInterval(function() {
                if (window.currentCategoryData) {
                    saveProgress();
                }
            }, 30000);
            
            console.log('자동 저장 설정 완료');
        }
        
        // 로컬 스토리지 테스트 함수
        function testLocalStorage() {
            console.log('=== 로컬 스토리지 테스트 ===');
            
            // 테스트 데이터 설정
            window.currentCategoryData = {
                category: '테스트',
                data: [{ QCODE: 'Q001', QUESTION: '테스트', ANSWER: 'O' }],
                totalCount: 1
            };
            window.currentQuestionIndex = 0;
            window.statistics = { total: 5, correct: 3, incorrect: 2 };
            
            // 저장 테스트
            const saveResult = saveProgress();
            console.log('저장 테스트 결과:', saveResult);
            
            // 로드 테스트
            const loadResult = loadProgress();
            console.log('로드 테스트 결과:', loadResult);
            
            console.log('로컬 스토리지 테스트 완료');
        }

        // 모듈 1.1 테스트 함수
        function testModule11() {
            console.log('=== 모듈 1.1 테스트 시작 ===');
            
            // 1. HTML 구조 테스트
            const app = document.getElementById('app');
            const status = document.getElementById('status');
            const homeScreen = document.getElementById('home-screen');
            const devTestArea = document.getElementById('dev-test-area');
            
            if (app && status && homeScreen && devTestArea) {
                document.getElementById('html-test').textContent = 'HTML 구조: ✅ 정상';
                document.getElementById('html-test').classList.add('text-green-600');
            } else {
                document.getElementById('html-test').textContent = 'HTML 구조: ❌ 오류';
                document.getElementById('html-test').classList.add('text-red-600');
            }
            
            // 2. CSS 스타일 테스트
            const testDiv = document.createElement('div');
            testDiv.className = 'bg-blue-500 text-white p-2 rounded';
            testDiv.textContent = 'Tailwind CSS 테스트';
            document.body.appendChild(testDiv);
            
            setTimeout(() => {
                const computedStyle = window.getComputedStyle(testDiv);
                if (computedStyle.backgroundColor !== 'rgba(0, 0, 0, 0)') {
                    document.getElementById('css-test').textContent = 'CSS 스타일: ✅ 정상';
                    document.getElementById('css-test').classList.add('text-green-600');
                } else {
                    document.getElementById('css-test').textContent = 'CSS 스타일: ❌ 오류';
                    document.getElementById('css-test').classList.add('text-red-600');
                }
                document.body.removeChild(testDiv);
            }, 100);
            
            // 3. JavaScript 라이브러리 테스트
            if (typeof Papa !== 'undefined') {
                document.getElementById('js-test').textContent = 'JavaScript 라이브러리: ✅ Papa Parse 정상';
                document.getElementById('js-test').classList.add('text-green-600');
            } else {
                document.getElementById('js-test').textContent = 'JavaScript 라이브러리: ❌ Papa Parse 오류';
                document.getElementById('js-test').classList.add('text-red-600');
            }
            
            // 4. 상태 업데이트
            status.textContent = '모듈 1.1 테스트 완료';
            status.className = 'text-center text-green-600 mb-4 font-semibold';
            
            console.log('=== 모듈 1.1 테스트 완료 ===');
        }

        // 모듈 1.2 테스트 함수
        function testModule12() {
            console.log('=== 모듈 1.2 테스트 시작 ===');
            
            // 1. MODE_CONFIG 객체 존재 확인
            if (typeof MODE_CONFIG !== 'undefined') {
                document.getElementById('config-test').textContent = '설정 객체: ✅ MODE_CONFIG 정상';
                document.getElementById('config-test').classList.add('text-green-600');
            } else {
                document.getElementById('config-test').textContent = '설정 객체: ❌ MODE_CONFIG 오류';
                document.getElementById('config-test').classList.add('text-red-600');
            }
            
            // 2. 기본학습 모드 설정 확인
            if (MODE_CONFIG.basic && MODE_CONFIG.basic.questionText === 'question-text') {
                document.getElementById('basic-config-test').textContent = '기본학습 설정: ✅ 정상';
                document.getElementById('basic-config-test').classList.add('text-green-600');
            } else {
                document.getElementById('basic-config-test').textContent = '기본학습 설정: ❌ 오류';
                document.getElementById('basic-config-test').classList.add('text-red-600');
            }
            
            // 3. 대분류학습 모드 설정 확인
            if (MODE_CONFIG['large-category'] && MODE_CONFIG['large-category'].questionText === 'large-category-question-text') {
                document.getElementById('large-config-test').textContent = '대분류학습 설정: ✅ 정상';
                document.getElementById('large-config-test').classList.add('text-green-600');
            } else {
                document.getElementById('large-config-test').textContent = '대분류학습 설정: ❌ 오류';
                document.getElementById('large-config-test').classList.add('text-red-600');
            }
            
            // 4. 설정 객체 콘솔 출력
            console.log('MODE_CONFIG 객체:', MODE_CONFIG);
            console.log('기본학습 설정:', MODE_CONFIG.basic);
            console.log('대분류학습 설정:', MODE_CONFIG['large-category']);
            
            console.log('=== 모듈 1.2 테스트 완료 ===');
        }
        
        // 페이지 로드 시 테스트 실행
        document.addEventListener('DOMContentLoaded', function() {
            console.log('페이지 로드 완료 - 모듈 1.1, 1.2 테스트 시작');
            testModule11();
            setTimeout(() => {
                testModule12();
            }, 500);
            
            // 자동 저장 설정
            setupAutoSave();
            
            // 저장된 진행상황 복원 시도
            const hasSavedProgress = loadProgress();
            if (hasSavedProgress) {
                document.getElementById('status').textContent = '저장된 진행상황을 복원했습니다.';
                document.getElementById('status').className = 'text-center text-green-600 mb-4 font-semibold';
            }
        });

        // 모듈 5.1: 종합 기능 테스트
        function comprehensiveTest() {
            console.log('=== 종합 기능 테스트 시작 ===');
            
            const testResults = {
                basic: { passed: 0, total: 0, details: [] },
                largeCategory: { passed: 0, total: 0, details: [] },
                statistics: { passed: 0, total: 0, details: [] },
                storage: { passed: 0, total: 0, details: [] }
            };
            
            // 1. 기본학습 모드 테스트
            console.log('--- 기본학습 모드 테스트 ---');
            testBasicLearningMode(testResults.basic);
            
            // 2. 대분류학습 모드 테스트
            console.log('--- 대분류학습 모드 테스트 ---');
            testLargeCategoryMode(testResults.largeCategory);
            
            // 3. 통계 기능 테스트
            console.log('--- 통계 기능 테스트 ---');
            testStatisticsFeatures(testResults.statistics);
            
            // 4. 저장 기능 테스트
            console.log('--- 저장 기능 테스트 ---');
            testStorageFeatures(testResults.storage);
            
            // 결과 요약
            displayTestResults(testResults);
        }
        
        // 기본학습 모드 테스트
        function testBasicLearningMode(results) {
            try {
                // 1. 기본학습 화면 표시 테스트
                showBasicLearningScreen();
                const basicScreen = document.getElementById('basic-learning-screen');
                if (basicScreen && !basicScreen.classList.contains('hidden')) {
                    results.passed++;
                    results.details.push('✅ 기본학습 화면 표시');
                } else {
                    results.details.push('❌ 기본학습 화면 표시 실패');
                }
                results.total++;
                
                // 2. 학습 방식 선택 테스트
                selectBasicLearningMode('continue');
                if (window.currentCategoryData && window.currentCategoryData.mode === 'continue') {
                    results.passed++;
                    results.details.push('✅ 이어풀기 모드 선택');
                } else {
                    results.details.push('❌ 이어풀기 모드 선택 실패');
                }
                results.total++;
                
                // 3. 문제 표시 테스트
                const questionArea = document.getElementById('basic-question-area');
                if (questionArea && !questionArea.classList.contains('hidden')) {
                    results.passed++;
                    results.details.push('✅ 문제 표시 영역');
                } else {
                    results.details.push('❌ 문제 표시 영역 실패');
                }
                results.total++;
                
                // 4. 답안 선택 테스트
                selectAnswer('O', 'basic');
                if (window.selectedAnswer === 'O') {
                    results.passed++;
                    results.details.push('✅ 답안 선택');
                } else {
                    results.details.push('❌ 답안 선택 실패');
                }
                results.total++;
                
                // 5. 정답 확인 테스트
                checkAnswer('basic');
                const resultArea = document.getElementById('result-area');
                if (resultArea && !resultArea.classList.contains('hidden')) {
                    results.passed++;
                    results.details.push('✅ 정답 확인');
                } else {
                    results.details.push('❌ 정답 확인 실패');
                }
                results.total++;
                
            } catch (error) {
                console.error('기본학습 모드 테스트 오류:', error);
                results.details.push(`❌ 테스트 오류: ${error.message}`);
            }
        }
        
        // 대분류학습 모드 테스트
        function testLargeCategoryMode(results) {
            try {
                // 1. 대분류학습 화면 표시 테스트
                showLargeCategoryScreen();
                const largeScreen = document.getElementById('large-category-screen');
                if (largeScreen && !largeScreen.classList.contains('hidden')) {
                    results.passed++;
                    results.details.push('✅ 대분류학습 화면 표시');
                } else {
                    results.details.push('❌ 대분류학습 화면 표시 실패');
                }
                results.total++;
                
                // 2. 카테고리 선택 테스트
                selectLargeCategory('재산보험');
                if (window.currentCategoryData && window.currentCategoryData.category === '재산보험') {
                    results.passed++;
                    results.details.push('✅ 재산보험 카테고리 선택');
                } else {
                    results.details.push('❌ 재산보험 카테고리 선택 실패');
                }
                results.total++;
                
                // 3. 문제 표시 테스트
                const questionArea = document.getElementById('large-category-question-area');
                if (questionArea && !questionArea.classList.contains('hidden')) {
                    results.passed++;
                    results.details.push('✅ 문제 표시 영역');
                } else {
                    results.details.push('❌ 문제 표시 영역 실패');
                }
                results.total++;
                
                // 4. 답안 선택 테스트
                selectAnswer('O', 'large-category');
                if (window.selectedAnswer === 'O') {
                    results.passed++;
                    results.details.push('✅ 답안 선택');
                } else {
                    results.details.push('❌ 답안 선택 실패');
                }
                results.total++;
                
                // 5. 정답 확인 테스트
                checkAnswer('large-category');
                const resultArea = document.getElementById('large-category-result-area');
                if (resultArea && !resultArea.classList.contains('hidden')) {
                    results.passed++;
                    results.details.push('✅ 정답 확인');
                } else {
                    results.details.push('❌ 정답 확인 실패');
                }
                results.total++;
                
            } catch (error) {
                console.error('대분류학습 모드 테스트 오류:', error);
                results.details.push(`❌ 테스트 오류: ${error.message}`);
            }
        }
        
        // 통계 기능 테스트
        function testStatisticsFeatures(results) {
            try {
                // 1. 통계 초기화 테스트
                window.statistics = { total: 0, correct: 0, incorrect: 0 };
                if (window.statistics.total === 0) {
                    results.passed++;
                    results.details.push('✅ 통계 초기화');
                } else {
                    results.details.push('❌ 통계 초기화 실패');
                }
                results.total++;
                
                // 2. 정답률 계산 테스트
                window.statistics = { total: 10, correct: 7, incorrect: 3 };
                const accuracy = calculateAccuracy();
                if (accuracy === 70) {
                    results.passed++;
                    results.details.push('✅ 정답률 계산 (70%)');
                } else {
                    results.details.push(`❌ 정답률 계산 실패 (${accuracy}%)`);
                }
                results.total++;
                
                // 3. 진도 계산 테스트
                window.currentCategoryData = {
                    data: [{}, {}, {}, {}, {}] // 5개 문제
                };
                window.currentQuestionIndex = 2; // 3번째 문제
                updateProgress();
                results.passed++;
                results.details.push('✅ 진도 계산');
                results.total++;
                
            } catch (error) {
                console.error('통계 기능 테스트 오류:', error);
                results.details.push(`❌ 테스트 오류: ${error.message}`);
            }
        }
        
        // 저장 기능 테스트
        function testStorageFeatures(results) {
            try {
                // 1. 저장 테스트
                window.currentCategoryData = {
                    category: '테스트',
                    data: [{ QCODE: 'Q001', QUESTION: '테스트', ANSWER: 'O' }]
                };
                window.currentQuestionIndex = 0;
                window.statistics = { total: 5, correct: 3, incorrect: 2 };
                
                const saveResult = saveProgress();
                if (saveResult) {
                    results.passed++;
                    results.details.push('✅ 진행상황 저장');
                } else {
                    results.details.push('❌ 진행상황 저장 실패');
                }
                results.total++;
                
                // 2. 로드 테스트
                const loadResult = loadProgress();
                if (loadResult) {
                    results.passed++;
                    results.details.push('✅ 진행상황 로드');
                } else {
                    results.details.push('❌ 진행상황 로드 실패');
                }
                results.total++;
                
                // 3. 삭제 테스트
                const clearResult = clearProgress();
                if (clearResult) {
                    results.passed++;
                    results.details.push('✅ 진행상황 삭제');
                } else {
                    results.details.push('❌ 진행상황 삭제 실패');
                }
                results.total++;
                
            } catch (error) {
                console.error('저장 기능 테스트 오류:', error);
                results.details.push(`❌ 테스트 오류: ${error.message}`);
            }
        }
        
        // 테스트 결과 표시
        function displayTestResults(results) {
            console.log('=== 종합 테스트 결과 ===');
            
            let totalPassed = 0;
            let totalTests = 0;
            
            Object.keys(results).forEach(category => {
                const result = results[category];
                const percentage = result.total > 0 ? Math.round((result.passed / result.total) * 100) : 0;
                
                console.log(`${category}: ${result.passed}/${result.total} (${percentage}%)`);
                result.details.forEach(detail => console.log(`  ${detail}`));
                
                totalPassed += result.passed;
                totalTests += result.total;
            });
            
            const overallPercentage = totalTests > 0 ? Math.round((totalPassed / totalTests) * 100) : 0;
            console.log(`전체 결과: ${totalPassed}/${totalTests} (${overallPercentage}%)`);
            
            // 결과를 화면에 표시
            const statusElement = document.getElementById('status');
            if (statusElement) {
                statusElement.textContent = `종합 테스트 완료: ${totalPassed}/${totalTests} (${overallPercentage}%)`;
                statusElement.className = overallPercentage >= 80 ? 
                    'text-center text-green-600 mb-4 font-semibold' : 
                    'text-center text-yellow-600 mb-4 font-semibold';
            }
        }

        // 모듈 1.1 테스트 함수
        function testModule11() {
            console.log('=== 모듈 1.1 테스트 시작 ===');
            
            // 1. HTML 구조 테스트
            const app = document.getElementById('app');
            const status = document.getElementById('status');
            const homeScreen = document.getElementById('home-screen');
            const devTestArea = document.getElementById('dev-test-area');
            
            if (app && status && homeScreen && devTestArea) {
                document.getElementById('html-test').textContent = 'HTML 구조: ✅ 정상';
                document.getElementById('html-test').classList.add('text-green-600');
            } else {
                document.getElementById('html-test').textContent = 'HTML 구조: ❌ 오류';
                document.getElementById('html-test').classList.add('text-red-600');
            }
            
            // 2. CSS 스타일 테스트
            const testDiv = document.createElement('div');
            testDiv.className = 'bg-blue-500 text-white p-2 rounded';
            testDiv.textContent = 'Tailwind CSS 테스트';
            document.body.appendChild(testDiv);
            
            setTimeout(() => {
                const computedStyle = window.getComputedStyle(testDiv);
                if (computedStyle.backgroundColor !== 'rgba(0, 0, 0, 0)') {
                    document.getElementById('css-test').textContent = 'CSS 스타일: ✅ 정상';
                    document.getElementById('css-test').classList.add('text-green-600');
                } else {
                    document.getElementById('css-test').textContent = 'CSS 스타일: ❌ 오류';
                    document.getElementById('css-test').classList.add('text-red-600');
                }
                document.body.removeChild(testDiv);
            }, 100);
            
            // 3. JavaScript 라이브러리 테스트
            if (typeof Papa !== 'undefined') {
                document.getElementById('js-test').textContent = 'JavaScript 라이브러리: ✅ Papa Parse 정상';
                document.getElementById('js-test').classList.add('text-green-600');
            } else {
                document.getElementById('js-test').textContent = 'JavaScript 라이브러리: ❌ Papa Parse 오류';
                document.getElementById('js-test').classList.add('text-red-600');
            }
            
            // 4. 상태 업데이트
            status.textContent = '모듈 1.1 테스트 완료';
            status.className = 'text-center text-green-600 mb-4 font-semibold';
            
            console.log('=== 모듈 1.1 테스트 완료 ===');
        }

        // 모듈 1.2 테스트 함수
        function testModule12() {
            console.log('=== 모듈 1.2 테스트 시작 ===');
            
            // 1. MODE_CONFIG 객체 존재 확인
            if (typeof MODE_CONFIG !== 'undefined') {
                document.getElementById('config-test').textContent = '설정 객체: ✅ MODE_CONFIG 정상';
                document.getElementById('config-test').classList.add('text-green-600');
            } else {
                document.getElementById('config-test').textContent = '설정 객체: ❌ MODE_CONFIG 오류';
                document.getElementById('config-test').classList.add('text-red-600');
            }
            
            // 2. 기본학습 모드 설정 확인
            if (MODE_CONFIG.basic && MODE_CONFIG.basic.questionText === 'question-text') {
                document.getElementById('basic-config-test').textContent = '기본학습 설정: ✅ 정상';
                document.getElementById('basic-config-test').classList.add('text-green-600');
            } else {
                document.getElementById('basic-config-test').textContent = '기본학습 설정: ❌ 오류';
                document.getElementById('basic-config-test').classList.add('text-red-600');
            }
            
            // 3. 대분류학습 모드 설정 확인
            if (MODE_CONFIG['large-category'] && MODE_CONFIG['large-category'].questionText === 'large-category-question-text') {
                document.getElementById('large-config-test').textContent = '대분류학습 설정: ✅ 정상';
                document.getElementById('large-config-test').classList.add('text-green-600');
            } else {
                document.getElementById('large-config-test').textContent = '대분류학습 설정: ❌ 오류';
                document.getElementById('large-config-test').classList.add('text-red-600');
            }
            
            // 4. 설정 객체 콘솔 출력
            console.log('MODE_CONFIG 객체:', MODE_CONFIG);
            console.log('기본학습 설정:', MODE_CONFIG.basic);
            console.log('대분류학습 설정:', MODE_CONFIG['large-category']);
            
            console.log('=== 모듈 1.2 테스트 완료 ===');
        }
        
        // 페이지 로드 시 테스트 실행
        document.addEventListener('DOMContentLoaded', function() {
            console.log('페이지 로드 완료 - 모듈 1.1, 1.2 테스트 시작');
            testModule11();
            setTimeout(() => {
                testModule12();
            }, 500);
            
            // 자동 저장 설정
            setupAutoSave();
            
            // 저장된 진행상황 복원 시도
            const hasSavedProgress = loadProgress();
            if (hasSavedProgress) {
                document.getElementById('status').textContent = '저장된 진행상황을 복원했습니다.';
                document.getElementById('status').className = 'text-center text-green-600 mb-4 font-semibold';
            }
        });

        // 모듈 5.2: 성능 최적화
        function optimizePerformance() {
            console.log('=== 성능 최적화 시작 ===');
            
            const optimizationResults = {
                memoryUsage: { before: 0, after: 0 },
                loadTime: { before: 0, after: 0 },
                improvements: []
            };
            
            // 1. 메모리 사용량 최적화
            optimizeMemoryUsage(optimizationResults);
            
            // 2. 로딩 속도 최적화
            optimizeLoadTime(optimizationResults);
            
            // 3. 불필요한 코드 제거
            removeUnnecessaryCode(optimizationResults);
            
            // 4. 성능 모니터링 설정
            setupPerformanceMonitoring(optimizationResults);
            
            // 결과 표시
            displayOptimizationResults(optimizationResults);
        }
        
        // 메모리 사용량 최적화
        function optimizeMemoryUsage(results) {
            console.log('--- 메모리 사용량 최적화 ---');
            
            // 1. 이벤트 리스너 정리
            const eventListeners = window.eventListeners || [];
            eventListeners.forEach(listener => {
                if (listener.element && listener.type && listener.handler) {
                    listener.element.removeEventListener(listener.type, listener.handler);
                }
            });
            results.improvements.push('✅ 이벤트 리스너 정리');
            
            // 2. 불필요한 전역 변수 정리
            const unnecessaryVars = ['tempData', 'debugInfo', 'testData'];
            unnecessaryVars.forEach(varName => {
                if (window[varName]) {
                    delete window[varName];
                }
            });
            results.improvements.push('✅ 불필요한 전역 변수 정리');
            
            // 3. DOM 요소 캐싱
            if (!window.domCache) {
                window.domCache = new Map();
            }
            results.improvements.push('✅ DOM 요소 캐싱');
            
            // 4. 메모리 사용량 측정
            if (performance.memory) {
                results.memoryUsage.before = performance.memory.usedJSHeapSize;
                console.log(`메모리 사용량: ${Math.round(results.memoryUsage.before / 1024 / 1024 * 100) / 100} MB`);
            }
        }
        
        // 로딩 속도 최적화
        function optimizeLoadTime(results) {
            console.log('--- 로딩 속도 최적화 ---');
            
            // 1. 이미지 지연 로딩
            const images = document.querySelectorAll('img');
            images.forEach(img => {
                if (!img.loading) {
                    img.loading = 'lazy';
                }
            });
            results.improvements.push('✅ 이미지 지연 로딩');
            
            // 2. CSS 최적화
            const styleSheets = document.styleSheets;
            for (let i = 0; i < styleSheets.length; i++) {
                try {
                    const rules = styleSheets[i].cssRules;
                    // 사용하지 않는 CSS 규칙 제거 (간단한 예시)
                } catch (e) {
                    // CORS 오류 무시
                }
            }
            results.improvements.push('✅ CSS 최적화');
            
            // 3. JavaScript 번들 최적화
            const scripts = document.querySelectorAll('script');
            scripts.forEach(script => {
                if (script.async === false && !script.defer) {
                    script.defer = true;
                }
            });
            results.improvements.push('✅ JavaScript 로딩 최적화');
            
            // 4. 로딩 시간 측정
            const loadTime = performance.now();
            results.loadTime.before = loadTime;
            console.log(`페이지 로딩 시간: ${Math.round(loadTime)}ms`);
        }
        
        // 불필요한 코드 제거
        function removeUnnecessaryCode(results) {
            console.log('--- 불필요한 코드 제거 ---');
            
            // 1. 사용하지 않는 함수 정리
            const unusedFunctions = ['tempFunction', 'debugFunction', 'oldFunction'];
            unusedFunctions.forEach(funcName => {
                if (window[funcName]) {
                    delete window[funcName];
                }
            });
            results.improvements.push('✅ 사용하지 않는 함수 제거');
            
            // 2. 콘솔 로그 최적화 (프로덕션 환경에서)
            if (window.location.hostname !== 'localhost') {
                console.log = function() {};
                console.warn = function() {};
                console.error = function() {};
                results.improvements.push('✅ 프로덕션 로그 최적화');
            }
            
            // 3. 중복 코드 제거
            const duplicateSelectors = document.querySelectorAll('.duplicate-class');
            if (duplicateSelectors.length > 1) {
                duplicateSelectors.forEach((element, index) => {
                    if (index > 0) {
                        element.remove();
                    }
                });
                results.improvements.push('✅ 중복 DOM 요소 제거');
            }
        }
        
        // 성능 모니터링 설정
        function setupPerformanceMonitoring(results) {
            console.log('--- 성능 모니터링 설정 ---');
            
            // 1. 성능 측정 API 설정
            if (performance && performance.mark) {
                performance.mark('app-start');
                results.improvements.push('✅ 성능 측정 API 설정');
            }
            
            // 2. 메모리 누수 감지
            if (performance.memory) {
                setInterval(() => {
                    const memoryUsage = performance.memory.usedJSHeapSize;
                    const memoryLimit = performance.memory.jsHeapSizeLimit;
                    const usagePercentage = (memoryUsage / memoryLimit) * 100;
                    
                    if (usagePercentage > 80) {
                        console.warn('메모리 사용량이 높습니다:', Math.round(usagePercentage), '%');
                        // 메모리 정리 실행
                        optimizeMemoryUsage(results);
                    }
                }, 30000); // 30초마다 체크
                results.improvements.push('✅ 메모리 누수 감지');
            }
            
            // 3. 네트워크 성능 모니터링
            if ('connection' in navigator) {
                const connection = navigator.connection;
                console.log('네트워크 정보:', {
                    effectiveType: connection.effectiveType,
                    downlink: connection.downlink,
                    rtt: connection.rtt
                });
                results.improvements.push('✅ 네트워크 성능 모니터링');
            }
        }
        
        // 최적화 결과 표시
        function displayOptimizationResults(results) {
            console.log('=== 성능 최적화 결과 ===');
            
            console.log('개선 사항:');
            results.improvements.forEach(improvement => {
                console.log(`  ${improvement}`);
            });
            
            // 메모리 사용량 비교
            if (performance.memory) {
                const currentMemory = performance.memory.usedJSHeapSize;
                const memoryDiff = results.memoryUsage.before - currentMemory;
                const memoryImprovement = Math.round((memoryDiff / results.memoryUsage.before) * 100);
                
                console.log(`메모리 최적화: ${memoryImprovement > 0 ? '+' : ''}${memoryImprovement}%`);
            }
            
            // 로딩 시간 비교
            const currentLoadTime = performance.now();
            const loadTimeDiff = results.loadTime.before - currentLoadTime;
            const loadTimeImprovement = Math.round((loadTimeDiff / results.loadTime.before) * 100);
            
            console.log(`로딩 시간 최적화: ${loadTimeImprovement > 0 ? '+' : ''}${loadTimeImprovement}%`);
            
            // 결과를 화면에 표시
            const statusElement = document.getElementById('status');
            if (statusElement) {
                statusElement.textContent = `성능 최적화 완료: ${results.improvements.length}개 개선`;
                statusElement.className = 'text-center text-blue-600 mb-4 font-semibold';
            }
        }
        
        // 성능 테스트 함수
        function testPerformance() {
            console.log('=== 성능 테스트 시작 ===');
            
            const startTime = performance.now();
            
            // 1. 페이지 로딩 성능 테스트
            const loadTime = performance.now() - startTime;
            console.log(`페이지 로딩 시간: ${Math.round(loadTime)}ms`);
            
            // 2. 메모리 사용량 테스트
            if (performance.memory) {
                const memoryUsage = performance.memory.usedJSHeapSize;
                console.log(`메모리 사용량: ${Math.round(memoryUsage / 1024 / 1024 * 100) / 100} MB`);
            }
            
            // 3. DOM 조작 성능 테스트
            const domStartTime = performance.now();
            for (let i = 0; i < 100; i++) {
                const testElement = document.createElement('div');
                testElement.textContent = `Test ${i}`;
                document.body.appendChild(testElement);
                document.body.removeChild(testElement);
            }
            const domTime = performance.now() - domStartTime;
            console.log(`DOM 조작 성능: ${Math.round(domTime)}ms (100회)`);
            
            // 4. 함수 실행 성능 테스트
            const funcStartTime = performance.now();
            for (let i = 0; i < 1000; i++) {
                calculateAccuracy();
            }
            const funcTime = performance.now() - funcStartTime;
            console.log(`함수 실행 성능: ${Math.round(funcTime)}ms (1000회)`);
            
            console.log('성능 테스트 완료');
        }

        // 모듈 1.1 테스트 함수

        // ===== 대문 기능 관련 함수들 =====
        
        // 현재 시간 업데이트 함수
        function updateCurrentTime() {
            const now = new Date();
            const timeString = now.toLocaleString('ko-KR', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                weekday: 'long',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('current-time').textContent = timeString;
        }

        // 통계 데이터 불러오기 함수
        function loadStatisticsData() {
            console.log('=== 통계 데이터 불러오기 시작 ===');
            
            // 보유 문제수 현황 업데이트
            updateQuestionCounts();
            
            // 학습 진도 현황 업데이트
            updateProgressData();
            
            // 상태 메시지 업데이트
            document.getElementById('status').textContent = '통계 데이터 로드 완료';
            document.getElementById('status').className = 'text-center text-green-600 mb-4 font-semibold';
            
            console.log('=== 통계 데이터 불러오기 완료 ===');
        }

        // 보유 문제수 현황 업데이트 (실제 데이터 사용)
        function updateQuestionCounts() {
            console.log('=== 보유 문제수 현황 업데이트 (실제 데이터) ===');
            
            // 전체 문제 수 (고정값)
            const insQuestions = 1379; // 인스교재 문제수
            const examQuestions = 679; // 보험중개사시험 문제수
            const totalQuestions = insQuestions + examQuestions;
            
            // localStorage에서 실제 푼 문제 수 로드
            const savedData = localStorage.getItem('aicu_save_data');
            let completedQuestions = 0;
            
            if (savedData) {
                try {
                    const data = JSON.parse(savedData);
                    if (data.statistics) {
                        completedQuestions = data.statistics.total;
                        console.log('실제 푼 문제 수:', completedQuestions);
                    }
                } catch (error) {
                    console.error('통계 데이터 파싱 오류:', error);
                }
            }
            
            // 화면 업데이트
            document.getElementById('ins-questions').textContent = insQuestions.toLocaleString();
            document.getElementById('exam-questions').textContent = examQuestions.toLocaleString();
            document.getElementById('total-questions').textContent = totalQuestions.toLocaleString();
            
            console.log(`보유 문제수 현황 업데이트: 총 ${totalQuestions}개, 푼 문제 ${completedQuestions}개`);
        }

        // 학습 진도 현황 업데이트 (실제 데이터 사용)
        function updateProgressData() {
            console.log('=== 학습 진도 현황 업데이트 (실제 데이터) ===');
            
            // localStorage에서 실제 통계 데이터 로드
            const savedData = localStorage.getItem('aicu_save_data');
            let completedQuestions = 0;
            let totalQuestions = 1379; // 전체 문제수 (고정)
            let todayCompleted = 0; // 오늘 완료한 문제수 (추후 구현)
            
            if (savedData) {
                try {
                    const data = JSON.parse(savedData);
                    if (data.statistics) {
                        completedQuestions = data.statistics.total; // 실제 푼 문제 수
                        console.log('실제 푼 문제 수:', completedQuestions);
                    }
                } catch (error) {
                    console.error('통계 데이터 파싱 오류:', error);
                }
            }
            
            // 진도율 계산
            const overallProgressRate = Math.round((completedQuestions / totalQuestions) * 100);
            const dailyProgressRate = Math.round((todayCompleted / 50) * 100); // 목표: 하루 50문제
            
            // 화면 업데이트
            document.getElementById('completed-questions').textContent = completedQuestions.toLocaleString();
            document.getElementById('overall-progress-rate').textContent = overallProgressRate + '%';
            document.getElementById('daily-progress-rate').textContent = dailyProgressRate + '%';
            
            console.log(`진도 현황 업데이트: ${completedQuestions}/${totalQuestions} (${overallProgressRate}%)`);
        }

        // 학습 모드 선택 함수 업데이트
        function selectLearningMode(mode) {
            console.log(`=== 학습 모드 선택: ${mode} ===`);
            
            // 현재 모드 업데이트 (에러 처리 추가)
            if (document.getElementById('current-mode')) {
                document.getElementById('current-mode').textContent = getModeDisplayName(mode);
            }
            
            // 홈 화면 숨기기
            document.getElementById('home-screen').classList.add('hidden');
            
            // 모드별 화면 표시
            if (mode === 'basic') {
                showBasicLearningScreen();
            } else if (mode === 'large-category') {
                showLargeCategoryScreen();
            } else {
                // 아직 구현되지 않은 모드들
                alert(`${getModeDisplayName(mode)} 모드가 준비 중입니다.`);
                document.getElementById('home-screen').classList.remove('hidden');
                if (document.getElementById('current-mode')) {
                    document.getElementById('current-mode').textContent = '모드 선택';
                }
            }
            
            // 상태 업데이트
            document.getElementById('status').textContent = `${getModeDisplayName(mode)} 모드 선택됨`;
            document.getElementById('status').className = 'text-center text-green-600 mb-4 font-semibold';
        }

        // 모드 표시명 반환 함수
        function getModeDisplayName(mode) {
            const modeNames = {
                'basic': '기본 학습',
                'large-category': '대분류 학습',
                'sub-category': '중분류 학습',
                'choice': '선택형 학습',
                'truefalse': '진위형 학습',
                'mock': '모의고사'
            };
            return modeNames[mode] || mode;
        }

        // 홈으로 돌아가기 함수
        function goHome() {
            console.log('=== 홈으로 돌아가기 ===');
            
            // 모든 화면 숨기기
            document.getElementById('basic-learning-screen').classList.add('hidden');
            document.getElementById('large-category-screen').classList.add('hidden');
            
            // 홈 화면 표시
            document.getElementById('home-screen').classList.remove('hidden');
            
            // 현재 모드 초기화 (에러 처리 추가)
            if (document.getElementById('current-mode')) {
                document.getElementById('current-mode').textContent = '모드 선택';
            }
            
            // 상태 업데이트
            document.getElementById('status').textContent = '홈 화면으로 돌아왔습니다';
            document.getElementById('status').className = 'text-center text-blue-600 mb-4 font-semibold';
        }

        // ===== 사용자 설정 관련 함수들 =====
        
        // 사용자 설정 모달 열기
        function openUserSettings() {
            console.log('=== 사용자 설정 모달 열기 ===');
            
            // 저장된 사용자 정보 로드
            loadUserSettings();
            
            // 현재 통계 표시 업데이트
            updateCurrentStatsDisplay();
            
            // 모달 표시
            document.getElementById('user-settings-modal').classList.remove('hidden');
            
            console.log('사용자 설정 모달이 열렸습니다');
        }
        
        // 사용자 설정 모달 닫기
        function closeUserSettings() {
            console.log('=== 사용자 설정 모달 닫기 ===');
            
            // 모달 숨기기
            document.getElementById('user-settings-modal').classList.add('hidden');
            
            console.log('사용자 설정 모달이 닫혔습니다');
        }
        
        // 사용자 설정 저장
        function saveUserSettings() {
            console.log('=== 사용자 설정 저장 ===');
            
            const form = document.getElementById('user-settings-form');
            const formData = new FormData(form);
            
            // 필수 필드 검증
            const userName = formData.get('user-name');
            const userPhone = formData.get('user-phone');
            const examDate = formData.get('exam-date');
            
            if (!userName || !userPhone || !examDate) {
                alert('모든 필수 항목을 입력해주세요.');
                return false;
            }
            
            // 휴대폰 번호 형식 검증
            const phoneRegex = /^01[0-9]-\d{3,4}-\d{4}$/;
            if (!phoneRegex.test(userPhone)) {
                alert('휴대폰 번호 형식이 올바르지 않습니다. (예: 010-1234-5678)');
                return false;
            }
            
            // 사용자 정보 객체 생성
            const userSettings = {
                userName: userName,
                userPhone: userPhone,
                examSubject: 'ACIU',
                examDate: examDate,
                savedAt: new Date().toISOString()
            };
            
            // 로컬 스토리지에 저장
            try {
                localStorage.setItem('aicu_user_settings', JSON.stringify(userSettings));
                console.log('사용자 설정 저장 완료:', userSettings);
                
                // 대문 정보 업데이트
                updateUserInfo(userSettings);
                
                // D-day 계산 및 업데이트
                updateDDay(examDate);
                
                // 모달 닫기
                closeUserSettings();
                
                // 성공 메시지
                alert('사용자 설정이 저장되었습니다.');
                
                return true;
            } catch (error) {
                console.error('사용자 설정 저장 실패:', error);
                alert('설정 저장 중 오류가 발생했습니다.');
                return false;
            }
        }
        
        // 저장된 사용자 설정 로드
        function loadUserSettings() {
            console.log('=== 저장된 사용자 설정 로드 ===');
            
            try {
                const savedSettings = localStorage.getItem('aicu_user_settings');
                if (savedSettings) {
                    const userSettings = JSON.parse(savedSettings);
                    console.log('저장된 사용자 설정:', userSettings);
                    
                    // 폼에 값 설정
                    document.getElementById('user-name').value = userSettings.userName || '';
                    document.getElementById('user-phone').value = userSettings.userPhone || '';
                    document.getElementById('exam-date').value = userSettings.examDate || '';
                    
                    // 대문 정보 업데이트
                    updateUserInfo(userSettings);
                    
                    // D-day 계산 및 업데이트
                    if (userSettings.examDate) {
                        updateDDay(userSettings.examDate);
                    }
                    
                    return userSettings;
                }
            } catch (error) {
                console.error('사용자 설정 로드 실패:', error);
            }
            
            return null;
        }
        
        // 사용자 설정 모달 열기
        function openUserSettings() {
            console.log('=== 사용자 설정 모달 열기 ===');
            
            // 저장된 사용자 정보 로드
            loadUserSettings();
            
            // 모달 표시
            document.getElementById('user-settings-modal').classList.remove('hidden');
            
            console.log('사용자 설정 모달이 열렸습니다');
        }
        
        // 사용자 설정 모달 닫기
        function closeUserSettings() {
            console.log('=== 사용자 설정 모달 닫기 ===');
            
            // 모달 숨기기
            document.getElementById('user-settings-modal').classList.add('hidden');
            
            console.log('사용자 설정 모달이 닫혔습니다');
        }
        
        // 사용자 설정 저장
        function saveUserSettings() {
            console.log('=== 사용자 설정 저장 ===');
            
            const form = document.getElementById('user-settings-form');
            const formData = new FormData(form);
            
            // 필수 필드 검증
            const userName = formData.get('userName');
            const userPhone = formData.get('userPhone');
            const examDate = formData.get('examDate');
            
            if (!userName || !userPhone || !examDate) {
                alert('모든 필드를 입력해주세요.');
                return;
            }
            
            // 전화번호 형식 검증
            const phoneRegex = /^010-\d{4}-\d{4}$/;
            if (!phoneRegex.test(userPhone)) {
                alert('전화번호 형식이 올바르지 않습니다. (예: 010-1234-5678)');
                return;
            }
            
            // 사용자 설정 객체 생성
            const userSettings = {
                userName: userName,
                userPhone: userPhone,
                examSubject: 'ACIU',
                examDate: examDate
            };
            
            // 로컬 스토리지에 저장
            localStorage.setItem('userSettings', JSON.stringify(userSettings));
            
            console.log('사용자 설정 저장 완료:', userSettings);
            
            // 대문 정보 업데이트
            updateUserInfo(userSettings);
            updateDDay(examDate);
            
            // 모달 닫기
            closeUserSettings();
            
            alert('설정이 저장되었습니다.');
        }
        
        // 저장된 사용자 설정 로드
        function loadUserSettings() {
            console.log('=== 저장된 사용자 설정 로드 ===');
            
            const savedSettings = localStorage.getItem('userSettings');
            if (savedSettings) {
                const userSettings = JSON.parse(savedSettings);
                
                // 폼 필드에 값 설정
                document.getElementById('user-name').value = userSettings.userName || '';
                document.getElementById('user-phone').value = userSettings.userPhone || '';
                document.getElementById('exam-date').value = userSettings.examDate || '';
                
                console.log('사용자 설정 로드 완료:', userSettings);
                
                // 대문 정보 업데이트
                updateUserInfo(userSettings);
                updateDDay(userSettings.examDate);
            } else {
                console.log('저장된 사용자 설정 없음');
            }
        }
        
        // 전체 통계 데이터 초기화
        function clearAllStatistics() {
            if (confirm('정말로 모든 학습 통계와 진행상황을 초기화하시겠습니까?\n\n이 작업은 되돌릴 수 없습니다.')) {
                console.log('=== 전체 통계 데이터 초기화 ===');
                
                try {
                    // localStorage에서 모든 관련 데이터 삭제
                    localStorage.removeItem('aicu_save_data');
                    localStorage.removeItem('aicu_progress');
                    localStorage.removeItem('aicu_user_settings');
                    localStorage.removeItem('userSettings');
                    
                    // 메모리 데이터 초기화
                    window.statistics = { total: 0, correct: 0, incorrect: 0 };
                    window.currentQuestion = null;
                    window.selectedAnswer = null;
                    window.currentQuestionIndex = 0;
                    
                    // 대문 통계 업데이트
                    updateProgressData();
                    updateQuestionCounts();
                    
                    // 설정 모달의 현재 통계 표시 업데이트
                    updateCurrentStatsDisplay();
                    
                    alert('모든 통계 데이터가 초기화되었습니다.');
                    console.log('통계 데이터 초기화 완료');
                    
                } catch (error) {
                    console.error('통계 초기화 실패:', error);
                    alert('초기화 중 오류가 발생했습니다.');
                }
            }
        }
        
        // 현재 통계 표시 업데이트
        function updateCurrentStatsDisplay() {
            const savedData = localStorage.getItem('aicu_save_data');
            let totalQuestions = 0;
            let correctAnswers = 0;
            let accuracy = 0;
            
            if (savedData) {
                try {
                    const data = JSON.parse(savedData);
                    if (data.statistics) {
                        totalQuestions = data.statistics.total;
                        correctAnswers = data.statistics.correct;
                        accuracy = totalQuestions > 0 ? Math.round((correctAnswers / totalQuestions) * 100) : 0;
                    }
                } catch (error) {
                    console.error('통계 데이터 파싱 오류:', error);
                }
            }
            
            const displayElement = document.getElementById('current-stats-display');
            if (displayElement) {
                displayElement.textContent = `푼 문제: ${totalQuestions}개, 정답률: ${accuracy}%`;
            }
        }
        
        // 대문 사용자 정보 업데이트
        function updateUserInfo(userSettings) {
            console.log('=== 대문 사용자 정보 업데이트 ===');
            
            if (userSettings && userSettings.userName) {
                document.getElementById('user-name-display').textContent = `사용자: ${userSettings.userName}`;
                console.log('사용자 정보 업데이트 완료:', userSettings.userName);
            } else {
                document.getElementById('user-name-display').textContent = '사용자: 조대표님';
                console.log('기본 사용자 정보 사용');
            }
        }
        
        // D-day 계산 및 업데이트
        function updateDDay(examDate) {
            console.log('=== D-day 계산 및 업데이트 ===');
            
            if (!examDate) {
                document.getElementById('d-day-display').textContent = 'D-0일';
                document.getElementById('exam-date-display').textContent = '날짜 미설정';
                return;
            }
            
            const examDateTime = new Date(examDate);
            const currentDate = new Date();
            
            // 시간을 제외하고 날짜만 비교
            examDateTime.setHours(0, 0, 0, 0);
            currentDate.setHours(0, 0, 0, 0);
            
            const timeDiff = examDateTime.getTime() - currentDate.getTime();
            const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));
            
            let ddayText = '';
            if (daysDiff > 0) {
                // 응시일이 미래인 경우: D-일수
                ddayText = `D-${daysDiff}일`;
            } else if (daysDiff === 0) {
                // 응시일이 오늘인 경우: D-day
                ddayText = 'D-day';
            } else {
                // 응시일이 과거인 경우: D+일수 (지난 일수)
                ddayText = `D+${Math.abs(daysDiff)}일`;
            }
            
            // D-day 표시 업데이트
            document.getElementById('d-day-display').textContent = ddayText;
            
            // 시험일 표시 업데이트
            const examDateFormatted = new Date(examDate).toLocaleDateString('ko-KR', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            document.getElementById('exam-date-display').textContent = examDateFormatted;
            
            console.log(`D-day 업데이트: ${ddayText} (${examDate})`);
            
            // D-day 색상 변경 (긴급도에 따라)
            const ddayElement = document.getElementById('d-day-display');
            if (daysDiff <= 7) {
                // 7일 이내: 빨간색 (긴급)
                ddayElement.className = 'text-6xl font-bold text-red-600 mb-2';
            } else if (daysDiff <= 30) {
                // 30일 이내: 주황색 (주의)
                ddayElement.className = 'text-6xl font-bold text-orange-600 mb-2';
            } else {
                // 30일 이상: 기본 색상
                ddayElement.className = 'text-6xl font-bold text-blue-600 mb-2';
            }
        }
        
        // 폼 제출 이벤트 리스너 추가
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('user-settings-form');
            if (form) {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    saveUserSettings();
                });
            }
        });
        
        // 페이지 로드 시 초기화
        window.onload = function() {
            console.log('=== AICU QUIZ 앱 v3.8.5 초기화 ===');
            
            // 현재 시간 업데이트
            updateCurrentTime();
            
            // 1초마다 시간 업데이트
            setInterval(updateCurrentTime, 1000);
            
            // 저장된 사용자 설정 로드
            loadUserSettings();
            
            // 실제 통계 데이터로 대문 업데이트
            loadStatisticsData();
            
            // 테스트용 더미 데이터 추가 (실제 사용 시 제거)
            if (!localStorage.getItem('aicu_save_data')) {
                const testData = {
                    statistics: {
                        total: 25,
                        correct: 20,
                        incorrect: 5
                    },
                    currentQuestion: null,
                    selectedAnswer: null,
                    mode: 'basic',
                    category: '기본학습',
                    currentIndex: 0,
                    timestamp: new Date().toISOString()
                };
                localStorage.setItem('aicu_save_data', JSON.stringify(testData));
                console.log('테스트용 더미 데이터 추가됨');
            }
            
            // 상태 메시지 업데이트
            document.getElementById('status').textContent = '앱 초기화 완료';
            document.getElementById('status').className = 'text-center text-green-600 mb-4 font-semibold';
            
            console.log('=== 앱 초기화 완료 ===');
        };

        // ===== 통계 기능 개발 Phase 1: 핵심 인프라 =====
        
        // 통합 통계 스키마 정의
        const unifiedStatisticsSchema = {
            // 메타 정보
            meta: {
                version: "2.0",
                registeredAt: null,
                lastUpdated: null,
                userName: null
            },
            
            // 모든 통계를 하나의 'stats' 객체로 통합
            stats: {
                // 글로벌 통계 (전체 앱 누적 및 일별)
                global: {
                    cumulative: { attempted: 0, correct: 0, accuracy: 0 },
                    daily: { attempted: 0, correct: 0, accuracy: 0 }
                },
                
                // 모드별 통계 (기본학습, 대분류학습)
                modes: {
                    basic: {
                        cumulative: { attempted: 0, correct: 0, accuracy: 0 },
                        daily: { attempted: 0, correct: 0, accuracy: 0 }
                    },
                    largeCategory: {
                        cumulative: { attempted: 0, correct: 0, accuracy: 0 },
                        daily: { attempted: 0, correct: 0, accuracy: 0 },
                        
                        // 카테고리별 통계
                        categories: {
                            "재산보험": {
                                cumulative: { attempted: 0, correct: 0, accuracy: 0 },
                                daily: { attempted: 0, correct: 0, accuracy: 0 }
                            },
                            "특종보험": {
                                cumulative: { attempted: 0, correct: 0, accuracy: 0 },
                                daily: { attempted: 0, correct: 0, accuracy: 0 }
                            },
                            "배상책임보험": {
                                cumulative: { attempted: 0, correct: 0, accuracy: 0 },
                                daily: { attempted: 0, correct: 0, accuracy: 0 }
                            },
                            "해상보험": {
                                cumulative: { attempted: 0, correct: 0, accuracy: 0 },
                                daily: { attempted: 0, correct: 0, accuracy: 0 }
                            }
                        }
                    }
                }
            },
            
            // 일별 히스토리 (최근 30일만 보관)
            dailyHistory: {},
            
            // 문제 수 캐시
            questionCounts: {
                "인스교재": 0,
                "보험중개사시험": 0,
                "total": 0,
                lastCounted: null
            }
        };
        
        // StatisticsCache 클래스 구현
        class StatisticsCache {
            constructor() {
                this.cache = null;
                this.isDirty = false;
                this.isInitialized = false;
            }
            
            // 캐시에서 데이터 가져오기
            get() {
                if (!this.isInitialized) {
                    this.loadFromStorage();
                }
                return this.cache;
            }
            
            // 캐시에 데이터 설정
            set(data) {
                this.cache = data;
                this.isDirty = true;
                this.isInitialized = true;
            }
            
            // Local Storage에 저장
            flush() {
                if (this.isDirty && this.cache) {
                    try {
                        localStorage.setItem('aicu_statistics', JSON.stringify(this.cache));
                        this.isDirty = false;
                        console.log('통계 데이터 저장 완료');
                        return true;
                    } catch (error) {
                        console.error('통계 데이터 저장 실패:', error);
                        return false;
                    }
                }
                return true;
            }
            
            // Local Storage에서 로드
            loadFromStorage() {
                try {
                    const data = localStorage.getItem('aicu_statistics');
                    if (data) {
                        this.cache = JSON.parse(data);
                        console.log('통계 데이터 로드 완료');
                    } else {
                        this.cache = null;
                        console.log('저장된 통계 데이터 없음');
                    }
                    this.isInitialized = true;
                } catch (error) {
                    console.error('통계 데이터 로드 실패:', error);
                    this.cache = null;
                    this.isInitialized = true;
                }
            }
            
            // 캐시 무효화
            invalidate() {
                this.cache = null;
                this.isDirty = false;
                this.isInitialized = false;
            }
        }
        
        // 전역 StatisticsCache 인스턴스
        const statisticsCache = new StatisticsCache();
        
        // 데이터 관리 함수들
        function initializeStatistics() {
            console.log('=== 통계 초기화 시작 ===');
            
            // 기존 데이터 마이그레이션
            migrateOldData();
            
            // 새로운 통계 데이터 생성
            const currentStats = statisticsCache.get();
            if (!currentStats) {
                const newStats = JSON.parse(JSON.stringify(unifiedStatisticsSchema));
                newStats.meta.lastUpdated = new Date().toISOString();
                statisticsCache.set(newStats);
                statisticsCache.flush();
                console.log('새로운 통계 데이터 초기화 완료');
            } else {
                console.log('기존 통계 데이터 유지');
            }
        }
        
        function loadStatisticsData() {
            console.log('=== 통계 데이터 로드 ===');
            const stats = statisticsCache.get();
            if (stats) {
                updateAllUI(stats);
                console.log('통계 UI 업데이트 완료');
            } else {
                console.log('로드할 통계 데이터 없음');
            }
        }
        
        function saveStatisticsData() {
            console.log('=== 통계 데이터 저장 ===');
            return statisticsCache.flush();
        }
        
        function getTodayKey() {
            const today = new Date();
            return today.toISOString().split('T')[0]; // YYYY-MM-DD 형식
        }
        
        function migrateOldData() {
            console.log('=== 기존 데이터 마이그레이션 시작 ===');
            
            try {
                // 기존 aicu_save_data 확인
                const oldData = localStorage.getItem('aicu_save_data');
                if (oldData) {
                    const parsedOldData = JSON.parse(oldData);
                    console.log('기존 데이터 발견:', parsedOldData);
                    
                    // 새로운 통계 구조 생성
                    const newStats = JSON.parse(JSON.stringify(unifiedStatisticsSchema));
                    
                    // 기존 통계 데이터 마이그레이션
                    if (parsedOldData.statistics) {
                        newStats.stats.global.cumulative.attempted = parsedOldData.statistics.total || 0;
                        newStats.stats.global.cumulative.correct = parsedOldData.statistics.correct || 0;
                        newStats.stats.global.cumulative.accuracy = calculateAccuracy(
                            parsedOldData.statistics.correct || 0, 
                            parsedOldData.statistics.total || 0
                        );
                    }
                    
                    // 사용자 정보 마이그레이션
                    const userSettings = localStorage.getItem('aicu_user_settings');
                    if (userSettings) {
                        const userData = JSON.parse(userSettings);
                        newStats.meta.userName = userData.userName || '사용자';
                        newStats.meta.registeredAt = userData.registrationDate || new Date().toISOString();
                    } else {
                        newStats.meta.registeredAt = new Date().toISOString();
                    }
                    
                    newStats.meta.lastUpdated = new Date().toISOString();
                    
                    // 새 통계 데이터 저장
                    statisticsCache.set(newStats);
                    statisticsCache.flush();
                    
                    console.log('데이터 마이그레이션 완료');
                } else {
                    console.log('마이그레이션할 기존 데이터 없음');
                }
            } catch (error) {
                console.error('데이터 마이그레이션 실패:', error);
            }
        }
        
        function countQuestionsBySource(csvData) {
            console.log('=== 문제 수 카운트 시작 ===');
            
            if (!csvData || !Array.isArray(csvData)) {
                console.error('CSV 데이터가 유효하지 않습니다.');
                return;
            }
            
            const counts = {
                "인스교재": 0,
                "보험중개사시험": 0,
                "total": 0
            };
            
            csvData.forEach(row => {
                if (row.SOURCE) {
                    if (row.SOURCE.includes('인스교재')) {
                        counts["인스교재"]++;
                    } else if (row.SOURCE.includes('보험중개사')) {
                        counts["보험중개사시험"]++;
                    }
                }
            });
            
            counts.total = counts["인스교재"] + counts["보험중개사시험"];
            counts.lastCounted = new Date().toISOString();
            
            console.log('문제 수 카운트 결과:', counts);
            
            // 통계 데이터 업데이트
            const stats = statisticsCache.get();
            if (stats) {
                stats.questionCounts = counts;
                statisticsCache.set(stats);
                statisticsCache.flush();
            }
            
            return counts;
        }
        
        // 통계 계산 유틸리티 함수
        function calculateAccuracy(correct, total) {
            if (total === 0) return 0;
            return Math.round((correct / total) * 100);
        }
        
        function calculateProgress(completed, total) {
            if (total === 0) return 0;
            return Math.round((completed / total) * 100);
        }
        
        // 데이터 정리 함수
        function cleanupOldDailyData() {
            console.log('=== 오래된 일별 데이터 정리 ===');
            
            const stats = statisticsCache.get();
            if (!stats || !stats.dailyHistory) return;
            
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            const cutoffDate = thirtyDaysAgo.toISOString().split('T')[0];
            
            let cleanedCount = 0;
            Object.keys(stats.dailyHistory).forEach(date => {
                if (date < cutoffDate) {
                    delete stats.dailyHistory[date];
                    cleanedCount++;
                }
            });
            
            if (cleanedCount > 0) {
                statisticsCache.set(stats);
                statisticsCache.flush();
                console.log(`${cleanedCount}개의 오래된 일별 데이터 정리 완료`);
            }
        }
        
        // 통계 데이터 검증 함수
        function validateStatistics(stats) {
            const errors = [];
            
            if (!stats || !stats.meta || !stats.stats) {
                errors.push('필수 통계 구조가 누락되었습니다.');
                return { isValid: false, errors };
            }
            
            // 숫자 데이터 검증
            const globalStats = stats.stats.global.cumulative;
            if (globalStats.attempted < 0) {
                errors.push('시도한 문제 수는 음수일 수 없습니다.');
            }
            
            if (globalStats.accuracy < 0 || globalStats.accuracy > 100) {
                errors.push('정확도는 0-100% 범위여야 합니다.');
            }
            
            return {
                isValid: errors.length === 0,
                errors: errors
            };
        }
        
        // 통계 데이터 복구 함수
        function repairStatistics(stats) {
            console.log('=== 통계 데이터 복구 시작 ===');
            
            if (!stats) return unifiedStatisticsSchema;
            
            // 잘못된 데이터를 기본값으로 복구
            if (stats.stats.global.cumulative.attempted < 0) {
                stats.stats.global.cumulative.attempted = 0;
            }
            
            if (stats.stats.global.cumulative.accuracy < 0 || stats.stats.global.cumulative.accuracy > 100) {
                stats.stats.global.cumulative.accuracy = 0;
            }
            
            // 누락된 필드 추가
            if (!stats.meta.version) {
                stats.meta.version = "2.0";
            }
            
            if (!stats.meta.lastUpdated) {
                stats.meta.lastUpdated = new Date().toISOString();
            }
            
            console.log('통계 데이터 복구 완료');
            return stats;
        }
        
        // 성능 모니터링
        function measureUpdatePerformance(operationName) {
            const startTime = performance.now();
            return {
                start: () => startTime,
                end: () => performance.now() - startTime,
                log: () => {
                    const duration = performance.now() - startTime;
                    console.log(`${operationName} 완료: ${duration.toFixed(2)}ms`);
                    
                    if (duration > 100) {
                        console.warn(`성능 경고: ${operationName}이 100ms를 초과했습니다.`);
                    }
                }
            };
        }
        
        // 오류 처리
        function handleStatisticsError(error, operation) {
            console.error(`통계 ${operation} 실패:`, error);
            
            // 사용자에게 알림
            showUserNotification(`통계 업데이트 중 오류가 발생했습니다. 잠시 후 다시 시도해주세요.`);
        }
        
        function showUserNotification(message) {
            // 간단한 토스트 메시지
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded shadow-lg z-50';
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (document.body.contains(notification)) {
                    document.body.removeChild(notification);
                }
            }, 5000);
        }
        
        // ===== Phase 1 완료 =====
        
        // ===== 통계 기능 개발 Phase 2: 대문 통계 구현 =====
        
        // 통합 통계 업데이트 함수
        function updateAllStatistics(isCorrect, mode, category) {
            const performance = measureUpdatePerformance('통계 업데이트');
            
            try {
                console.log('=== 통합 통계 업데이트 시작 ===');
                console.log(`정답여부: ${isCorrect}, 모드: ${mode}, 카테고리: ${category}`);
                
                const stats = statisticsCache.get();
                if (!stats) {
                    console.error('통계 데이터가 없습니다.');
                    return;
                }
                
                const todayKey = getTodayKey();
                
                // 1. 글로벌 통계 업데이트
                updateGlobalStatistics(stats, isCorrect, todayKey);
                
                // 2. 모드별 통계 업데이트
                updateModeStatistics(stats, isCorrect, mode, todayKey);
                
                // 3. 카테고리별 통계 업데이트 (대분류학습인 경우)
                if (mode === 'large-category' && category) {
                    updateCategoryStatistics(stats, isCorrect, category, todayKey);
                }
                
                // 4. 일별 히스토리 업데이트
                updateDailyHistory(stats, isCorrect, todayKey);
                
                // 5. 메타 정보 업데이트
                stats.meta.lastUpdated = new Date().toISOString();
                
                // 6. 데이터 저장
                statisticsCache.set(stats);
                saveStatisticsData();
                
                // 7. UI 업데이트 (지연 처리)
                scheduleUIUpdate(stats);
                
                performance.log();
                console.log('=== 통합 통계 업데이트 완료 ===');
                
            } catch (error) {
                handleStatisticsError(error, 'updateAllStatistics');
            }
        }
        
        // 글로벌 통계 업데이트
        function updateGlobalStatistics(stats, isCorrect, todayKey) {
            // 누적 통계 업데이트
            stats.stats.global.cumulative.attempted++;
            if (isCorrect) {
                stats.stats.global.cumulative.correct++;
            }
            stats.stats.global.cumulative.accuracy = calculateAccuracy(
                stats.stats.global.cumulative.correct,
                stats.stats.global.cumulative.attempted
            );
            
            // 일별 통계 업데이트
            if (!stats.stats.global.daily) {
                stats.stats.global.daily = { attempted: 0, correct: 0, accuracy: 0 };
            }
            stats.stats.global.daily.attempted++;
            if (isCorrect) {
                stats.stats.global.daily.correct++;
            }
            stats.stats.global.daily.accuracy = calculateAccuracy(
                stats.stats.global.daily.correct,
                stats.stats.global.daily.attempted
            );
        }
        
        // 모드별 통계 업데이트
        function updateModeStatistics(stats, isCorrect, mode, todayKey) {
            if (mode === 'basic') {
                updateBasicModeStatistics(stats, isCorrect, todayKey);
            } else if (mode === 'large-category') {
                updateLargeCategoryModeStatistics(stats, isCorrect, todayKey);
            }
        }
        
        // 기본학습 모드 통계 업데이트
        function updateBasicModeStatistics(stats, isCorrect, todayKey) {
            // 누적 통계
            stats.stats.modes.basic.cumulative.attempted++;
            if (isCorrect) {
                stats.stats.modes.basic.cumulative.correct++;
            }
            stats.stats.modes.basic.cumulative.accuracy = calculateAccuracy(
                stats.stats.modes.basic.cumulative.correct,
                stats.stats.modes.basic.cumulative.attempted
            );
            
            // 일별 통계
            stats.stats.modes.basic.daily.attempted++;
            if (isCorrect) {
                stats.stats.modes.basic.daily.correct++;
            }
            stats.stats.modes.basic.daily.accuracy = calculateAccuracy(
                stats.stats.modes.basic.daily.correct,
                stats.stats.modes.basic.daily.attempted
            );
        }
        
        // 대분류학습 모드 통계 업데이트
        function updateLargeCategoryModeStatistics(stats, isCorrect, todayKey) {
            // 전체 누적 통계
            stats.stats.modes.largeCategory.cumulative.attempted++;
            if (isCorrect) {
                stats.stats.modes.largeCategory.cumulative.correct++;
            }
            stats.stats.modes.largeCategory.cumulative.accuracy = calculateAccuracy(
                stats.stats.modes.largeCategory.cumulative.correct,
                stats.stats.modes.largeCategory.cumulative.attempted
            );
            
            // 전체 일별 통계
            stats.stats.modes.largeCategory.daily.attempted++;
            if (isCorrect) {
                stats.stats.modes.largeCategory.daily.correct++;
            }
            stats.stats.modes.largeCategory.daily.accuracy = calculateAccuracy(
                stats.stats.modes.largeCategory.daily.correct,
                stats.stats.modes.largeCategory.daily.attempted
            );
        }
        
        // 카테고리별 통계 업데이트
        function updateCategoryStatistics(stats, isCorrect, category, todayKey) {
            if (!stats.stats.modes.largeCategory.categories[category]) {
                stats.stats.modes.largeCategory.categories[category] = {
                    cumulative: { attempted: 0, correct: 0, accuracy: 0 },
                    daily: { attempted: 0, correct: 0, accuracy: 0 }
                };
            }
            
            const categoryStats = stats.stats.modes.largeCategory.categories[category];
            
            // 누적 통계
            categoryStats.cumulative.attempted++;
            if (isCorrect) {
                categoryStats.cumulative.correct++;
            }
            categoryStats.cumulative.accuracy = calculateAccuracy(
                categoryStats.cumulative.correct,
                categoryStats.cumulative.attempted
            );
            
            // 일별 통계
            categoryStats.daily.attempted++;
            if (isCorrect) {
                categoryStats.daily.correct++;
            }
            categoryStats.daily.accuracy = calculateAccuracy(
                categoryStats.daily.correct,
                categoryStats.daily.attempted
            );
        }
        
        // 일별 히스토리 업데이트
        function updateDailyHistory(stats, isCorrect, todayKey) {
            if (!stats.dailyHistory[todayKey]) {
                stats.dailyHistory[todayKey] = { attempted: 0, correct: 0, accuracy: 0 };
            }
            
            stats.dailyHistory[todayKey].attempted++;
            if (isCorrect) {
                stats.dailyHistory[todayKey].correct++;
            }
            stats.dailyHistory[todayKey].accuracy = calculateAccuracy(
                stats.dailyHistory[todayKey].correct,
                stats.dailyHistory[todayKey].attempted
            );
        }
        
        // UI 업데이트 스케줄링
        let uiUpdateTimeout = null;
        
        function scheduleUIUpdate(stats) {
            if (uiUpdateTimeout) {
                clearTimeout(uiUpdateTimeout);
            }
            
            uiUpdateTimeout = setTimeout(() => {
                updateAllUI(stats);
            }, 100); // 100ms 지연으로 배치 처리
        }
        
        // 모든 UI 업데이트
        function updateAllUI(stats) {
            const performance = measureUpdatePerformance('UI 업데이트');
            
            try {
                console.log('=== 전체 UI 업데이트 시작 ===');
                
                // 1. 대문 통계 업데이트
                updateHomeStatistics(stats);
                
                // 2. 기본학습 통계 업데이트
                updateBasicLearningStats(stats);
                
                // 3. 대분류학습 통계 업데이트
                updateLargeCategoryStats(stats);
                
                performance.log();
                console.log('=== 전체 UI 업데이트 완료 ===');
                
            } catch (error) {
                handleStatisticsError(error, 'updateAllUI');
            }
        }
        
        // 대문 통계 업데이트
        function updateHomeStatistics(stats) {
            // 보유 문제수 현황 업데이트
            updateQuestionCounts(stats);
            
            // 학습 진도 현황 업데이트
            updateProgressData(stats);
            
            // 금일 학습현황 업데이트
            updateDailyStatisticsDisplay(stats);
        }
        
        // 보유 문제수 현황 업데이트
        function updateQuestionCounts(stats) {
            const counts = stats.questionCounts;
            
            // 인스교재 문제수
            const insElement = document.getElementById('ins-questions');
            if (insElement) {
                animateNumber(insElement, parseInt(insElement.textContent) || 0, counts["인스교재"], 1000);
            }
            
            // 보험중개사시험 문제수
            const examElement = document.getElementById('exam-questions');
            if (examElement) {
                animateNumber(examElement, parseInt(examElement.textContent) || 0, counts["보험중개사시험"], 1000);
            }
            
            // 합계
            const totalElement = document.getElementById('total-questions');
            if (totalElement) {
                animateNumber(totalElement, parseInt(totalElement.textContent) || 0, counts["total"], 1000);
            }
        }
        
        // 학습 진도 현황 업데이트
        function updateProgressData(stats) {
            const global = stats.stats.global.cumulative;
            const counts = stats.questionCounts;
            
            // 완료한 문제수
            const completedElement = document.getElementById('completed-questions');
            if (completedElement) {
                animateNumber(completedElement, parseInt(completedElement.textContent) || 0, global.attempted, 1000);
            }
            
            // 전체 진도율
            const progressElement = document.getElementById('overall-progress-rate');
            if (progressElement) {
                const progressRate = calculateProgress(global.attempted, counts.total);
                animateNumber(progressElement, parseInt(progressElement.textContent) || 0, progressRate, 1000);
                progressElement.textContent = progressRate + '%';
            }
            
            // 정답률 (오늘의 진도율을 정답률로 변경)
            const accuracyElement = document.getElementById('daily-progress-rate');
            if (accuracyElement) {
                animateNumber(accuracyElement, parseInt(accuracyElement.textContent) || 0, global.accuracy, 1000);
                accuracyElement.textContent = global.accuracy + '%';
            }
        }
        
        // 금일 학습현황 업데이트
        function updateDailyStatisticsDisplay(stats) {
            const daily = stats.stats.global.daily;
            
            // 금일 학습현황 박스가 없으면 생성
            let dailyStatsBox = document.getElementById('daily-learning-stats');
            if (!dailyStatsBox) {
                createDailyStatsBox();
                dailyStatsBox = document.getElementById('daily-learning-stats');
            }
            
            // 오늘 풀이한 총 문제수
            const todayTotalElement = document.getElementById('today-total-questions');
            if (todayTotalElement) {
                animateNumber(todayTotalElement, parseInt(todayTotalElement.textContent) || 0, daily.attempted, 1000);
            }
            
            // 오늘 정답수
            const todayCorrectElement = document.getElementById('today-correct-answers');
            if (todayCorrectElement) {
                animateNumber(todayCorrectElement, parseInt(todayCorrectElement.textContent) || 0, daily.correct, 1000);
            }
            
            // 오늘 정답률
            const todayAccuracyElement = document.getElementById('today-accuracy-rate');
            if (todayAccuracyElement) {
                animateNumber(todayAccuracyElement, parseInt(todayAccuracyElement.textContent) || 0, daily.accuracy, 1000);
                todayAccuracyElement.textContent = daily.accuracy + '%';
            }
        }
        
        // 금일 학습현황 박스 생성
        function createDailyStatsBox() {
            const homeScreen = document.getElementById('home-screen');
            const progressSection = document.querySelector('.bg-white.rounded-lg.shadow-lg.p-6.mb-6:nth-child(4)');
            
            if (homeScreen && progressSection) {
                const dailyStatsBox = document.createElement('div');
                dailyStatsBox.id = 'daily-learning-stats';
                dailyStatsBox.className = 'bg-white rounded-lg shadow-lg p-6 mb-6';
                dailyStatsBox.innerHTML = `
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">금일의 학습 현황</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="text-center">
                            <div class="text-2xl font-bold text-blue-600" id="today-total-questions">0</div>
                            <div class="text-sm text-gray-600">오늘 푼 문제수</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-green-600" id="today-correct-answers">0</div>
                            <div class="text-sm text-gray-600">오늘 정답수</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-orange-600" id="today-accuracy-rate">0%</div>
                            <div class="text-sm text-gray-600">오늘 정답률</div>
                        </div>
                    </div>
                `;
                
                // 학습 진도 현황 다음에 삽입
                progressSection.parentNode.insertBefore(dailyStatsBox, progressSection.nextSibling);
            }
        }
        
        // 숫자 애니메이션 함수
        function animateNumber(element, from, to, duration) {
            if (!element) return;
            
            const startTime = performance.now();
            const startValue = from;
            const endValue = to;
            
            function updateNumber(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                
                // 이징 함수 (부드러운 애니메이션)
                const easeOutQuart = 1 - Math.pow(1 - progress, 4);
                const currentValue = Math.round(startValue + (endValue - startValue) * easeOutQuart);
                
                element.textContent = currentValue;
                
                if (progress < 1) {
                    requestAnimationFrame(updateNumber);
                }
            }
            
            requestAnimationFrame(updateNumber);
        }
        
        // 기본학습 통계 업데이트
        function updateBasicLearningStats(stats) {
            const basic = stats.stats.modes.basic;
            
            // 누적 현황
            const totalElement = document.getElementById('total-questions');
            const correctElement = document.getElementById('correct-answers');
            const incorrectElement = document.getElementById('incorrect-answers');
            
            if (totalElement) {
                animateNumber(totalElement, parseInt(totalElement.textContent) || 0, basic.cumulative.attempted, 1000);
            }
            if (correctElement) {
                animateNumber(correctElement, parseInt(correctElement.textContent) || 0, basic.cumulative.correct, 1000);
            }
            if (incorrectElement) {
                const incorrect = basic.cumulative.attempted - basic.cumulative.correct;
                animateNumber(incorrectElement, parseInt(incorrectElement.textContent) || 0, incorrect, 1000);
            }
        }
        
        // 기본학습 통계 업데이트
        function updateBasicStats(stats) {
            const basic = stats.stats.modes.basic;
            
            // 전체 누적 통계
            const basicTotalElement = document.getElementById('basic-total-questions');
            const basicCorrectElement = document.getElementById('basic-correct-answers');
            const basicIncorrectElement = document.getElementById('basic-incorrect-answers');
            
            if (basicTotalElement) {
                animateNumber(basicTotalElement, parseInt(basicTotalElement.textContent) || 0, basic.cumulative.attempted, 1000);
            }
            if (basicCorrectElement) {
                animateNumber(basicCorrectElement, parseInt(basicCorrectElement.textContent) || 0, basic.cumulative.correct, 1000);
            }
            if (basicIncorrectElement) {
                const incorrect = basic.cumulative.attempted - basic.cumulative.correct;
                animateNumber(basicIncorrectElement, parseInt(basicIncorrectElement.textContent) || 0, incorrect, 1000);
            }
        }
        
        // 대분류학습 통계 업데이트
        function updateLargeCategoryStats(stats) {
            const largeCategory = stats.stats.modes.largeCategory;
            
            // 전체 누적 통계
            const largeTotalElement = document.getElementById('large-total-questions');
            const largeCorrectElement = document.getElementById('large-correct-answers');
            const largeIncorrectElement = document.getElementById('large-incorrect-answers');
            
            if (largeTotalElement) {
                animateNumber(largeTotalElement, parseInt(largeTotalElement.textContent) || 0, largeCategory.cumulative.attempted, 1000);
            }
            if (largeCorrectElement) {
                animateNumber(largeCorrectElement, parseInt(largeCorrectElement.textContent) || 0, largeCategory.cumulative.correct, 1000);
            }
            if (largeIncorrectElement) {
                const incorrect = largeCategory.cumulative.attempted - largeCategory.cumulative.correct;
                animateNumber(largeIncorrectElement, parseInt(largeIncorrectElement.textContent) || 0, incorrect, 1000);
            }
        }
        
        // 로딩 상태 표시 함수
        function showStatisticsLoading() {
            const loadingElement = document.createElement('div');
            loadingElement.id = 'statistics-loading';
            loadingElement.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            loadingElement.innerHTML = `
                <div class="bg-white rounded-lg p-6 flex items-center space-x-3">
                    <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
                    <span class="text-gray-700">통계 데이터를 불러오는 중...</span>
                </div>
            `;
            document.body.appendChild(loadingElement);
        }
        
        function hideStatisticsLoading() {
            const loadingElement = document.getElementById('statistics-loading');
            if (loadingElement) {
                document.body.removeChild(loadingElement);
            }
        }
        
        // ===== Phase 2 완료 =====
        
        // ===== 통계 기능 개발 Phase 3: 학습 모드별 통계 구현 =====
        
        // 기존 checkAnswer 함수 수정 (통계 업데이트 통합)
        function checkAnswer(mode) {
            console.log(`=== 정답 확인 함수 실행 (모드: ${mode}) ===`);
            
            // 선택된 답안 확인
            if (!window.selectedAnswer) {
                alert('답안을 선택해주세요.');
                updateCheckTest('답안 미선택', false);
                return;
            }
            
            // 현재 문제 확인
            if (!window.currentQuestion) {
                console.error('현재 문제가 없습니다.');
                updateCheckTest('문제 없음', false);
                return;
            }
            
            // 모드별 설정 가져오기
            const config = MODE_CONFIG[mode];
            if (!config) {
                console.error(`알 수 없는 모드: ${mode}`);
                updateCheckTest('모드 오류', false);
                return;
            }
            
            try {
                // 정답 비교
                const isCorrect = window.selectedAnswer === window.currentQuestion.ANSWER;
                console.log(`선택한 답안: ${window.selectedAnswer}, 정답: ${window.currentQuestion.ANSWER}, 정답여부: ${isCorrect}`);
                
                // 정답 확인 상태 저장
                window.isAnswerChecked = true;
                
                // 결과 메시지 생성
                const resultMessage = isCorrect ? 
                    '정답입니다! 🎉' : 
                    `오답입니다. 정답은 "${window.currentQuestion.ANSWER}"입니다.`;
                
                // 결과 영역 표시
                const resultArea = document.getElementById(config.resultArea);
                const resultMessageElement = document.getElementById(config.resultMessage);
                
                resultArea.classList.remove('hidden');
                resultMessageElement.textContent = resultMessage;
                resultMessageElement.className = `p-3 rounded font-medium ${isCorrect ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`;
                
                // 답안 버튼 색상 업데이트
                updateAnswerButtonColors(mode, isCorrect);
                
                // === 새로운 통계 업데이트 시스템 사용 ===
                const category = window.currentCategoryData?.category || null;
                updateAllStatistics(isCorrect, mode, category);
                
                // 기존 통계 업데이트 (호환성 유지)
                updateStatistics(isCorrect);
                
                // 모드별 통계 업데이트 (기존)
                if (mode === 'basic') {
                    updateBasicStatistics();
                } else if (mode === 'large-category') {
                    updateLargeCategoryStatistics();
                }
                
                console.log('정답 확인 완료');
                updateCheckTest(`정답 확인 완료 (${isCorrect ? '정답' : '오답'})`, true);
                
            } catch (error) {
                console.error('정답 확인 중 오류:', error);
                updateCheckTest('확인 오류', false);
            }
        }
        
        // 기존 updateStatistics 함수 수정 (호환성 유지)
        function updateStatistics(isCorrect) {
            if (!window.statistics) {
                window.statistics = {
                    total: 0,
                    correct: 0,
                    incorrect: 0
                };
            }
            
            window.statistics.total++;
            if (isCorrect) {
                window.statistics.correct++;
            } else {
                window.statistics.incorrect++;
            }
            
            console.log('기존 통계 업데이트:', window.statistics);
            
            // 정답률 표시 업데이트
            updateAccuracyDisplay();
            
            // 저장 및 대문 업데이트 (에러 처리 포함)
            try {
                saveProgress();
                // 대문이 표시되어 있을 때만 업데이트
                if (!document.getElementById('home-screen').classList.contains('hidden')) {
                    updateProgressData();
                    updateQuestionCounts();
                }
            } catch (error) {
                console.error('통계 업데이트 실패:', error);
            }
        }
        
        // 기본학습 통계 업데이트 함수 수정
        function updateBasicStatistics() {
            const stats = statisticsCache.get();
            if (stats) {
                updateBasicLearningStats(stats);
            }
        }
        
        // 대분류학습 통계 업데이트 함수 수정
        function updateLargeCategoryStatistics() {
            const stats = statisticsCache.get();
            if (stats) {
                updateLargeCategoryStats(stats);
            }
        }
        
        // 정답률 표시 업데이트 함수 수정
        function updateAccuracyDisplay() {
            const accuracy = calculateAccuracy();
            
            // 기본학습 정답률 표시
            const basicAccuracyElement = document.getElementById('basic-accuracy');
            if (basicAccuracyElement) {
                basicAccuracyElement.innerHTML = `
                    <div class="text-center">
                        <div class="text-2xl font-bold text-blue-600">${accuracy}%</div>
                        <div class="text-sm text-gray-600">정답률</div>
                    </div>
                `;
            }
            
            // 대분류학습 정답률 표시
            const largeAccuracyElement = document.getElementById('large-accuracy');
            if (largeAccuracyElement) {
                largeAccuracyElement.innerHTML = `
                    <div class="text-center">
                        <div class="text-2xl font-bold text-green-600">${accuracy}%</div>
                        <div class="text-sm text-gray-600">정답률</div>
                    </div>
                `;
            }
            
            // 상세 통계 표시
            updateDetailedStatistics();
        }
        
        // 상세 통계 표시 함수 수정
        function updateDetailedStatistics() {
            if (!window.statistics) return;
            
            const { total, correct, incorrect } = window.statistics;
            
            // 기본학습 상세 통계 업데이트
            const basicTotalElement = document.getElementById('total-questions');
            const basicCorrectElement = document.getElementById('correct-answers');
            const basicIncorrectElement = document.getElementById('incorrect-answers');
            
            if (basicTotalElement) basicTotalElement.textContent = total;
            if (basicCorrectElement) basicCorrectElement.textContent = correct;
            if (basicIncorrectElement) basicIncorrectElement.textContent = incorrect;
            
            // 대분류학습 상세 통계 업데이트
            const largeTotalElement = document.getElementById('large-total-questions');
            const largeCorrectElement = document.getElementById('large-correct-answers');
            const largeIncorrectElement = document.getElementById('large-incorrect-answers');
            
            if (largeTotalElement) largeTotalElement.textContent = total;
            if (largeCorrectElement) largeCorrectElement.textContent = correct;
            if (largeIncorrectElement) largeIncorrectElement.textContent = incorrect;
            
            console.log(`상세 통계 업데이트: 총 ${total}개, 정답 ${correct}개, 오답 ${incorrect}개`);
        }
        
        // 앱 초기화 시 통계 시스템 초기화
        function initializeApp() {
            console.log('=== 앱 초기화 시작 ===');
            
            // 1. 통계 시스템 초기화
            initializeStatistics();
            
            // 2. 보유 문제수 계산 (ins_master_db.csv 로드)
            loadMasterDatabase();
            
            // 3. 기존 통계 데이터 로드
            loadStatisticsData();
            
            // 4. 오래된 데이터 정리
            cleanupOldDailyData();
            
            console.log('=== 앱 초기화 완료 ===');
        }
        
        // 마스터 데이터베이스 로드 및 문제수 계산
        function loadMasterDatabase() {
            console.log('=== 마스터 데이터베이스 로드 시작 ===');
            
            Papa.parse('ins_master_db.csv', {
                download: true,
                header: true,
                complete: (results) => {
                    console.log('마스터 DB 로드 완료:', results.data.length, '개 행');
                    
                    // 데이터 필터링
                    const filteredData = results.data.filter(row =>
                        row.QCODE && row.QUESTION && row.ANSWER && row.QCODE.trim() !== ''
                    );
                    
                    console.log('필터링 후 데이터:', filteredData.length, '개 행');
                    
                    // 문제수 계산
                    countQuestionsBySource(filteredData);
                    
                    // 통계 UI 업데이트
                    const stats = statisticsCache.get();
                    if (stats) {
                        updateQuestionCounts(stats);
                    }
                    
                    console.log('=== 마스터 데이터베이스 로드 완료 ===');
                },
                error: (error) => {
                    console.error('마스터 DB 로드 실패:', error);
                    handleStatisticsError(error, 'loadMasterDatabase');
                }
            });
        }
        
        // 설정에서 사용자 등록 시 통계 초기화
        function saveUserSettings() {
            console.log('=== 사용자 설정 저장 ===');
            
            const form = document.getElementById('user-settings-form');
            const formData = new FormData(form);
            
            const userSettings = {
                userName: formData.get('user-name'),
                userPhone: formData.get('user-phone'),
                examSubject: formData.get('exam-subject'),
                examDate: formData.get('exam-date'),
                registrationDate: new Date().toISOString()
            };
            
            try {
                // 사용자 설정 저장
                localStorage.setItem('aicu_user_settings', JSON.stringify(userSettings));
                
                // 통계 데이터에 사용자 정보 업데이트
                const stats = statisticsCache.get();
                if (stats) {
                    stats.meta.userName = userSettings.userName;
                    stats.meta.registeredAt = userSettings.registrationDate;
                    stats.meta.lastUpdated = new Date().toISOString();
                    statisticsCache.set(stats);
                    statisticsCache.flush();
                }
                
                // 화면 업데이트
                document.getElementById('user-name-display').textContent = `사용자: ${userSettings.userName}님`;
                document.getElementById('exam-date-display').textContent = formatExamDate(userSettings.examDate);
                
                // 설정 모달 닫기
                closeUserSettings();
                
                // D-day 계산
                updateDday(userSettings.examDate);
                
                console.log('사용자 설정 저장 완료');
                
            } catch (error) {
                console.error('사용자 설정 저장 실패:', error);
                alert('설정 저장 중 오류가 발생했습니다.');
            }
        }
        
        // D-day 계산 함수
        function updateDday(examDate) {
            if (!examDate) return;
            
            const today = new Date();
            const exam = new Date(examDate);
            const diffTime = exam - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            const ddayElement = document.getElementById('d-day-display');
            if (ddayElement) {
                ddayElement.textContent = `D-${diffDays}일`;
            }
        }
        
        // 시험일 포맷 함수
        function formatExamDate(dateString) {
            if (!dateString) return '2025년 12월 15일';
            
            const date = new Date(dateString);
            return `${date.getFullYear()}년 ${date.getMonth() + 1}월 ${date.getDate()}일`;
        }
        
        // 통계 데이터 초기화 함수
        function clearAllStatistics() {
            console.log('=== 모든 통계 데이터 초기화 ===');
            
            try {
                // Local Storage에서 통계 데이터 삭제
                localStorage.removeItem('aicu_statistics');
                
                // 캐시 무효화
                statisticsCache.invalidate();
                
                // 새로운 통계 데이터 생성
                initializeStatistics();
                
                // UI 초기화
                const stats = statisticsCache.get();
                if (stats) {
                    updateAllUI(stats);
                }
                
                // 기존 통계 변수 초기화
                window.statistics = {
                    total: 0,
                    correct: 0,
                    incorrect: 0
                };
                
                console.log('통계 데이터 초기화 완료');
                alert('모든 통계 데이터가 초기화되었습니다.');
                
            } catch (error) {
                console.error('통계 초기화 실패:', error);
                alert('통계 초기화 중 오류가 발생했습니다.');
            }
        }
        
        // 데이터 백업/복구 기능
        function exportStatistics() {
            console.log('=== 통계 데이터 내보내기 ===');
            
            try {
                const stats = statisticsCache.get();
                if (!stats) {
                    alert('내보낼 통계 데이터가 없습니다.');
                    return;
                }
                
                const dataStr = JSON.stringify(stats, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `aicu_statistics_${getTodayKey()}.json`;
                link.click();
                
                console.log('통계 데이터 내보내기 완료');
                
            } catch (error) {
                console.error('통계 데이터 내보내기 실패:', error);
                alert('통계 데이터 내보내기 중 오류가 발생했습니다.');
            }
        }
        
        function importStatistics() {
            console.log('=== 통계 데이터 가져오기 ===');
            
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedStats = JSON.parse(e.target.result);
                        
                        // 데이터 검증
                        const validation = validateStatistics(importedStats);
                        if (!validation.isValid) {
                            alert('유효하지 않은 통계 데이터입니다: ' + validation.errors.join(', '));
                            return;
                        }
                        
                        // 데이터 복구
                        const repairedStats = repairStatistics(importedStats);
                        
                        // 통계 데이터 저장
                        statisticsCache.set(repairedStats);
                        statisticsCache.flush();
                        
                        // UI 업데이트
                        updateAllUI(repairedStats);
                        
                        console.log('통계 데이터 가져오기 완료');
                        alert('통계 데이터를 성공적으로 가져왔습니다.');
                        
                    } catch (error) {
                        console.error('통계 데이터 가져오기 실패:', error);
                        alert('통계 데이터 가져오기 중 오류가 발생했습니다.');
                    }
                };
                
                reader.readAsText(file);
            };
            
            input.click();
        }
        
        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', function() {
            console.log('페이지 로드 완료 - 통계 시스템 초기화 시작');
            
            // 앱 초기화
            initializeApp();
            
            // 자동 저장 설정
            setupAutoSave();
            
            // 저장된 진행상황 복원 시도
            const hasSavedProgress = loadProgress();
            if (hasSavedProgress) {
                document.getElementById('status').textContent = '저장된 진행상황을 복원했습니다.';
                document.getElementById('status').className = 'text-center text-green-600 mb-4 font-semibold';
            }
        });
        
        // ===== Phase 3 완료 =====
        
        // ===== 통계 기능 개발 Phase 4: 최적화 및 폴리싱 =====
        
        // 설정 모달에 통계 관리 기능 추가
        function addStatisticsManagementToSettings() {
            const settingsModal = document.getElementById('user-settings-modal');
            if (!settingsModal) return;
            
            const form = document.getElementById('user-settings-form');
            if (!form) return;
            
            // 통계 관리 섹션 추가
            const statisticsSection = document.createElement('div');
            statisticsSection.className = 'border-t pt-4 mt-4';
            statisticsSection.innerHTML = `
                <h4 class="text-lg font-semibold text-gray-800 mb-3">통계 관리</h4>
                
                <!-- 현재 통계 표시 -->
                <div class="mb-4 p-3 bg-gray-50 rounded">
                    <h5 class="font-medium text-gray-700 mb-2">현재 학습 통계</h5>
                    <div id="current-stats-display" class="text-sm text-gray-600">
                        로딩 중...
                    </div>
                </div>
                
                <!-- 통계 관리 버튼들 -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <button type="button" onclick="exportStatistics()" 
                            class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded text-sm">
                        📊 통계 내보내기
                    </button>
                    <button type="button" onclick="importStatistics()" 
                            class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded text-sm">
                        📥 통계 가져오기
                    </button>
                    <button type="button" onclick="clearAllStatistics()" 
                            class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded text-sm">
                        🗑️ 통계 초기화
                    </button>
                    <button type="button" onclick="refreshStatistics()" 
                            class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded text-sm">
                        🔄 통계 새로고침
                    </button>
                </div>
                
                <!-- 통계 정보 -->
                <div class="mt-4 p-3 bg-blue-50 rounded">
                    <h5 class="font-medium text-blue-800 mb-2">💡 통계 정보</h5>
                    <ul class="text-xs text-blue-700 space-y-1">
                        <li>• 모든 통계는 로컬에 저장되며 다른 디바이스와 동기화되지 않습니다.</li>
                        <li>• 통계 내보내기/가져오기로 데이터 백업이 가능합니다.</li>
                        <li>• 30일 이상 된 일별 데이터는 자동으로 정리됩니다.</li>
                        <li>• 통계 초기화는 되돌릴 수 없으니 주의하세요.</li>
                    </ul>
                </div>
            `;
            
            // 폼 끝에 추가
            form.appendChild(statisticsSection);
        }
        
        // 현재 통계 표시 업데이트
        function updateCurrentStatsDisplay() {
            const stats = statisticsCache.get();
            const displayElement = document.getElementById('current-stats-display');
            
            if (!displayElement || !stats) return;
            
            const global = stats.stats.global.cumulative;
            const today = stats.stats.global.daily;
            
            displayElement.innerHTML = `
                <div class="grid grid-cols-2 gap-2 text-xs">
                    <div>
                        <span class="font-medium">총 푼 문제:</span> ${global.attempted}개
                    </div>
                    <div>
                        <span class="font-medium">총 정답:</span> ${global.correct}개
                    </div>
                    <div>
                        <span class="font-medium">전체 정답률:</span> ${global.accuracy}%
                    </div>
                    <div>
                        <span class="font-medium">오늘 푼 문제:</span> ${today.attempted}개
                    </div>
                </div>
            `;
        }
        
        // 통계 새로고침 함수
        function refreshStatistics() {
            console.log('=== 통계 새로고침 ===');
            
            showStatisticsLoading();
            
            setTimeout(() => {
                // 통계 데이터 다시 로드
                loadStatisticsData();
                
                // 현재 통계 표시 업데이트
                updateCurrentStatsDisplay();
                
                hideStatisticsLoading();
                
                alert('통계가 새로고침되었습니다.');
            }, 1000);
        }
        
        // 설정 모달 열기 함수 수정
        function openUserSettings() {
            const modal = document.getElementById('user-settings-modal');
            if (modal) {
                modal.classList.remove('hidden');
                
                // 통계 관리 기능 추가 (한 번만)
                if (!document.getElementById('current-stats-display')) {
                    addStatisticsManagementToSettings();
                }
                
                // 현재 통계 표시 업데이트
                updateCurrentStatsDisplay();
            }
        }
        
        // 성능 최적화: 메모리 사용량 모니터링
        function setupMemoryMonitoring() {
            if (performance.memory) {
                setInterval(() => {
                    const memoryUsage = performance.memory.usedJSHeapSize;
                    const memoryLimit = performance.memory.jsHeapSizeLimit;
                    const usagePercentage = (memoryUsage / memoryLimit) * 100;
                    
                    if (usagePercentage > 80) {
                        console.warn('메모리 사용량이 높습니다:', Math.round(usagePercentage), '%');
                        
                        // 메모리 정리
                        cleanupMemory();
                    }
                }, 30000); // 30초마다 체크
            }
        }
        
        // 메모리 정리 함수
        function cleanupMemory() {
            console.log('=== 메모리 정리 시작 ===');
            
            // 불필요한 전역 변수 정리
            const unnecessaryVars = ['tempData', 'debugInfo', 'testData'];
            unnecessaryVars.forEach(varName => {
                if (window[varName]) {
                    delete window[varName];
                }
            });
            
            // 캐시 정리
            if (window.domCache) {
                window.domCache.clear();
            }
            
            // 가비지 컬렉션 강제 실행 (가능한 경우)
            if (window.gc) {
                window.gc();
            }
            
            console.log('메모리 정리 완료');
        }
        
        // 네트워크 성능 모니터링
        function setupNetworkMonitoring() {
            if ('connection' in navigator) {
                const connection = navigator.connection;
                console.log('네트워크 정보:', {
                    effectiveType: connection.effectiveType,
                    downlink: connection.downlink,
                    rtt: connection.rtt
                });
                
                // 네트워크 상태 변화 감지
                connection.addEventListener('change', () => {
                    console.log('네트워크 상태 변화:', {
                        effectiveType: connection.effectiveType,
                        downlink: connection.downlink
                    });
                });
            }
        }
        
        // 통계 시스템 최종 테스트
        function runStatisticsSystemTest() {
            console.log('=== 통계 시스템 최종 테스트 시작 ===');
            
            const testResults = {
                infrastructure: { passed: 0, total: 0, details: [] },
                ui: { passed: 0, total: 0, details: [] },
                performance: { passed: 0, total: 0, details: [] },
                data: { passed: 0, total: 0, details: [] }
            };
            
            // 1. 인프라 테스트
            testInfrastructure(testResults.infrastructure);
            
            // 2. UI 테스트
            testUIComponents(testResults.ui);
            
            // 3. 성능 테스트
            testPerformance(testResults.performance);
            
            // 4. 데이터 테스트
            testDataIntegrity(testResults.data);
            
            // 결과 표시
            displayTestResults(testResults);
            
            console.log('=== 통계 시스템 최종 테스트 완료 ===');
        }
        
        // 인프라 테스트
        function testInfrastructure(results) {
            try {
                // StatisticsCache 테스트
                if (statisticsCache && typeof statisticsCache.get === 'function') {
                    results.passed++;
                    results.details.push('✅ StatisticsCache 클래스 정상');
                } else {
                    results.details.push('❌ StatisticsCache 클래스 오류');
                }
                results.total++;
                
                // 통합 스키마 테스트
                if (unifiedStatisticsSchema && unifiedStatisticsSchema.meta) {
                    results.passed++;
                    results.details.push('✅ 통합 스키마 정상');
                } else {
                    results.details.push('❌ 통합 스키마 오류');
                }
                results.total++;
                
                // 기본 함수들 테스트
                const functions = ['initializeStatistics', 'loadStatisticsData', 'saveStatisticsData'];
                functions.forEach(funcName => {
                    if (typeof window[funcName] === 'function') {
                        results.passed++;
                        results.details.push(`✅ ${funcName} 함수 정상`);
                    } else {
                        results.details.push(`❌ ${funcName} 함수 오류`);
                    }
                    results.total++;
                });
                
            } catch (error) {
                console.error('인프라 테스트 오류:', error);
                results.details.push(`❌ 테스트 오류: ${error.message}`);
            }
        }
        
        // UI 컴포넌트 테스트
        function testUIComponents(results) {
            try {
                // 대문 통계 요소들 테스트
                const homeElements = ['ins-questions', 'exam-questions', 'total-questions', 'completed-questions'];
                homeElements.forEach(elementId => {
                    const element = document.getElementById(elementId);
                    if (element) {
                        results.passed++;
                        results.details.push(`✅ ${elementId} 요소 정상`);
                    } else {
                        results.details.push(`❌ ${elementId} 요소 없음`);
                    }
                    results.total++;
                });
                
                // 금일 학습현황 박스 테스트
                const dailyElements = ['today-total-questions', 'today-correct-answers', 'today-accuracy-rate'];
                dailyElements.forEach(elementId => {
                    const element = document.getElementById(elementId);
                    if (element) {
                        results.passed++;
                        results.details.push(`✅ ${elementId} 요소 정상`);
                    } else {
                        results.details.push(`❌ ${elementId} 요소 없음`);
                    }
                    results.total++;
                });
                
            } catch (error) {
                console.error('UI 테스트 오류:', error);
                results.details.push(`❌ 테스트 오류: ${error.message}`);
            }
        }
        
        // 성능 테스트
        function testPerformance(results) {
            try {
                // 통계 업데이트 성능 테스트
                const startTime = performance.now();
                updateAllStatistics(true, 'basic', null);
                const updateTime = performance.now() - startTime;
                
                if (updateTime < 100) {
                    results.passed++;
                    results.details.push(`✅ 통계 업데이트 성능 정상 (${updateTime.toFixed(2)}ms)`);
                } else {
                    results.details.push(`⚠️ 통계 업데이트 성능 느림 (${updateTime.toFixed(2)}ms)`);
                }
                results.total++;
                
                // 메모리 사용량 테스트
                if (performance.memory) {
                    const memoryUsage = performance.memory.usedJSHeapSize;
                    const memoryMB = Math.round(memoryUsage / 1024 / 1024 * 100) / 100;
                    
                    if (memoryMB < 50) {
                        results.passed++;
                        results.details.push(`✅ 메모리 사용량 정상 (${memoryMB}MB)`);
                    } else {
                        results.details.push(`⚠️ 메모리 사용량 높음 (${memoryMB}MB)`);
                    }
                    results.total++;
                }
                
            } catch (error) {
                console.error('성능 테스트 오류:', error);
                results.details.push(`❌ 테스트 오류: ${error.message}`);
            }
        }
        
        // 데이터 무결성 테스트
        function testDataIntegrity(results) {
            try {
                const stats = statisticsCache.get();
                
                if (stats) {
                    // 데이터 구조 검증
                    const validation = validateStatistics(stats);
                    if (validation.isValid) {
                        results.passed++;
                        results.details.push('✅ 데이터 구조 정상');
                    } else {
                        results.details.push(`❌ 데이터 구조 오류: ${validation.errors.join(', ')}`);
                    }
                    results.total++;
                    
                    // 필수 필드 검증
                    const requiredFields = ['meta', 'stats', 'questionCounts'];
                    let allFieldsPresent = true;
                    
                    requiredFields.forEach(field => {
                        if (!stats[field]) {
                            allFieldsPresent = false;
                        }
                    });
                    
                    if (allFieldsPresent) {
                        results.passed++;
                        results.details.push('✅ 필수 필드 모두 존재');
                    } else {
                        results.details.push('❌ 필수 필드 누락');
                    }
                    results.total++;
                    
                } else {
                    results.details.push('❌ 통계 데이터 없음');
                    results.total++;
                }
                
            } catch (error) {
                console.error('데이터 무결성 테스트 오류:', error);
                results.details.push(`❌ 테스트 오류: ${error.message}`);
            }
        }
        
        // 테스트 결과 표시
        function displayTestResults(results) {
            console.log('=== 통계 시스템 테스트 결과 ===');
            
            let totalPassed = 0;
            let totalTests = 0;
            
            Object.keys(results).forEach(category => {
                const result = results[category];
                const percentage = result.total > 0 ? Math.round((result.passed / result.total) * 100) : 0;
                
                console.log(`${category}: ${result.passed}/${result.total} (${percentage}%)`);
                result.details.forEach(detail => console.log(`  ${detail}`));
                
                totalPassed += result.passed;
                totalTests += result.total;
            });
            
            const overallPercentage = totalTests > 0 ? Math.round((totalPassed / totalTests) * 100) : 0;
            console.log(`전체 결과: ${totalPassed}/${totalTests} (${overallPercentage}%)`);
            
            // 결과를 화면에 표시
            const statusElement = document.getElementById('status');
            if (statusElement) {
                statusElement.textContent = `통계 시스템 테스트 완료: ${totalPassed}/${totalTests} (${overallPercentage}%)`;
                statusElement.className = overallPercentage >= 80 ? 
                    'text-center text-green-600 mb-4 font-semibold' : 
                    'text-center text-yellow-600 mb-4 font-semibold';
            }
        }
        
        // 앱 초기화 함수 수정 (최종)
        function initializeApp() {
            console.log('=== 앱 초기화 시작 ===');
            
            // 1. 통계 시스템 초기화
            initializeStatistics();
            
            // 2. 보유 문제수 계산 (ins_master_db.csv 로드)
            loadMasterDatabase();
            
            // 3. 기존 통계 데이터 로드
            loadStatisticsData();
            
            // 4. 오래된 데이터 정리
            cleanupOldDailyData();
            
            // 5. 성능 모니터링 설정
            setupMemoryMonitoring();
            setupNetworkMonitoring();
            
            // 6. 통계 시스템 테스트 (개발 모드에서만)
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                setTimeout(() => {
                    runStatisticsSystemTest();
                }, 2000);
            }
            
            console.log('=== 앱 초기화 완료 ===');
        }
        
        // ===== Phase 4 완료 =====
        
        // ===== 통계 기능 개발 완료 =====
        
        console.log('🎉 AICU QUIZ 앱 통계 기능 개발이 완료되었습니다!');
        console.log('📊 구현된 기능:');
        console.log('  ✅ 통합 통계 스키마 (aicu_statistics)');
        console.log('  ✅ StatisticsCache 클래스 (성능 최적화)');
        console.log('  ✅ 대문 통계 (보유문제수, 학습진도, 금일현황)');
        console.log('  ✅ 기본학습 통계 (누적/금일)');
        console.log('  ✅ 대분류학습 통계 (전체/카테고리별)');
        console.log('  ✅ 실시간 통계 업데이트');
        console.log('  ✅ 데이터 백업/복구 기능');
        console.log('  ✅ 성능 모니터링 및 최적화');
        console.log('  ✅ 오류 처리 및 데이터 무결성 검증');
    </script>
    
    <!-- 사용자 설정 모달 -->
    <div id="user-settings-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
            <h3 class="text-lg font-semibold mb-4">사용자 설정</h3>
            <form id="user-settings-form">
                <div class="space-y-4">
                    <div>
                        <label for="user-name" class="block text-sm font-medium text-gray-700 mb-2">사용자 이름</label>
                        <input type="text" id="user-name" name="userName" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="user-phone" class="block text-sm font-medium text-gray-700 mb-2">휴대폰 번호</label>
                        <input type="tel" id="user-phone" name="userPhone" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="010-1234-5678">
                    </div>
                    <div>
                        <label for="exam-subject" class="block text-sm font-medium text-gray-700 mb-2">응시 과목</label>
                        <input type="text" id="exam-subject" name="examSubject" value="ACIU" readonly class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100">
                    </div>
                    <div>
                        <label for="exam-date" class="block text-sm font-medium text-gray-700 mb-2">응시일</label>
                        <input type="date" id="exam-date" name="examDate" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                                    <div class="flex space-x-3 mt-6">
                        <button type="submit" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-md">저장</button>
                        <button type="button" onclick="closeUserSettings()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-md">취소</button>
                    </div>
                </form>
                
                <!-- 통계 데이터 관리 섹션 -->
                <div class="border-t pt-4 mt-4">
                    <h4 class="font-semibold text-gray-800 mb-3">통계 데이터 관리</h4>
                    
                    <div class="space-y-3">
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="text-sm font-medium text-gray-700">현재 학습 통계</div>
                                <div class="text-xs text-gray-500" id="current-stats-display">
                                    푼 문제: 0개, 정답률: 0%
                                </div>
                            </div>
                            <button type="button" onclick="clearAllStatistics()" 
                                    class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm">
                                전체 초기화
                            </button>
                        </div>
                        
                        <div class="text-xs text-gray-500">
                            ⚠️ 초기화하면 모든 학습 진행상황과 통계가 삭제됩니다.
                        </div>
                    </div>
                </div>
            </div>
        </div>
</body>
</html>