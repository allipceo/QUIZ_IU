<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AICU QUIZ 앱</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; }
        .hidden { display: none; }
        
        /* 중분류 학습 모드 스타일링 */
        /* 메인 카테고리 버튼 영역 */
        .main-category-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            max-width: 600px;
            margin: 0 auto 20px;
        }

        .main-category-button {
            min-height: 60px;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-weight: 500;
        }

        .main-category-button:hover {
            background: #f0f9ff;
            border-color: #3b82f6;
            transform: translateY(-2px);
        }

        .main-category-button.active {
            background: #3b82f6;
            color: white;
            border-color: #2563eb;
            font-weight: bold;
        }

        .main-category-button.other-button {
            background: #f3f4f6;
            border-style: dashed;
        }

        .main-category-button.other-button:hover {
            background: #e5e7eb;
        }

        /* 문제 수 표시 */
        .category-count {
            display: block;
            font-size: 12px;
            color: #6b7280;
            margin-top: 4px;
        }

        .active .category-count {
            color: #e5e7eb;
        }

        /* 기타 카테고리 상세 영역 */
        .other-category-section {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
            max-height: 0; /* 애니메이션을 위해 추가 */
            overflow: hidden; /* 애니메이션을 위해 추가 */
            transition: max-height 0.3s ease-in-out; /* 애니메이션을 위해 추가 */
        }

        .other-category-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 12px 0;
        }

        .other-category-button {
            font-size: 12px;
            padding: 8px 12px;
            min-height: 36px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .other-category-button:hover {
            background: #f3f4f6;
            border-color: #9ca3af;
        }

        .other-category-button.active {
            background: #1f2937;
            color: white;
            border-color: #374151;
        }

        .close-other-btn {
            width: 100%;
            padding: 8px;
            background: #e5e7eb;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 8px;
        }

        /* 모바일 반응형 */
        @media (max-width: 768px) {
            .main-category-buttons {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }
            
            .main-category-button {
                min-height: 50px;
                font-size: 14px;
                padding: 10px 12px;
            }
            
            .other-category-button {
                font-size: 11px;
                padding: 6px 10px;
                min-height: 32px;
            }
        }

        /* statistics1.html 스타일 통합 */
        .card {
            background-color: #ffffff;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-md */
            padding: 1.5rem; /* p-6 */
        }
        .large-number {
            font-size: 2.5rem; /* text-4xl */
            font-weight: 700; /* font-bold */
            color: #1d4ed8; /* Tailwind blue-700 */
        }
        .sub-text {
            font-size: 0.875rem; /* text-sm */
            color: #6b7280; /* Tailwind gray-500 */
        }
        .progress-bar-container {
            background-color: #e5e7eb; /* Tailwind gray-200 */
            border-radius: 0.5rem; /* rounded-full */
            height: 0.75rem; /* h-3 */
            overflow: hidden;
        }
        .progress-bar {
            background-color: #3b82f6; /* Tailwind blue-500 */
            height: 100%;
            border-radius: 0.5rem; /* rounded-full */
            transition: width 0.5s ease-in-out;
        }
        .category-card {
            background-color: #eff6ff; /* Tailwind blue-50 */
            border-radius: 0.75rem; /* rounded-xl */
            padding: 1rem; /* p-4 */
            border: 1px solid #bfdbfe; /* Tailwind blue-200 */
        }
        .category-title {
            font-size: 1.125rem; /* text-lg */
            font-weight: 700; /* font-bold */
            color: #1e40af; /* Tailwind blue-800 */
        }
        .category-progress-number {
            font-size: 1.875rem; /* text-3xl */
            font-weight: 700; /* font-bold */
            color: #1d4ed8; /* Tailwind blue-700 */
        }
        .cut-off-info {
            background-color: #fef2f2; /* Tailwind red-50 */
            border: 1px solid #fca5a5; /* Tailwind red-300 */
            color: #dc2626; /* Tailwind red-600 */
            padding: 0.75rem;
            border-radius: 0.5rem;
            font-weight: 600;
            text-align: center;
        }
        .average-score-card {
            background-color: #ecfdf5; /* Tailwind green-50 */
            border: 1px solid #a7f3d0; /* Tailwind green-300 */
            border-radius: 0.75rem;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .average-score-number {
            font-size: 3rem; /* text-5xl */
            font-weight: 700; /* font-bold */
            color: #047857; /* Tailwind green-700 */
            margin-bottom: 0.5rem;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- 상단 헤더 -->
    <div class="bg-white shadow-lg">
        <div class="container mx-auto px-4 py-3">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <h1 class="text-xl font-bold text-blue-700">ACIU QUIZ 앱</h1>
                    <span class="text-sm text-gray-600" id="current-mode">모드 선택</span>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-sm text-gray-600">
                        <span id="user-info">사용자: 조대표님</span> | 
                        <span id="exam-dday">D-90일</span>
                    </div>
                    <div class="text-sm text-gray-600" id="current-time"></div>
                    <button onclick="ACIUApp.ui.showSettingsModal()" class="text-gray-600 hover:text-blue-600">
                        ⚙️
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 메인 콘텐츠 -->
    <div class="container mx-auto px-4 py-6 max-w-6xl">
        <!-- 오늘의 명언 -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <div class="text-center">
                <p class="text-lg text-gray-700 italic" id="quote-of-day">
                    "학습은 가장 좋은 투자입니다."
                </p>
            </div>
        </div>

        <!-- 보유 문제수 현황 -->
        <div class="card mb-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">📊 보유 문제 현황</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-center">
                <!-- 인스교재 -->
                <div class="p-4 bg-blue-50 rounded-lg border border-blue-200">
                    <p class="text-sm text-gray-600 mb-1">인스교재</p>
                    <p class="large-number" id="ins-total-count">0</p>
                    <p class="sub-text">선택형 <span id="ins-choice-count">0</span>개 | 진위형 <span id="ins-tf-count">0</span>개</p>
                </div>
                <!-- 보험중개사시험 -->
                <div class="p-4 bg-green-50 rounded-lg border border-green-200">
                    <p class="text-sm text-gray-600 mb-1">보험중개사시험</p>
                    <p class="large-number" id="broker-total-count">0</p>
                    <p class="sub-text">진위형 <span id="broker-tf-count">0</span>개 | 선택형 <span id="broker-choice-count">0</span>개</p>
                </div>
                <!-- 총계 -->
                <div class="p-4 bg-purple-50 rounded-lg border border-purple-200">
                    <p class="text-sm text-gray-600 mb-1">총계</p>
                    <p class="large-number" id="total-question-count">0</p>
                    <p class="sub-text">전체 문제 수</p>
                </div>
            </div>
        </div>

        <!-- 학습 진도 요약 -->
        <div class="card mb-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">📈 학습 진도 현황 (대분류별)</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6" id="category-progress-display">
                <!-- 재산보험 -->
                <div class="category-card">
                    <h3 class="category-title mb-2">재산보험</h3>
                    <p class="text-gray-700 text-sm mb-1">
                        학습 현황: <span class="category-progress-number" id="prop-completed">0</span> / <span id="prop-total">0</span>
                    </p>
                    <div class="progress-bar-container">
                        <div class="progress-bar" style="width: 0%;"></div>
                    </div>
                    <p class="text-right text-base font-semibold text-blue-600 mt-1" id="prop-percentage">0%</p>
                    <p class="text-gray-600 text-sm mt-2">미학습 문제: <span id="prop-unlearned">0</span>개</p>
                </div>
                <!-- 특종보험 -->
                <div class="category-card">
                    <h3 class="category-title mb-2">특종보험</h3>
                    <p class="text-gray-700 text-sm mb-1">
                        학습 현황: <span class="category-progress-number" id="spec-completed">0</span> / <span id="spec-total">0</span>
                    </p>
                    <div class="progress-bar-container">
                        <div class="progress-bar" style="width: 0%;"></div>
                    </div>
                    <p class="text-right text-base font-semibold text-blue-600 mt-1" id="spec-percentage">0%</p>
                    <p class="text-gray-600 text-sm mt-2">미학습 문제: <span id="spec-unlearned">0</span>개</p>
                </div>
                <!-- 배상책임보험 -->
                <div class="category-card">
                    <h3 class="category-title mb-2">배상책임보험</h3>
                    <p class="text-gray-700 text-sm mb-1">
                        학습 현황: <span class="category-progress-number" id="liab-completed">0</span> / <span id="liab-total">0</span>
                    </p>
                    <div class="progress-bar-container">
                        <div class="progress-bar" style="width: 0%;"></div>
                    </div>
                    <p class="text-right text-base font-semibold text-blue-600 mt-1" id="liab-percentage">0%</p>
                    <p class="text-gray-600 text-sm mt-2">미학습 문제: <span id="liab-unlearned">0</span>개</p>
                </div>
                <!-- 해상보험 -->
                <div class="category-card">
                    <h3 class="category-title mb-2">해상보험</h3>
                    <p class="text-gray-700 text-sm mb-1">
                        학습 현황: <span class="category-progress-number" id="marine-completed">0</span> / <span id="marine-total">0</span>
                    </p>
                    <div class="progress-bar-container">
                        <div class="progress-bar" style="width: 0%;"></div>
                    </div>
                    <p class="text-right text-base font-semibold text-blue-600 mt-1" id="marine-percentage">0%</p>
                    <p class="text-gray-600 text-sm mt-2">미학습 문제: <span id="marine-unlearned">0</span>개</p>
                </div>
            </div>
            <!-- 4과목 평균 점수 카드 -->
            <div class="mt-8">
                <div class="average-score-card">
                    <h3 class="text-xl font-bold text-gray-800 mb-2">4과목 평균 학습률</h3>
                    <p class="average-score-number" id="average-percentage">0%</p>
                    <p class="text-gray-600 text-sm">합격 커트라인: **60% 이상**</p>
                </div>
            </div>
            <!-- 커트라인 정보 추가 -->
            <div class="mt-8 space-y-4">
                <div class="cut-off-info">
                    <p class="text-lg">✅ **합격 기준:**</p>
                    <p class="text-md mt-2">과목별 커트라인: **40점 이상**</p>
                    <p class="text-md">4과목 평균 커트라인: **60점 이상**</p>
                </div>
            </div>
        </div>

        <!-- 학습 모드 선택 -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">학습 모드를 선택해주세요</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-4">
                <button onclick="ACIUApp.learning.startMode('basic')" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-4 px-6 rounded-lg">
                    기본 학습
                </button>
                <button onclick="ACIUApp.learning.startMode('layer1')" class="bg-green-500 hover:bg-green-600 text-white font-bold py-4 px-6 rounded-lg">
                    대분류 학습
                </button>
                <button onclick="ACIUApp.learning.startMode('layer2')" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-4 px-6 rounded-lg">
                    중분류 학습
                </button>
                <button onclick="ACIUApp.learning.startMode('choice')" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-4 px-6 rounded-lg">
                    선택형 학습
                </button>
                <button onclick="ACIUApp.learning.startMode('truefalse')" class="bg-red-500 hover:bg-red-600 text-white font-bold py-4 px-6 rounded-lg">
                    진위형 학습
                </button>
                <button onclick="ACIUApp.learning.startMode('mock')" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-4 px-6 rounded-lg">
                    모의고사
                </button>
            </div>
        </div>

        <!-- 기본 학습 화면 (처음에는 숨김) -->
        <div id="basic-learning-screen" class="hidden">
            <!-- 상단 네비게이션 -->
            <div class="bg-white rounded-lg shadow-lg p-4 mb-6">
                <div class="flex justify-between items-center">
                    <button onclick="ACIUApp.ui.goToHome()" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">
                        🏠 홈으로
                    </button>
                    <h2 class="text-xl font-semibold text-gray-800">기본 학습</h2>
                    <div class="text-sm text-gray-600">
                        문제 <span id="current-question-number">1</span> / <span id="total-questions">1379</span>
                    </div>
                </div>
            </div>

            <!-- 통계 자료 (더미 데이터) -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div class="bg-white rounded-lg shadow-lg p-4">
                    <h3 class="text-lg font-semibold text-gray-800 mb-2">학습 현황</h3>
                    <p class="text-2xl font-bold text-blue-600" id="learning-progress">3.3%</p>
                    <p class="text-sm text-gray-600">총 1379문제 중 45문제 완료</p>
                </div>
                <div class="bg-white rounded-lg shadow-lg p-4">
                    <h3 class="text-lg font-semibold text-gray-800 mb-2">학습 성과</h3>
                    <p class="text-2xl font-bold text-green-600" id="learning-performance">71%</p>
                    <p class="text-sm text-gray-600">풀이 45문제 중 32문제 정답</p>
                </div>
                <div class="bg-white rounded-lg shadow-lg p-4">
                    <h3 class="text-lg font-semibold text-gray-800 mb-2">오늘의 통계</h3>
                    <p class="text-2xl font-bold text-orange-600" id="today-stats">75%</p>
                    <p class="text-sm text-gray-600">오늘 8문제 풀이</p>
                </div>
            </div>

            <!-- 문제 풀이 기능 선택 -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">문제 풀이 방식 선택</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <button onclick="ACIUApp.learning.startContinue()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg">
                        이어풀기
                    </button>
                    <button onclick="ACIUApp.learning.startFromBeginning()" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg">
                        처음부터 풀기
                    </button>
                    <button onclick="ACIUApp.learning.startRandom()" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-4 rounded-lg">
                        랜덤 풀기
                    </button>
                </div>
                <div class="text-center">
                    <span class="text-sm text-gray-600">현재: 한 문제씩 풀기</span>
                </div>
            </div>

            <!-- 문제 표시 영역 -->
            <div id="question-area" class="hidden">
                <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                    <!-- 문제 정보 -->
                    <div class="mb-4 p-4 bg-gray-50 rounded-lg">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm text-gray-600" id="question-type">진위형</span>
                            <span class="text-sm text-gray-600" id="question-code">ABANK-0001</span>
                        </div>
                        <div class="text-sm text-gray-600 mb-2">
                            <span id="layer-info">06재산보험 > 화재보험</span>
                        </div>
                    </div>

                    <!-- 문제 내용 -->
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">문제</h3>
                        <p class="text-gray-700 leading-relaxed" id="question-text">
                            문제 내용이 여기에 표시됩니다.
                        </p>
                    </div>

                    <!-- 답안 선택 -->
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">답안 선택</h3>
                        <div id="answer-buttons" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <!-- 진위형 버튼 (기본) -->
                            <button onclick="ACIUApp.learning.selectAnswer('O')" class="answer-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg" data-answer="O">
                                O
                            </button>
                            <button onclick="ACIUApp.learning.selectAnswer('X')" class="answer-btn bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-lg" data-answer="X">
                                X
                            </button>
                        </div>
                    </div>

                    <!-- 결과 표시 -->
                    <div id="result-area" class="hidden mb-6">
                        <div class="p-4 rounded-lg" id="result-message">
                            <!-- 결과 메시지가 여기에 표시됩니다 -->
                        </div>
                    </div>

                    <!-- 네비게이션 버튼 -->
                    <div class="flex justify-between items-center">
                        <button onclick="ACIUApp.learning.prevQuestion()" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">
                            이전 문제
                        </button>
                        <div class="flex space-x-2">
                            <button onclick="ACIUApp.learning.checkAnswer()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">
                                정답 확인
                            </button>
                            <button onclick="ACIUApp.learning.showExplanation()" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg hidden" id="explanation-btn">
                                해설 보기
                            </button>
                        </div>
                        <button onclick="ACIUApp.learning.nextQuestion()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">
                            다음 문제
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 대분류 학습 화면 (처음에는 숨김) -->
        <div id="large-category-learning-screen" class="hidden">
            <!-- 상단 네비게이션 -->
            <div class="bg-white rounded-lg shadow-lg p-4 mb-6">
                <div class="flex justify-between items-center">
                    <button onclick="ACIUApp.ui.goToHome()" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">
                        🏠 홈으로
                    </button>
                    <h2 class="text-xl font-semibold text-gray-800">대분류 학습</h2>
                    <div class="text-sm text-gray-600">
                        선택된 대분류: <span id="selected-category">없음</span>
                    </div>
                </div>
            </div>

            <!-- 보유 문제 현황 (상세) -->
            <div class="card mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">📊 보유 문제 현황</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-center">
                    <!-- 인스교재 -->
                    <div class="p-4 bg-blue-50 rounded-lg border border-blue-200">
                        <p class="text-sm text-gray-600 mb-1">인스교재</p>
                        <p class="large-number" id="large-ins-total-count">0</p>
                        <p class="sub-text">선택형 <span id="large-ins-choice-count">0</span>개 | 진위형 <span id="large-ins-tf-count">0</span>개</p>
                    </div>
                    <!-- 보험중개사시험 -->
                    <div class="p-4 bg-green-50 rounded-lg border border-green-200">
                        <p class="text-sm text-gray-600 mb-1">보험중개사시험</p>
                        <p class="large-number" id="large-broker-total-count">0</p>
                        <p class="sub-text">진위형 <span id="large-broker-tf-count">0</span>개 | 선택형 <span id="large-broker-choice-count">0</span>개</p>
                    </div>
                    <!-- 총계 -->
                    <div class="p-4 bg-purple-50 rounded-lg border border-purple-200">
                        <p class="text-sm text-gray-600 mb-1">총계</p>
                        <p class="large-number" id="large-total-question-count">0</p>
                        <p class="sub-text">전체 문제 수</p>
                    </div>
                </div>
            </div>

            <!-- 학습 진도 현황 (대분류별) -->
            <div class="card mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">📈 학습 진도 현황 (대분류별)</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6" id="large-category-progress-display">
                    <!-- 재산보험 -->
                    <div class="category-card">
                        <h3 class="category-title mb-2">재산보험</h3>
                        <p class="text-gray-700 text-sm mb-1">
                            학습 현황: <span class="category-progress-number" id="large-prop-completed">0</span> / <span id="large-prop-total">0</span>
                        </p>
                        <div class="progress-bar-container">
                            <div class="progress-bar" style="width: 0%;"></div>
                        </div>
                        <p class="text-right text-base font-semibold text-blue-600 mt-1" id="large-prop-percentage">0%</p>
                        <p class="text-gray-600 text-sm mt-2">미학습 문제: <span id="large-prop-unlearned">0</span>개</p>
                    </div>
                    <!-- 특종보험 -->
                    <div class="category-card">
                        <h3 class="category-title mb-2">특종보험</h3>
                        <p class="text-gray-700 text-sm mb-1">
                            학습 현황: <span class="category-progress-number" id="spec-completed">0</span> / <span id="spec-total">0</span>
                        </p>
                        <div class="progress-bar-container">
                            <div class="progress-bar" style="width: 0%;"></div>
                        </div>
                        <p class="text-right text-base font-semibold text-blue-600 mt-1" id="spec-percentage">0%</p>
                        <p class="text-gray-600 text-sm mt-2">미학습 문제: <span id="spec-unlearned">0</span>개</p>
                    </div>
                    <!-- 배상책임보험 -->
                    <div class="category-card">
                        <h3 class="category-title mb-2">배상책임보험</h3>
                        <p class="text-gray-700 text-sm mb-1">
                            학습 현황: <span class="category-progress-number" id="liab-completed">0</span> / <span id="liab-total">0</span>
                        </p>
                        <div class="progress-bar-container">
                            <div class="progress-bar" style="width: 0%;"></div>
                        </div>
                        <p class="text-right text-base font-semibold text-blue-600 mt-1" id="liab-percentage">0%</p>
                        <p class="text-gray-600 text-sm mt-2">미학습 문제: <span id="liab-unlearned">0</span>개</p>
                    </div>
                    <!-- 해상보험 -->
                    <div class="category-card">
                        <h3 class="category-title mb-2">해상보험</h3>
                        <p class="text-gray-700 text-sm mb-1">
                            학습 현황: <span class="category-progress-number" id="marine-completed">0</span> / <span id="marine-total">0</span>
                        </p>
                        <div class="progress-bar-container">
                            <div class="progress-bar" style="width: 0%;"></div>
                        </div>
                        <p class="text-right text-base font-semibold text-blue-600 mt-1" id="marine-percentage">0%</p>
                        <p class="text-gray-600 text-sm mt-2">미학습 문제: <span id="marine-unlearned">0</span>개</p>
                    </div>
                </div>
                <!-- 4과목 평균 점수 카드 -->
                <div class="mt-8">
                    <div class="average-score-card">
                        <h3 class="text-xl font-bold text-gray-800 mb-2">4과목 평균 학습률</h3>
                        <p class="average-score-number" id="large-average-percentage">0%</p>
                        <p class="text-gray-600 text-sm">합격 커트라인: **60% 이상**</p>
                    </div>
                </div>
                <!-- 커트라인 정보 추가 -->
                <div class="mt-8 space-y-4">
                    <div class="cut-off-info">
                        <p class="text-lg">✅ **합격 기준:**</p>
                        <p class="text-md mt-2">과목별 커트라인: **40점 이상**</p>
                        <p class="text-md">4과목 평균 커트라인: **60점 이상**</p>
                    </div>
                </div>
            </div>

            <!-- 대분류 선택 -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">대분류 선택</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4" id="large-category-buttons-container">
                    <!-- 대분류 버튼들이 여기에 동적으로 생성됩니다. -->
                </div>
            </div>

            <!-- 문제 표시 영역 (대분류 선택 후 표시) -->
            <div id="large-category-question-area" class="hidden">
                <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                    <!-- 문제 정보 -->
                    <div class="mb-4 p-4 bg-gray-50 rounded-lg">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm text-gray-600" id="large-category-question-type">진위형</span>
                            <span class="text-sm text-gray-600" id="large-category-question-code">ABANK-0001</span>
                        </div>
                        <div class="text-sm text-gray-600 mb-2">
                            <span id="large-category-layer-info">06재산보험 > 화재보험</span>
                        </div>
                    </div>

                    <!-- 문제 내용 -->
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">문제</h3>
                        <p class="text-gray-700 leading-relaxed" id="large-category-question-text">
                            대분류를 선택하면 문제가 표시됩니다.
                        </p>
                    </div>

                    <!-- 답안 선택 -->
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">답안 선택</h3>
                        <div id="large-category-answer-buttons" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <!-- 동적으로 생성될 답안 버튼들 -->
                        </div>
                    </div>

                    <!-- 결과 표시 -->
                    <div id="large-category-result-area" class="hidden mb-6">
                        <div class="p-4 rounded-lg" id="large-category-result-message">
                            <!-- 결과 메시지가 여기에 표시됩니다 -->
                        </div>
                    </div>

                    <!-- 네비게이션 버튼 -->
                    <div class="flex justify-between items-center">
                        <button onclick="ACIUApp.learning.prevQuestion('large')" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">
                            이전 문제
                        </button>
                        <div class="flex space-x-2">
                            <button onclick="ACIUApp.learning.checkAnswer('large')" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">
                                정답 확인
                            </button>
                            <button onclick="ACIUApp.learning.showExplanation('large')" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg hidden" id="large-category-explanation-btn">
                                해설 보기
                            </button>
                        </div>
                        <button onclick="ACIUApp.learning.nextQuestion('large')" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">
                            다음 문제
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 중분류 학습 화면 (처음에는 숨김) -->
        <div id="mid-category-learning-screen" class="hidden">
            <!-- 상단 네비게이션 -->
            <div class="bg-white rounded-lg shadow-lg p-4 mb-6">
                <div class="flex justify-between items-center">
                    <button onclick="ACIUApp.ui.goToHome()" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">
                        🏠 홈으로
                    </button>
                    <h2 class="text-xl font-semibold text-gray-800">중분류 학습</h2>
                    <div class="text-sm text-gray-600">
                        선택된 대분류: <span id="selected-large-category">없음</span> | 
                        선택된 중분류: <span id="selected-mid-category">없음</span>
                    </div>
                </div>
            </div>

            <!-- 중분류 선택 영역 -->
            <div id="mid-category-selection-area" class="category-section"> <!-- ID 변경 -->
                <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">중분류 선택</h3>
                    
                    <!-- 메인 카테고리 버튼들 -->
                    <div class="main-category-buttons" id="mid-main-category-buttons"> <!-- ID 추가 -->
                        <!-- 동적 생성: 메인 카테고리 + 기타 버튼 -->
                    </div>
                    
                    <!-- 기타 카테고리 상세 (토글 방식) -->
                    <div id="other-categories-detail" class="other-category-section" style="max-height:0;"> <!-- style="display:none;" -> style="max-height:0;" -->
                        <h4 class="text-lg font-semibold text-gray-700 mb-3">기타 세부 분류</h4>
                        <div class="other-category-buttons" id="mid-other-category-buttons"> <!-- ID 추가 -->
                            <!-- 동적 생성: 기타 세부 카테고리들 -->
                        </div>
                        <button onclick="ACIUApp.ui.categorySelection.toggleOtherCategories()" class="close-other-btn bg-gray-300 hover:bg-gray-400 text-gray-700 font-bold py-2 px-4 rounded-lg">
                            접기
                        </button>
                    </div>
                </div>
            </div>

            <!-- 문제 표시 영역 (처음에는 숨김) -->
            <div id="mid-category-question-area" class="hidden">
                <!-- 문제 내용 -->
                <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                    <div class="mb-4">
                        <div class="text-sm text-gray-600 mb-2">
                            문제 <span id="mid-category-question-number">1</span> / <span id="mid-category-total-questions">0</span>
                        </div>
                        <div class="text-lg font-semibold text-gray-800 mb-4" id="mid-category-question-text">
                            <!-- 문제 텍스트가 여기에 표시됩니다 -->
                        </div>
                    </div>

                    <!-- 답안 선택 영역 -->
                    <div id="mid-category-answer-buttons" class="mb-6">
                        <!-- 동적으로 생성되는 답안 버튼들 -->
                    </div>

                    <!-- 결과 표시 -->
                    <div id="mid-category-result-area" class="hidden mb-6">
                        <div class="p-4 rounded-lg" id="mid-category-result-message">
                            <!-- 결과 메시지가 여기에 표시됩니다 -->
                        </div>
                    </div>

                    <!-- 네비게이션 버튼 -->
                    <div class="flex justify-between items-center">
                        <button onclick="ACIUApp.learning.prevQuestion('mid')" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">
                            이전 문제
                        </button>
                        <div class="flex space-x-2">
                            <button onclick="ACIUApp.learning.checkAnswer('mid')" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">
                                정답 확인
                            </button>
                            <button onclick="ACIUApp.learning.showExplanation('mid')" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg hidden" id="mid-category-explanation-btn">
                                해설 보기
                            </button>
                        </div>
                        <button onclick="ACIUApp.learning.nextQuestion('mid')" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">
                            다음 문제
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 통계 데이터 불러오기 버튼 -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <div class="text-center">
                <button onclick="ACIUApp.ui.loadStatisticsData()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-8 rounded-lg text-lg">
                    📊 통계 데이터 불러오기
                </button>
                <p class="text-sm text-gray-600 mt-2">버튼을 클릭하면 현재상태 총괄이 표시됩니다</p>
            </div>
        </div>

        <!-- 통계 섹션 (초기 숨김) -->
        <div id="statistics-section" class="hidden">
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">현재상태 총괄</h2>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- 과목별 점수 카드 -->
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">과목별 점수</h3>
                        <div class="space-y-2" id="subject-cards">
                            <!-- 동적으로 생성될 과목별 카드들 -->
                        </div>
                    </div>
                    
                    <!-- 전체 요약 카드 -->
                    <div class="bg-blue-50 rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">전체 요약</h3>
                        <div class="space-y-3" id="summary-cards">
                            <!-- 동적으로 생성될 요약 카드들 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 설정 모달 -->
    <div id="settings-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-96">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">설정</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">사용자명</label>
                    <input type="text" id="user-name-input" class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="사용자명을 입력하세요">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">시험 날짜</label>
                    <input type="date" id="exam-date-input" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
                <div class="flex space-x-2">
                    <button onclick="ACIUApp.ui.saveSettings()" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">
                        저장
                    </button>
                    <button onclick="ACIUApp.ui.hideSettingsModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded">
                        취소
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 오류 메시지 모달 -->
    <div id="error-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-96 text-center">
            <h3 class="text-lg font-semibold text-red-600 mb-4">오류 발생!</h3>
            <p id="error-message-text" class="text-gray-700 mb-6">오류 메시지</p>
            <button onclick="ACIUApp.ui.hideErrorMessage()" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded">
                확인
            </button>
        </div>
    </div>

    <script>
        // ACIUApp 네임스페이스 구조
        const ACIUApp = {
            // 타이머 관리
            timers: {
                timeUpdate: null,
                quoteUpdate: null,
                ddayUpdate: null
            },

            // 브라우저 호환성 확인
            compatibility: {
                checkBrowserSupport() {
                    if (!window.localStorage) {
                        this.showErrorMessage('localStorage를 지원하지 않는 브라우저입니다.');
                        return false;
                    }
                    return true;
                }
            },

            // 데이터 관리
            data: {
                questions: [],
                userSettings: {
                    name: '조대표님',
                    examDate: '2025-10-25',
                    lastUpdated: new Date().toISOString()
                },
                learningHistory: {
                    attempts: {}, // attempts는 객체로 QCODE를 키로 가짐
                    lastUpdated: new Date().toISOString()
                },
                
                // 중분류 학습용 데이터 구조 (노팀장 확정)
                mainCategories: {
                    '06재산보험': [
                        { name: '화재보험', count: 188 },
                        { name: '재물보험재보험', count: 130 },
                        { name: '패키지보험', count: 53 }
                    ],
                    '07특종보험': [
                        { name: '미확인', count: 110 },
                        { name: '기술보험', count: 93 },
                        { name: '범죄보험', count: 51 }
                    ],
                    '08배상책임보험': [], // 50문제 이상 없음
                    '09해상보험': [
                        { name: '미확인', count: 165 },
                        { name: '해상보험조건과보상범위', count: 57 },
                        { name: '해상보험의손해사정', count: 53 }
                    ]
                },
                
                otherCategories: {
                    '06재산보험': [
                        { name: '동산종합보험', count: 15 },
                        { name: '기업휴지보험', count: 8 },
                        { name: '재물보험', count: 5 }
                    ],
                    '07특종보험': [
                        { name: '기타특종보험', count: 26 },
                        { name: '종합보험', count: 8 },
                        { name: '개요', count: 4 }
                    ],
                    '08배상책임보험': [
                        { name: '보관자배상책임', count: 49 },
                        { name: '전문직업배상', count: 47 },
                        { name: '개요', count: 37 },
                        { name: '도급업자배상책임', count: 33 },
                        { name: '임원배상', count: 32 },
                        { name: '시설소유관리자', count: 26 },
                        { name: '생산물배상책임', count: 24 },
                        { name: '기타주요보험', count: 20 }
                    ],
                    '09해상보험': [
                        { name: '적하보험', count: 42 },
                        { name: '해상보험기초', count: 33 },
                        { name: '계약의 체결과 보험료', count: 23 },
                        { name: '선박보험', count: 23 },
                        { name: '운송보험', count: 20 },
                        { name: '해상보험조건', count: 4 }
                    ]
                }
            },

            // CSV 데이터 로딩
            async loadQuestions() {
                try {
                    const response = await fetch('ins_master_db.csv');
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const csvContent = await response.text();
                    
                    const parsed = Papa.parse(csvContent, {
                        header: true,
                        dynamicTyping: false,
                        skipEmptyLines: true,
                        delimiter: ',',
                        quoteChar: '"',
                        fastMode: true
                    });

                    // 필터링: QCODE가 있고 SOURCE가 '인스교재' 또는 '중개사시험'인 경우
                    this.questions = parsed.data.filter(row =>
                        row.QCODE && 
                        (row.SOURCE === '인스교재' || row.SOURCE === '중개사시험')
                    );

                    console.log(`데이터 로딩 완료: ${this.questions.length}개 문제`);
                    
                    // 데이터 로딩 완료 후 UI 업데이트
                    ACIUApp.ui.updateQuestionCounts();
                    ACIUApp.ui.updateStatistics();
                    ACIUApp.ui.updateLargeCategoryStats(); // 대분류 통계도 업데이트
                } catch (error) {
                    console.error('데이터 로딩 실패:', error);
                    ACIUApp.ui.showErrorMessage('데이터를 불러오는데 실패했습니다. 파일 경로를 확인해주세요.');
                }
            },

            // 사용자 설정 로딩
            loadUserSettings() {
                try {
                    const saved = localStorage.getItem('aciu_user_settings');
                    if (saved) {
                        this.userSettings = { ...this.userSettings, ...JSON.parse(saved) };
                    }
                } catch (error) {
                    console.error('사용자 설정 로딩 실패:', error);
                }
            },

            // 사용자 설정 저장
            saveUserSettings() {
                try {
                    localStorage.setItem('aciu_user_settings', JSON.stringify(this.userSettings));
                } catch (error) {
                    console.error('사용자 설정 저장 실패:', error);
                }
            },

            // 학습 이력 로딩
            loadLearningHistory() {
                try {
                    const saved = localStorage.getItem('aciu_learning_history');
                    if (saved) {
                        this.learningHistory = { ...this.learningHistory, ...JSON.parse(saved) };
                    }
                } catch (error) {
                    console.error('학습 이력 로딩 실패:', error);
                }
            }
        },

        // UI 관리
        ui: {
            // 초기화
            init() {
                this.updateHeader();
                this.updateQuestionCounts();
                this.updateStatistics();
                this.updateQuote();
                this.updateCurrentTime();
                this.updateDdayCount();
                this.updateLargeCategoryStats(); // 초기 로딩 시 대분류 통계도 업데이트
            },

            // 헤더 업데이트
            updateHeader() {
                const userInfo = document.getElementById('user-info');
                const examDday = document.getElementById('exam-dday');
                
                userInfo.textContent = `사용자: ${ACIUApp.data.userSettings.name}`;
                
                const examDate = new Date(ACIUApp.data.userSettings.examDate);
                const today = new Date();
                const diffTime = examDate.getTime() - today.getTime();
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                examDday.textContent = `D-${Math.max(0, diffDays)}일`;
            },

            // 소스별 문제 수 업데이트
            updateQuestionCounts() {
                const questions = ACIUApp.data.questions;
                
                // 소스별 문제 수 계산
                const insQuestions = questions.filter(q => q.SOURCE === '인스교재').length;
                const examQuestions = questions.filter(q => q.SOURCE === '중개사시험').length;
                const totalQuestions = questions.length;
                
                // UI 업데이트
                document.getElementById('ins-total-count').textContent = insQuestions.toLocaleString();
                document.getElementById('ins-choice-count').textContent = questions.filter(q => q.SOURCE === '인스교재' && q.TYPE === '선택형').length;
                document.getElementById('ins-tf-count').textContent = questions.filter(q => q.SOURCE === '인스교재' && q.TYPE === '진위형').length;

                document.getElementById('broker-total-count').textContent = examQuestions.toLocaleString();
                document.getElementById('broker-tf-count').textContent = questions.filter(q => q.SOURCE === '중개사시험' && q.TYPE === '진위형').length;
                document.getElementById('broker-choice-count').textContent = questions.filter(q => q.SOURCE === '중개사시험' && q.TYPE === '선택형').length;

                document.getElementById('total-question-count').textContent = totalQuestions.toLocaleString();
            },

            // 통계 업데이트 (메인 대문용)
            updateStatistics() {
                const totalQuestions = ACIUApp.data.questions.length;
                const solvedQcodes = new Set(Object.keys(ACIUApp.data.learningHistory.attempts));
                const overallRate = totalQuestions > 0 ? Math.round((solvedQcodes.size / totalQuestions) * 100) : 0;
                
                // 일일 진도율
                const today = new Date().toISOString().slice(0, 10);
                const todayData = Object.values(ACIUApp.data.learningHistory.attempts)
                    .filter(attempt => attempt.timestamp.slice(0, 10) === today);
                const todaySolved = todayData.length;
                const todayCorrect = todayData.filter(attempt => attempt.isCorrect).length; // isCorrect 필드 사용
                const dailyRate = todaySolved > 0 ? Math.round((todayCorrect / todaySolved) * 100) : 0;
                
                // UI 업데이트
                document.getElementById('completed-questions').textContent = solvedQcodes.size.toLocaleString();
                document.getElementById('overall-progress-rate').textContent = `${overallRate}%`;
                document.getElementById('daily-progress-rate').textContent = `${dailyRate}%`;
            },

            // 대분류 학습 통계 업데이트 (statistics1.html 포맷 통합)
            updateLargeCategoryStats() {
                const categories = ['06재산보험', '07특종보험', '08배상책임보험', '09해상보험'];
                
                // 실제 데이터 기반 통계 계산
                const categoryProgress = {};
                categories.forEach(catCode => {
                    // 해당 대분류의 총 문제 수
                    const totalQuestionsInCat = ACIUApp.data.questions.filter(q => q.LAYER1 === catCode).length;
                    
                    // 해당 대분류의 완료된 문제 수 (학습 이력에서 계산)
                    // ACIUApp.data.learningHistory.attempts는 객체이므로 Object.values로 배열화 후 필터링
                    const completedQuestionsInCat = Object.values(ACIUApp.data.learningHistory.attempts).filter(attempt => {
                        // 각 시도(attempt)의 layer1이 현재 catCode와 일치하는지 확인
                        return attempt.layer1 === catCode;
                    }).length;
                    
                    const unlearnedQuestionsInCat = totalQuestionsInCat - completedQuestionsInCat;
                    const percentage = totalQuestionsInCat > 0 ? Math.round((completedQuestionsInCat / totalQuestionsInCat) * 100) : 0;
                    
                    categoryProgress[catCode] = {
                        total: totalQuestionsInCat,
                        completed: completedQuestionsInCat,
                        unlearned: unlearnedQuestionsInCat,
                        percentage: percentage
                    };
                });

                categories.forEach(catCode => {
                    const categoryName = catCode.substring(2); // '06재산보험' -> '재산보험'
                    const data = categoryProgress[catCode];
                    if (data) {
                        const prefix = {
                            '06재산보험': 'prop', '07특종보험': 'spec',
                            '08배상책임보험': 'liab', '09해상보험': 'marine'
                        }[catCode];

                        // Ensure elements exist before updating
                        const completedElem = document.getElementById(`${prefix}-completed`);
                        const totalElem = document.getElementById(`${prefix}-total`);
                        const unlearnedElem = document.getElementById(`${prefix}-unlearned`);
                        const percentageElem = document.getElementById(`${prefix}-percentage`);
                        const progressBar = completedElem ? completedElem.closest('.category-card')?.querySelector('.progress-bar') : null;

                        if (completedElem) completedElem.textContent = data.completed;
                        if (totalElem) totalElem.textContent = data.total;
                        if (unlearnedElem) unlearnedElem.textContent = data.unlearned;
                        if (percentageElem) percentageElem.textContent = `${data.percentage}%`;
                        if (progressBar) progressBar.style.width = `${data.percentage}%`;
                    }
                });

                // 4과목 평균 학습률 계산 및 업데이트
                let totalPercentage = 0;
                let categoryCount = 0;
                for (const catCode in categoryProgress) { // 더미 대신 실제 categoryProgress 사용
                    if (categoryProgress.hasOwnProperty(catCode)) {
                        totalPercentage += categoryProgress[catCode].percentage;
                        categoryCount++;
                    }
                }
                const average = categoryCount > 0 ? (totalPercentage / categoryCount).toFixed(2) : 0;
                // Ensure element exists before updating
                const largeAveragePercentageElem = document.getElementById('large-average-percentage');
                if (largeAveragePercentageElem) {
                    largeAveragePercentageElem.textContent = `${average}%`;
                }
            },

            // 현재 시간 업데이트
            updateCurrentTime() {
                const now = new Date();
                const timeString = now.toLocaleString('ko-KR', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    weekday: 'long',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: true
                });
                document.getElementById('current-time').textContent = timeString;
            },

            // D-Day 업데이트
            updateDdayCount() {
                const examDate = new Date(ACIUApp.data.userSettings.examDate);
                const today = new Date();
                const diffTime = examDate.getTime() - today.getTime();
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                document.getElementById('exam-dday').textContent = `D-${Math.max(0, diffDays)}일`;
            },

            // 명언 업데이트
            updateQuote() {
                const quotes = [
                    "학습은 가장 좋은 투자입니다.",
                    "꾸준함이 최고의 재능입니다.",
                    "오늘의 노력이 내일의 성공을 만듭니다.",
                    "실패는 성공의 어머니입니다.",
                    "작은 진전도 큰 성취의 시작입니다.",
                    "끝까지 가는 자가 이긴다.",
                    "자신을 믿어라, 당신은 할 수 있다.",
                    "시간은 가장 귀중한 자산입니다.",
                    "목표를 향해 한 걸음씩 나아가라.",
                    "배움에는 끝이 없다."
                ];
                
                const randomQuote = quotes[Math.floor(Math.random() * quotes.length)];
                document.getElementById('quote-of-day').textContent = `"${randomQuote}"`;
            },

            // 설정 모달 표시
            showSettingsModal() {
                document.getElementById('user-name-input').value = ACIUApp.data.userSettings.name;
                document.getElementById('exam-date-input').value = ACIUApp.data.userSettings.examDate;
                document.getElementById('settings-modal').classList.remove('hidden');
            },

            // 설정 모달 숨기기
            hideSettingsModal() {
                document.getElementById('settings-modal').classList.add('hidden');
            },

            // 설정 저장
            saveSettings() {
                const name = document.getElementById('user-name-input').value.trim();
                const examDate = document.getElementById('exam-date-input').value;
                
                if (name) {
                    ACIUApp.data.userSettings.name = name;
                }
                if (examDate) {
                    ACIUApp.data.userSettings.examDate = examDate;
                }
                
                ACIUApp.data.userSettings.lastUpdated = new Date().toISOString();
                ACIUApp.data.saveUserSettings();
                this.updateHeader();
                this.hideSettingsModal();
            },

            // 통계 데이터 불러오기 (메인 화면에서 통계 섹션 토글)
            loadStatisticsData() {
                console.log('통계 데이터 불러오기 시작');
                
                const statsSection = document.getElementById('statistics-section');
                if (statsSection.classList.contains('hidden')) {
                    statsSection.classList.remove('hidden');
                    this.updateSubjectCards();
                    this.updateSummaryCards();
                } else {
                    statsSection.classList.add('hidden');
                }
                
                console.log('통계 데이터 불러오기 완료');
            },

            // 과목별 점수 카드 업데이트 (더미 데이터 적용)
            updateSubjectCards() {
                const subjects = ['06재산보험', '07특종보험', '08배상책임보험', '09해상보험'];
                const scores = [55, 65, 67, 30]; // 더미 점수
                const subjectCards = document.getElementById('subject-cards');
                subjectCards.innerHTML = '';
                
                subjects.forEach((subject, index) => {
                    const score = scores[index];
                    const isPass = score >= 40;
                    const card = document.createElement('div');
                    card.className = 'flex justify-between items-center p-2 bg-white rounded border';
                    card.innerHTML = `
                        <div class="flex-1">
                            <div class="font-medium text-sm">${subject}</div>
                            <div class="text-xs text-gray-500">기준: 40점</div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold ${isPass ? 'text-green-600' : 'text-red-600'}">${score}점</div>
                            <div class="text-xs ${isPass ? 'text-green-600' : 'text-red-600'}">${isPass ? '합격' : '불합격'}</div>
                        </div>
                    `;
                    subjectCards.appendChild(card);
                });
            },

            // 전체 요약 카드 업데이트 (더미 데이터 적용)
            updateSummaryCards() {
                const scores = [55, 65, 67, 30]; // 더미 점수
                const overallScore = Math.round(scores.reduce((a, b) => a + b, 0) / scores.length);
                const lowestScore = Math.min(...scores);
                const isPass = overallScore >= 60 && lowestScore >= 40;
                
                const summaryCards = document.getElementById('summary-cards');
                summaryCards.innerHTML = '';
                
                // 평균 점수 카드
                const isAvgPass = overallScore >= 60;
                const avgCard = document.createElement('div');
                avgCard.className = 'flex justify-between items-center p-3 bg-white rounded border';
                avgCard.innerHTML = `
                    <div class="flex-1">
                        <div class="font-semibold">평균점수</div>
                        <div class="text-xs text-gray-500">기준: 60점</div>
                    </div>
                    <div class="text-right">
                        <div class="text-lg font-bold ${isAvgPass ? 'text-green-600' : 'text-red-600'}">${overallScore}점</div>
                        <div class="text-xs ${isAvgPass ? 'text-green-600' : 'text-red-600'}">${isAvgPass ? '합격' : '불합격'}</div>
                    </div>
                `;
                summaryCards.appendChild(avgCard);
                
                // 최종 합격 여부 카드
                const finalCard = document.createElement('div');
                finalCard.className = `flex justify-between items-center p-3 rounded border ${isPass ? 'bg-green-100 border-green-300' : 'bg-red-100 border-red-300'}`;
                finalCard.innerHTML = `
                    <div class="flex-1">
                        <div class="font-bold">최종합격여부</div>
                        <div class="text-xs text-gray-500">모든 조건 만족</div>
                    </div>
                    <div class="text-right">
                        <div class="text-lg font-bold ${isPass ? 'text-green-600' : 'text-red-600'}">${isPass ? '합격' : '불합격'}</div>
                        <div class="text-xs ${isPass ? 'text-green-600' : 'text-red-600'}">${isPass ? '🎉' : '⚠️'}</div>
                    </div>
                `;
                summaryCards.appendChild(finalCard);
            },

            // 오류 메시지 표시 (alert 대신 모달 사용)
            showErrorMessage(message) {
                const errorModal = document.getElementById('error-modal');
                const errorMessageText = document.getElementById('error-message-text');
                if (errorMessageText) { // Ensure element exists
                    errorMessageText.textContent = message;
                }
                if (errorModal) { // Ensure element exists
                    errorModal.classList.remove('hidden');
                }
            },
            hideErrorMessage() {
                const errorModal = document.getElementById('error-modal');
                if (errorModal) { // Ensure element exists
                    errorModal.classList.add('hidden');
                }
            },

            // 모든 화면 숨기기
            hideAllScreens() {
                document.getElementById('basic-learning-screen').classList.add('hidden');
                document.getElementById('large-category-learning-screen').classList.add('hidden');
                document.getElementById('mid-category-learning-screen').classList.add('hidden');
            },

            // 홈으로 돌아가기
            goToHome() {
                console.log('홈으로 돌아가기');
                this.hideAllScreens();
                document.getElementById('current-mode').textContent = '모드 선택';
                // Reset category selection state when going home
                ACIUApp.ui.categorySelection.selectedLargeCategory = null;
                ACIUApp.ui.categorySelection.selectedMidCategory = null;
                ACIUApp.ui.categorySelection.isOtherCategoryOpen = false;
                ACIUApp.ui.categorySelection.saveState(); // Save cleared state
            },

            // 중분류 선택 관리자
            categorySelection: {
                selectedLargeCategory: null,
                selectedMidCategory: null,
                isOtherCategoryOpen: false,
                
                // 대분류 선택 시 중분류 표시 (중분류 학습 화면 내 1단계)
                showMidCategories(largeCategoryCode) { // 인자 이름을 largeCategoryCode로 변경
                    console.log(`중분류 학습 화면 - 대분류 선택: ${largeCategoryCode}`);
                    this.selectedLargeCategory = largeCategoryCode;
                    this.selectedMidCategory = null;
                    this.isOtherCategoryOpen = false;
                    
                    const container = document.getElementById('mid-main-category-buttons');
                    if (!container) {
                        console.error("Error: mid-main-category-buttons container not found.");
                        return;
                    }
                    container.innerHTML = ''; // 기존 버튼 초기화
                    
                    // '08배상책임보험' 특수 케이스 처리
                    if (largeCategoryCode === '08배상책임보험') {
                        // 메인 중분류가 없으므로 기타 세부분류만 표시
                        const otherCats = ACIUApp.data.otherCategories[largeCategoryCode] || [];
                        if (otherCats.length > 0) {
                            const otherCount = otherCats.reduce((sum, cat) => sum + cat.count, 0);
                            const otherButton = this.createOtherButton(otherCount, largeCategoryCode);
                            container.appendChild(otherButton);
                        } else {
                            // 배상책임보험에 기타 문제도 없는 경우
                            ACIUApp.ui.showErrorMessage(`"${largeCategoryCode.substring(2)}" 카테고리에는 현재 문제가 없습니다.`);
                        }
                    } else {
                        // 일반적인 경우: 메인 중분류 버튼들 생성
                        const mainCats = ACIUApp.data.mainCategories[largeCategoryCode] || [];
                        mainCats.forEach(cat => {
                            const button = this.createMainCategoryButton(cat.name, cat.count, largeCategoryCode); // largeCategoryCode 전달
                            container.appendChild(button);
                        });
                        
                        // 기타 버튼 생성 (기타 카테고리가 있는 경우)
                        const otherCats = ACIUApp.data.otherCategories[largeCategoryCode] || [];
                        if (otherCats.length > 0) {
                            const otherCount = otherCats.reduce((sum, cat) => sum + cat.count, 0);
                            const otherButton = this.createOtherButton(otherCount, largeCategoryCode); // largeCategoryCode 전달
                            container.appendChild(otherButton);
                        } else if (mainCats.length === 0) {
                             // 메인도 기타도 없는 경우
                            ACIUApp.ui.showErrorMessage(`"${largeCategoryCode.substring(2)}" 카테고리에는 현재 문제가 없습니다.`);
                        }
                    }
                    
                    // 기타 카테고리 상세는 숨김
                    document.getElementById('other-categories-detail').style.maxHeight = '0px'; // display:none 대신 maxHeight 사용

                    this.updateBreadcrumb(); // 브레드크럼 업데이트
                    this.saveState(); // 상태 저장
                },
                
                // 메인 중분류 버튼 생성
                createMainCategoryButton(name, count, largeCategoryCode) { // largeCategoryCode 인자 추가
                    const button = document.createElement('button');
                    button.className = 'main-category-button';
                    
                    // '미확인' 카테고리 네이밍 변경
                    const displayName = name === '미확인' ? '미분류' : name;
                    
                    button.innerHTML = `
                        ${displayName}
                        <span class="category-count">(${count}문제)</span>
                    `;
                    button.onclick = () => this.selectMidCategory(name, largeCategoryCode); // largeCategoryCode 전달
                    return button;
                },
                
                // 기타 버튼 생성
                createOtherButton(totalCount, largeCategoryCode) { // largeCategoryCode 인자 추가
                    const button = document.createElement('button');
                    button.className = 'main-category-button other-button';
                    button.innerHTML = `
                        기타 세부분류
                        <span class="category-count">(${totalCount}문제)</span>
                    `;
                    button.onclick = () => this.toggleOtherCategories(largeCategoryCode); // largeCategoryCode 전달
                    return button;
                },
                
                // 기타 카테고리 토글
                toggleOtherCategories(largeCategoryCode) { // largeCategoryCode 인자 추가
                    this.isOtherCategoryOpen = !this.isOtherCategoryOpen;
                    const detailSection = document.getElementById('other-categories-detail');
                    
                    if (this.isOtherCategoryOpen) {
                        this.showOtherCategoriesDetail(largeCategoryCode); // largeCategoryCode 전달
                        detailSection.style.maxHeight = '500px'; // 충분한 높이로 펼치기
                    } else {
                        detailSection.style.maxHeight = '0px'; // 접기
                    }
                },
                
                // 기타 카테고리 상세 표시
                showOtherCategoriesDetail(largeCategoryCode) { // largeCategoryCode 인자 추가
                    const container = document.getElementById('mid-other-category-buttons');
                    if (!container) {
                        console.error("Error: mid-other-category-buttons container not found.");
                        return;
                    }
                    container.innerHTML = '';
                    
                    const otherCats = ACIUApp.data.otherCategories[largeCategoryCode] || []; // largeCategoryCode 사용
                    otherCats.forEach(cat => {
                        const button = document.createElement('button');
                        button.className = 'other-category-button';
                        
                        // '미확인' 카테고리 네이밍 변경
                        const displayName = cat.name === '미확인' ? '미분류' : cat.name;
                        
                        button.innerHTML = `${displayName} (${cat.count})`;
                        button.onclick = () => this.selectMidCategory(cat.name, largeCategoryCode); // largeCategoryCode 전달
                        container.appendChild(button);
                    });
                },
                
                // 중분류 선택 처리 (중분류 학습 화면 내 2단계)
                selectMidCategory(midCategoryName, largeCategoryCode) { // largeCategoryCode 인자 추가
                    console.log(`중분류 선택: ${largeCategoryCode} > ${midCategoryName}`);
                    this.selectedMidCategory = midCategoryName;
                    // this.selectedLargeCategory는 showMidCategories에서 이미 설정됨
                    this.updateButtonStates();
                    this.updateBreadcrumb();
                    this.startQuestionMode();
                    this.saveState(); // 상태 저장
                },
                
                // 버튼 상태 업데이트
                updateButtonStates() {
                    // 모든 버튼의 active 클래스 제거
                    document.querySelectorAll('.main-category-button, .other-category-button').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    
                    // 선택된 버튼 활성화
                    // 텍스트 내용으로 버튼을 찾는 대신, data-category 속성을 활용하거나 더 정확한 방법으로 찾기
                    // 현재는 텍스트 포함 여부로 찾기 유지 (향후 data-category 속성 활용으로 개선 가능)
                    const selectedBtn = Array.from(document.querySelectorAll('.main-category-button, .other-category-button'))
                        .find(btn => btn.textContent.includes(this.selectedMidCategory)); 
                    if (selectedBtn) {
                        selectedBtn.classList.add('active');
                    }
                },
                
                // 브레드크럼 업데이트
                updateBreadcrumb() {
                    const largeCatDisplay = this.selectedLargeCategory ? this.selectedLargeCategory.substring(2) : '없음';
                    const midCatDisplay = this.selectedMidCategory || '없음';
                    document.getElementById('selected-large-category').textContent = largeCatDisplay;
                    document.getElementById('selected-mid-category').textContent = midCatDisplay;

                    // 문제 진행률 표시 (중분류 모드에서만)
                    // 이 브레드크럼은 중분류 학습 화면 상단에 직접 표시되므로, 일반 category-path와 분리
                    const midCategoryQuestionNumberElem = document.getElementById('mid-category-question-number');
                    const midCategoryTotalQuestionsElem = document.getElementById('mid-category-total-questions');

                    if (ACIUApp.learning.currentMode === 'layer2' && ACIUApp.learning.filteredQuestions.length > 0) {
                        const current = ACIUApp.learning.currentQuestionIndex + 1;
                        const total = ACIUApp.learning.filteredQuestions.length;
                        if (midCategoryQuestionNumberElem) midCategoryQuestionNumberElem.textContent = current;
                        if (midCategoryTotalQuestionsElem) midCategoryTotalQuestionsElem.textContent = total;
                    } else {
                        if (midCategoryQuestionNumberElem) midCategoryQuestionNumberElem.textContent = '0';
                        if (midCategoryTotalQuestionsElem) midCategoryTotalQuestionsElem.textContent = '0';
                    }
                },
                
                // 문제 모드 시작
                startQuestionMode() {
                    console.log('중분류 학습 - 문제 모드 시작');
                    // 문제 표시 영역 표시
                    document.getElementById('mid-category-question-area').classList.remove('hidden');
                    
                    // 더미 문제 생성 및 표시
                    ACIUApp.learning.loadDummyQuestionsForMidCategory(this.selectedLargeCategory, this.selectedMidCategory);
                },

                // 상태 저장/복원 (대분류만 복원)
                saveState() {
                    const state = {
                        largeCategory: this.selectedLargeCategory,
                        // midCategory와 questionIndex는 복원하지 않음 (조대표님 지시)
                    };
                    try {
                        localStorage.setItem('aciu_mid_category_state', JSON.stringify(state));
                        console.log('중분류 학습 상태 저장됨:', state);
                    } catch (e) {
                        console.error('중분류 학습 상태 저장 실패:', e);
                    }
                },
                
                restoreState() {
                    try {
                        const state = JSON.parse(localStorage.getItem('aciu_mid_category_state'));
                        if (state && state.largeCategory) {
                            console.log('중분류 학습 상태 복원 시도:', state);
                            this.selectedLargeCategory = state.largeCategory;
                            this.selectedMidCategory = null; // 중분류는 초기화
                            this.isOtherCategoryOpen = false; // 기타 카테고리도 초기화

                            // 대분류 버튼들을 다시 생성하여 UI에 표시
                            const container = document.getElementById('mid-main-category-buttons');
                            if (container) {
                                container.innerHTML = '';
                                const largeCategories = ['06재산보험', '07특종보험', '08배상책임보험', '09해상보험'];
                                largeCategories.forEach(categoryCode => {
                                    const categoryName = categoryCode.substring(2);
                                    const totalCount = ACIUApp.learning.getTotalQuestionCount(categoryCode);
                                    const button = document.createElement('button');
                                    button.className = 'main-category-button';
                                    button.innerHTML = `
                                        ${categoryName}
                                        <span class="category-count">(${totalCount}문제)</span>
                                    `;
                                    button.onclick = () => ACIUApp.ui.categorySelection.showMidCategories(categoryCode);
                                    if (categoryCode === this.selectedLargeCategory) {
                                        button.classList.add('active'); // 복원된 대분류 활성화
                                    }
                                    container.appendChild(button);
                                });
                            }
                            
                            // 복원된 대분류에 해당하는 중분류 목록을 표시
                            this.showMidCategories(this.selectedLargeCategory); // 이 함수가 중분류 버튼들을 생성하고 표시

                            this.updateBreadcrumb();
                        }
                    } catch (e) {
                        console.error('중분류 학습 상태 복원 실패:', e);
                    }
                }
            }
        },

        // 학습 엔진
        learning: {
            // 학습 상태 변수
            currentQuestionIndex: 0,
            filteredQuestions: [],
            selectedAnswer: null,
            currentQuestion: null,
            isAnswerChecked: false,
            currentMode: null, // 현재 활성화된 학습 모드를 추적

            // 기본 학습 모드 시작
            startMode(mode) {
                console.log(`학습 모드 시작: ${mode}`);
                ACIUApp.ui.hideAllScreens(); // 모든 화면 숨기기
                this.currentMode = mode; // 현재 모드 설정
                
                let targetScreenId = '';
                if (mode === 'basic') {
                    targetScreenId = 'basic-learning-screen';
                    this.startBasicLearning();
                } else if (mode === 'layer1') {
                    targetScreenId = 'large-category-learning-screen';
                    this.startLargeCategoryLearning();
                } else if (mode === 'layer2') {
                    targetScreenId = 'mid-category-learning-screen';
                    this.startMidCategoryLearning();
                } else {
                    ACIUApp.ui.showErrorMessage(`${mode} 모드가 준비 중입니다.`);
                    return; // Exit if mode is not handled
                }
                
                // Show the target screen after its specific setup
                if (targetScreenId) {
                    document.getElementById(targetScreenId).classList.remove('hidden');
                }

                document.getElementById('current-mode').textContent = {
                    'basic': '기본 학습',
                    'layer1': '대분류 학습',
                    'layer2': '중분류 학습',
                    'choice': '선택형 학습',
                    'truefalse': '진위형 학습',
                    'mock': '모의고사'
                }[mode] || '모드 선택';
            },

            // 기본 학습 시작
            startBasicLearning() {
                console.log('기본 학습 모드 시작');
                this.filteredQuestions = ACIUApp.data.questions;
                this.currentQuestionIndex = 0;
                ACIUApp.ui.updateBasicLearningStats();
                if (this.filteredQuestions.length > 0) {
                    this.displayQuestion();
                } else {
                    ACIUApp.ui.showErrorMessage('로딩된 문제가 없습니다. CSV 파일을 확인해주세요.');
                }
                console.log(`총 ${this.filteredQuestions.length}개 문제 로드됨`);
            },

            // 대분류 학습 시작
            startLargeCategoryLearning() {
                console.log('대분류 학습 모드 시작');
                this.selectedCategory = null; // 대분류 선택 초기화
                
                // 대분류 버튼 동적 생성 (기존 코드 재활용)
                const container = document.getElementById('large-category-buttons-container');
                if (!container) {
                    console.error("Error: large-category-buttons-container not found.");
                    return;
                }
                container.innerHTML = '';
                const largeCategories = ['06재산보험', '07특종보험', '08배상책임보험', '09해상보험'];
                largeCategories.forEach(categoryCode => {
                    const categoryName = categoryCode.substring(2); // '06재산보험' -> '재산보험'
                    const totalCount = this.getTotalQuestionCount(categoryCode);
                    const button = document.createElement('button');
                    button.className = 'category-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-4 px-6 rounded-lg transition-all';
                    button.setAttribute('data-category', categoryCode);
                    button.onclick = () => this.selectCategory(categoryCode); // selectCategory 함수 호출 시 코드 전달
                    button.innerHTML = `${categoryName}<br><span class="text-sm">(${totalCount}문제)</span>`;
                    container.appendChild(button);
                });

                ACIUApp.ui.updateLargeCategoryStats(); // 대분류 통계 업데이트
                console.log('대분류 학습 화면 표시됨');
            },

            // 중분류 학습 시작
            startMidCategoryLearning() {
                console.log('중분류 학습 모드 시작');
                
                // 중분류 선택 관리자 초기화 및 상태 복원
                ACIUApp.ui.categorySelection.selectedLargeCategory = null;
                ACIUApp.ui.categorySelection.selectedMidCategory = null;
                ACIUApp.ui.categorySelection.isOtherCategoryOpen = false;
                
                const container = document.getElementById('mid-main-category-buttons'); // 중분류 화면의 대분류 버튼 컨테이너
                if (!container) {
                    console.error("Error: mid-main-category-buttons container not found for initial load.");
                    return;
                }
                container.innerHTML = ''; // 초기화

                const largeCategories = ['06재산보험', '07특종보험', '08배상책임보험', '09해상보험'];
                largeCategories.forEach(categoryCode => {
                    const categoryName = categoryCode.substring(2);
                    const totalCount = this.getTotalQuestionCount(categoryCode);
                    const button = document.createElement('button');
                    button.className = 'main-category-button'; // 중분류 화면용 버튼 클래스
                    button.innerHTML = `
                        ${categoryName}
                        <span class="category-count">(${totalCount}문제)</span>
                    `;
                    button.onclick = () => ACIUApp.ui.categorySelection.showMidCategories(categoryCode); // showMidCategories에 코드 전달
                    container.appendChild(button);
                });

                ACIUApp.ui.categorySelection.restoreState(); // 저장된 대분류 상태 복원 시도 (버튼 생성 후 호출)
                
                console.log('중분류 학습 화면 표시됨');
            },

            // 대분류별 총 문제 수 계산 (LAYER1 기준)
            getTotalQuestionCount(largeCategoryCode) {
                // 실제 questions 배열에서 LAYER1 기준으로 문제 수 계산
                return ACIUApp.data.questions.filter(q => q.LAYER1 === largeCategoryCode).length;
            },

            // 대분류 선택 (대분류 학습 모드용)
            selectCategory(categoryCode) { // 인자 이름을 categoryCode로 변경
                console.log(`대분류 선택: ${categoryCode}`);
                this.selectedCategory = categoryCode; // selectedCategory에 코드 저장
                
                // UI 업데이트
                document.getElementById('selected-category').textContent = categoryCode.substring(2); // UI에는 이름 표시
                
                // 버튼 시각적 피드백
                this.updateCategoryButtonSelection(categoryCode);
                
                // 실제 문제 필터링 (더미 대신 실제 데이터 사용)
                this.filteredQuestions = ACIUApp.data.questions.filter(q => q.LAYER1 === categoryCode);
                
                if (this.filteredQuestions.length === 0) {
                    ACIUApp.ui.showErrorMessage(`"${categoryCode.substring(2)}" 카테고리에는 현재 문제가 없습니다.`);
                    document.getElementById('large-category-question-area').classList.add('hidden');
                    return;
                }

                this.currentQuestionIndex = 0;
                this.displayLargeCategoryQuestion();
                document.getElementById('large-category-question-area').classList.remove('hidden');
                
                console.log(`${categoryCode.substring(2)} 카테고리 선택됨. ${this.filteredQuestions.length} 문제 로드.`);
            },

            // 카테고리 버튼 선택 상태 업데이트 (대분류 학습 모드용)
            updateCategoryButtonSelection(selectedCategoryCode) {
                document.querySelectorAll('#large-category-buttons-container .category-btn').forEach(btn => {
                    btn.classList.remove('ring-4', 'ring-blue-300');
                });
                const selectedButton = document.querySelector(`#large-category-buttons-container [data-category="${selectedCategoryCode}"]`);
                if (selectedButton) {
                    selectedButton.classList.add('ring-4', 'ring-blue-300');
                }
            },

            // 기본 학습 모드 문제 표시
            displayQuestion() {
                if (this.currentQuestionIndex >= this.filteredQuestions.length) {
                    ACIUApp.ui.showErrorMessage('모든 문제를 풀이했습니다!');
                    return;
                }

                this.currentQuestion = this.filteredQuestions[this.currentQuestionIndex];
                this.selectedAnswer = null;
                this.isAnswerChecked = false;

                document.getElementById('current-question-number').textContent = this.currentQuestionIndex + 1;
                document.getElementById('total-questions').textContent = this.filteredQuestions.length;
                document.getElementById('question-type').textContent = this.currentQuestion.TYPE === '진위형' ? '진위형' : '선택형';
                document.getElementById('question-code').textContent = this.currentQuestion.QCODE;
                document.getElementById('layer-info').textContent = `${this.currentQuestion.LAYER1} > ${this.currentQuestion.LAYER2}`;
                document.getElementById('question-text').textContent = this.currentQuestion.QUESTION;

                const answerButtonsContainer = document.getElementById('answer-buttons');
                answerButtonsContainer.innerHTML = ''; // 기존 버튼 초기화

                if (this.currentQuestion.TYPE === '진위형') {
                    answerButtonsContainer.innerHTML = `
                        <button onclick="ACIUApp.learning.selectAnswer('O')" class="answer-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg" data-answer="O">O</button>
                        <button onclick="ACIUApp.learning.selectAnswer('X')" class="answer-btn bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-lg" data-answer="X">X</button>
                    `;
                } else {
                    for (let i = 1; i <= 4; i++) {
                        answerButtonsContainer.innerHTML += `
                            <button onclick="ACIUApp.learning.selectAnswer('${i}')" class="answer-btn bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg" data-answer="${i}">${i}</button>
                        `;
                    }
                }
                document.getElementById('question-area').classList.remove('hidden');
                document.getElementById('result-area').classList.add('hidden');
                document.getElementById('explanation-btn').classList.add('hidden');
                this.resetAnswerButtons(); // 버튼 색상 초기화
            },

            // 대분류 학습 모드 문제 표시
            displayLargeCategoryQuestion() {
                if (this.currentQuestionIndex >= this.filteredQuestions.length) {
                    ACIUApp.ui.showErrorMessage('모든 문제를 풀이했습니다!');
                    return;
                }
                this.currentQuestion = this.filteredQuestions[this.currentQuestionIndex];
                this.selectedAnswer = null;
                this.isAnswerChecked = false;

                document.getElementById('large-category-question-type').textContent = this.currentQuestion.TYPE === '진위형' ? '진위형' : '선택형';
                document.getElementById('large-category-question-code').textContent = this.currentQuestion.QCODE;
                document.getElementById('large-category-layer-info').textContent = `${this.currentQuestion.LAYER1.substring(2)} > ${this.currentQuestion.LAYER2}`; // LAYER1 코드에서 이름만 추출
                document.getElementById('large-category-question-text').textContent = this.currentQuestion.QUESTION;

                const answerButtonsContainer = document.getElementById('large-category-answer-buttons');
                answerButtonsContainer.innerHTML = '';

                if (this.currentQuestion.TYPE === '진위형') {
                    answerButtonsContainer.innerHTML = `
                        <button onclick="ACIUApp.learning.selectAnswer('O', 'large')" class="answer-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg" data-answer="O">O</button>
                        <button onclick="ACIUApp.learning.selectAnswer('X', 'large')" class="answer-btn bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-lg" data-answer="X">X</button>
                    `;
                } else {
                    for (let i = 1; i <= 4; i++) {
                        answerButtonsContainer.innerHTML += `
                            <button onclick="ACIUApp.learning.selectAnswer('${i}', 'large')" class="answer-btn bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg" data-answer="${i}">${i}</button>
                        `;
                    }
                }
                document.getElementById('large-category-result-area').classList.add('hidden');
                document.getElementById('large-category-explanation-btn').classList.add('hidden');
                this.resetAnswerButtons('large'); // 대분류용 버튼 초기화
            },

            // 중분류 학습 모드 문제 표시
            displayMidCategoryQuestion() {
                if (this.currentQuestionIndex >= this.filteredQuestions.length) {
                    ACIUApp.ui.showErrorMessage('모든 문제를 풀이했습니다!');
                    return;
                }

                this.currentQuestion = this.filteredQuestions[this.currentQuestionIndex];
                this.selectedAnswer = null;
                this.isAnswerChecked = false;

                // 브레드크럼에 문제 진행률 업데이트 (중분류 화면 헤더)
                ACIUApp.ui.categorySelection.updateBreadcrumb();

                document.getElementById('mid-category-question-number').textContent = this.currentQuestionIndex + 1;
                document.getElementById('mid-category-total-questions').textContent = this.filteredQuestions.length;
                document.getElementById('mid-category-question-text').textContent = this.currentQuestion.QUESTION;

                const answerButtonsContainer = document.getElementById('mid-category-answer-buttons');
                answerButtonsContainer.innerHTML = '';

                if (this.currentQuestion.TYPE === '진위형') {
                    answerButtonsContainer.innerHTML = `
                        <button onclick="ACIUApp.learning.selectAnswer('O', 'mid')" class="answer-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg" data-answer="O">O</button>
                        <button onclick="ACIUApp.learning.selectAnswer('X', 'mid')" class="answer-btn bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-lg" data-answer="X">X</button>
                    `;
                } else {
                    for (let i = 1; i <= 4; i++) {
                        answerButtonsContainer.innerHTML += `
                            <button onclick="ACIUApp.learning.selectAnswer('${i}', 'mid')" class="answer-btn bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg" data-answer="${i}">${i}</button>
                        `;
                    }
                }
                document.getElementById('mid-category-result-area').classList.add('hidden');
                document.getElementById('mid-category-explanation-btn').classList.add('hidden');
                this.resetAnswerButtons('mid'); // 중분류용 버튼 초기화
            },

            // 중분류 학습용 더미 문제 로드 (Placeholder)
            loadDummyQuestionsForMidCategory(largeCategoryCode, midCategoryName) {
                console.log(`더미 문제 로드 (중분류): ${largeCategoryCode} > ${midCategoryName}`);
                // 실제 CSV 필터링 로직 대신 더미 문제 생성
                this.filteredQuestions = [];
                for (let i = 1; i <= 5; i++) { // 5개의 더미 문제 생성
                    this.filteredQuestions.push({
                        QCODE: `${largeCategoryCode.substring(2)}-${midCategoryName.replace(/\s/g, '')}-DUMMY-${i}`,
                        TYPE: i % 2 === 0 ? '선택형' : '진위형',
                        LAYER1: largeCategoryCode,
                        LAYER2: midCategoryName,
                        LAYER3: `더미세부${i}`,
                        QUESTION: `[${largeCategoryCode.substring(2)} > ${midCategoryName}] 관련 더미 문제 ${i}번입니다. 이 문제는 더미 데이터입니다.`,
                        ANSWER: i % 2 === 0 ? '1' : 'O',
                        EXPLAIN: `이것은 ${largeCategoryCode.substring(2)} ${midCategoryName} 문제 ${i}에 대한 더미 해설입니다.`
                    });
                }
                this.currentQuestionIndex = 0;
                this.displayMidCategoryQuestion();
            },

            // 답안 선택 (모드 인자 추가)
            selectAnswer(answer, mode = 'basic') {
                console.log(`답안 선택 (${mode} 모드):`, answer);
                this.selectedAnswer = answer;
                
                // 모든 답안 버튼 초기화
                this.resetAnswerButtons(mode);
                
                // 선택된 답안 버튼 강조
                let containerId;
                if (mode === 'large') {
                    containerId = 'large-category-answer-buttons';
                } else if (mode === 'mid') {
                    containerId = 'mid-category-answer-buttons';
                } else {
                    containerId = 'answer-buttons';
                }

                const selectedButton = document.querySelector(`#${containerId} [data-answer="${answer}"]`);
                if (selectedButton) {
                    selectedButton.classList.remove('bg-blue-500', 'bg-red-500', 'bg-gray-500');
                    selectedButton.classList.add('bg-yellow-500');
                }
            },

            // 답안 버튼 초기화 (모드 인자 추가)
            resetAnswerButtons(mode = 'basic') {
                let buttons;
                if (mode === 'large') {
                    buttons = document.querySelectorAll('#large-category-answer-buttons .answer-btn');
                } else if (mode === 'mid') {
                    buttons = document.querySelectorAll('#mid-category-answer-buttons .answer-btn');
                } else {
                    buttons = document.querySelectorAll('#answer-buttons .answer-btn');
                }
                
                buttons.forEach(button => {
                    button.classList.remove('bg-yellow-500');
                    if (button.getAttribute('data-answer') === 'O') {
                        button.classList.add('bg-blue-500');
                    } else if (button.getAttribute('data-answer') === 'X') {
                        button.classList.add('bg-red-500');
                    } else {
                        button.classList.add('bg-gray-500');
                    }
                });
            },

            // 정답 확인 (모드 인자 추가)
            checkAnswer(mode = 'basic') {
                if (!this.selectedAnswer) {
                    ACIUApp.ui.showErrorMessage('답안을 선택해주세요.');
                    return;
                }

                console.log(`정답 확인 (${mode} 모드)`);
                this.isAnswerChecked = true;

                const isCorrect = this.selectedAnswer === this.currentQuestion.ANSWER;
                
                let resultArea, resultMessage, explanationBtn;
                
                if (mode === 'large') {
                    resultArea = document.getElementById('large-category-result-area');
                    resultMessage = document.getElementById('large-category-result-message');
                    explanationBtn = document.getElementById('large-category-explanation-btn');
                } else if (mode === 'mid') {
                    resultArea = document.getElementById('mid-category-result-area');
                    resultMessage = document.getElementById('mid-category-result-message');
                    explanationBtn = document.getElementById('mid-category-explanation-btn');
                } else {
                    resultArea = document.getElementById('result-area');
                    resultMessage = document.getElementById('result-message');
                    explanationBtn = document.getElementById('explanation-btn');
                }

                if (isCorrect) {
                    resultMessage.className = 'p-4 rounded-lg bg-green-100 text-green-800';
                    resultMessage.innerHTML = `
                        <div class="flex items-center">
                            <span class="text-2xl mr-2">✅</span>
                            <span class="font-bold">정답입니다!</span>
                        </div>
                    `;
                } else {
                    resultMessage.className = 'p-4 rounded-lg bg-red-100 text-red-800';
                    resultMessage.innerHTML = `
                        <div class="flex items-center">
                            <span class="text-2xl mr-2">❌</span>
                            <span class="font-bold">틀렸습니다.</span>
                            <span class="ml-2">정답: ${this.currentQuestion.ANSWER}</span>
                        </div>
                    `;
                }

                resultArea.classList.remove('hidden');
                explanationBtn.classList.remove('hidden');
                this.saveLearningHistory(isCorrect);
            },

            // 다음 문제 (모드 인자 추가)
            nextQuestion(mode = 'basic') {
                if (this.currentQuestionIndex < this.filteredQuestions.length - 1) {
                    this.currentQuestionIndex++;
                    if (mode === 'large') {
                        this.displayLargeCategoryQuestion();
                    } else if (mode === 'mid') {
                        this.displayMidCategoryQuestion();
                    } else {
                        this.displayQuestion();
                    }
                } else {
                    ACIUApp.ui.showErrorMessage('마지막 문제입니다.');
                }
            },

            // 이전 문제 (모드 인자 추가)
            prevQuestion(mode = 'basic') {
                if (this.currentQuestionIndex > 0) {
                    this.currentQuestionIndex--;
                    if (mode === 'large') {
                        this.displayLargeCategoryQuestion();
                    } else if (mode === 'mid') {
                        this.displayMidCategoryQuestion();
                    } else {
                        this.displayQuestion();
                    }
                } else {
                    ACIUApp.ui.showErrorMessage('첫 번째 문제입니다.');
                }
            },

            // 해설 보기 (모드 인자 추가)
            showExplanation(mode = 'basic') {
                if (this.currentQuestion.EXPLAIN) {
                    ACIUApp.ui.showErrorMessage(`해설: ${this.currentQuestion.EXPLAIN}`); // alert 대신 모달 사용
                } else {
                    ACIUApp.ui.showErrorMessage('해설이 준비되지 않았습니다.');
                }
            },

            // 학습 이력 저장
            saveLearningHistory(isCorrect) {
                if (!this.currentQuestion) return;

                const learningData = {
                    qcode: this.currentQuestion.QCODE,
                    timestamp: new Date().toISOString(),
                    isCorrect: isCorrect,
                    layer1: this.currentQuestion.LAYER1,
                    layer2: this.currentQuestion.LAYER2,
                    mode: this.currentMode // 현재 모드 변수 사용
                };

                // learningHistory.attempts는 객체이므로 QCODE를 키로 사용
                ACIUApp.data.learningHistory.attempts[this.currentQuestion.QCODE] = learningData;
                localStorage.setItem('aciu_learning_history', JSON.stringify(ACIUApp.data.learningHistory));

                console.log('학습 이력 저장됨:', learningData);
                ACIUApp.ui.updateStatistics(); // 메인 통계 업데이트
                ACIUApp.ui.updateLargeCategoryStats(); // 대분류 통계 업데이트
            }
        }
    };

    // ACIUApp 초기화 함수
    ACIUApp.init = async function() {
        console.log('ACIUApp 초기화 시작');
        
        // 브라우저 호환성 확인
        this.compatibility.checkBrowserSupport();
        
        // 데이터 로딩
        await this.data.loadQuestions();
        this.data.loadUserSettings();
        this.data.loadLearningHistory();
        
        // UI 초기화
        this.ui.init();
        
        // 타이머 설정
        ACIUApp.timers.timeUpdate = setInterval(() => ACIUApp.ui.updateCurrentTime(), 1000);
        ACIUApp.timers.quoteUpdate = setInterval(() => ACIUApp.ui.updateQuote(), 10000); // 10초마다 명언 업데이트
        ACIUApp.timers.ddayUpdate = setInterval(() => ACIUApp.ui.updateDdayCount(), 60 * 60 * 1000); // 1시간마다 D-Day 업데이트

        console.log('ACIUApp 초기화 완료');
    };

    // 페이지 로드 시 초기화
    window.addEventListener('load', function() {
        ACIUApp.init();
    });
    </script>
</body>
</html>
