<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ACIU 통계 시스템 샘플앱 - 핵심 로직</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        .section { background: white; margin: 10px 0; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin: 10px 0; }
        .stat-box { background: #f8f9fa; padding: 10px; border-radius: 4px; text-align: center; }
        .stat-value { font-size: 24px; font-weight: bold; color: #007bff; }
        .stat-label { font-size: 12px; color: #666; }
        .question-area { background: #e7f3ff; padding: 15px; margin: 10px 0; border-radius: 8px; }
        .answer-btn { margin: 5px; padding: 10px 20px; font-size: 16px; cursor: pointer; border: none; border-radius: 4px; }
        .answer-btn.selected { background: #ffc107; color: #000; font-weight: bold; }
        .answer-btn.correct-answer { background: #28a745; color: white; }
        .answer-btn.wrong-answer { background: #dc3545; color: white; }
        .disabled { opacity: 0.6; pointer-events: none; }
        .mode-selector { margin: 20px 0; }
        .mode-btn { margin: 5px; padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .debug { background: #fff3cd; padding: 10px; margin: 10px 0; border-radius: 4px; font-family: monospace; font-size: 12px; }
        .user-setup { background: #d4edda; padding: 15px; margin: 10px 0; border-radius: 8px; }
        .reset-btn { background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎯 ACIU 통계 시스템 핵심 로직 샘플앱</h1>
        <p><strong>목적:</strong> 조대표님 요구사항 + 코코치 기획서의 핵심 통계 로직을 간결하게 구현</p>

        <!-- 사용자 설정 영역 -->
        <div class="section user-setup">
            <h3>👤 사용자 설정 (자동 등록 완료 - 7월 29일 고정)</h3>
            <div style="background: #d4edda; padding: 10px; border-radius: 4px; margin: 10px 0;">
                ✅ <strong>조대표님</strong> 자동 등록 완료<br>
                📅 등록일: <strong>2025년 7월 29일</strong><br>
                📱 연락처: <strong>010-1234-5678</strong><br>
                💾 데이터 저장: <strong>활성화</strong>
            </div>
            <button class="reset-btn" onclick="resetAllData()">전체 초기화</button>
            <div id="userStatus">✅ 조대표님 등록완료 (2025-07-29 부터 데이터 기록)</div>
        </div>>
            <input type="text" id="userName" placeholder="조대표" value="조대표">
            <label>휴대폰: </label>
            <input type="text" id="userPhone" placeholder="010-1234-5678" value="010-1234-5678">
            <button onclick="registerUser()">사용자 등록 (데이터 기록 시작)</button>
            <button class="reset-btn" onclick="resetAllData()">전체 초기화</button>
            <button onclick="autoRegister()" style="background: #17a2b8; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin: 5px;">빠른 등록</button>
            <div id="userStatus">미등록 상태 (임시 데이터로 작동 - 새로고침 시 사라집니다)</div>
        </div>

        <!-- 모드 선택 -->
        <div class="section mode-selector">
            <h3>📚 학습 모드 선택</h3>
            <button class="mode-btn" onclick="setMode('basic')">기본학습</button>
            <button class="mode-btn" onclick="setMode('재산보험')">재산보험</button>
            <button class="mode-btn" onclick="setMode('특종보험')">특종보험</button>
            <button class="mode-btn" onclick="setMode('배상책임보험')">배상책임보험</button>
            <button class="mode-btn" onclick="setMode('해상보험')">해상보험</button>
            <div>현재 모드: <span id="currentMode">기본학습</span></div>
        </div>

        <!-- 대문 통계 (조대표님 요구사항) -->
        <div class="section">
            <h3>🏠 대문 통계 (조대표님 요구사항)</h3>
            
            <!-- 1. 보유문제수 현황 -->
            <h4>1. 보유문제수 현황 (SOURCE 필드 기반)</h4>
            <div class="stats-grid">
                <div class="stat-box">
                    <div class="stat-value" id="insQuestions">700</div>
                    <div class="stat-label">인스교재</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="examQuestions">679</div>
                    <div class="stat-label">보험중개사시험</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="totalQuestions">1379</div>
                    <div class="stat-label">전체 문제수</div>
                </div>
            </div>

            <!-- 2. 학습진도 현황 -->
            <h4>2. 학습진도 현황</h4>
            <div class="stats-grid">
                <div class="stat-box">
                    <div class="stat-value" id="completedQuestions">0</div>
                    <div class="stat-label">완료한 문제</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="overallProgress">0%</div>
                    <div class="stat-label">전체 진도율</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="overallAccuracy">0%</div>
                    <div class="stat-label">정답률 (오늘진도율→정답률 변경)</div>
                </div>
            </div>

            <!-- 3. 금일 학습현황 (별도 박스) -->
            <h4>3. 금일 학습현황 (별도 박스)</h4>
            <div class="stats-grid">
                <div class="stat-box">
                    <div class="stat-value" id="todayTotal">0</div>
                    <div class="stat-label">오늘 총 문제수</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="todayCorrect">0</div>
                    <div class="stat-label">오늘 정답수</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="todayAccuracy">0%</div>
                    <div class="stat-label">오늘 정답률</div>
                </div>
            </div>
        </div>

        <!-- 모드별 통계 -->
        <div class="section">
            <h3>📊 현재 모드 통계</h3>
            
            <!-- 기본학습: 누적현황 + 금일현황 -->
            <div id="basicStats">
                <h4>4. 기본학습 (이어풀기 디폴트)</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h5>누적현황</h5>
                        <div class="stats-grid">
                            <div class="stat-box">
                                <div class="stat-value" id="basicCumulativeTotal">0</div>
                                <div class="stat-label">총 문제수</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-value" id="basicCumulativeCorrect">0</div>
                                <div class="stat-label">정답수</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-value" id="basicCumulativeAccuracy">0%</div>
                                <div class="stat-label">정답률</div>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h5>금일현황</h5>
                        <div class="stats-grid">
                            <div class="stat-box">
                                <div class="stat-value" id="basicDailyTotal">0</div>
                                <div class="stat-label">금일 문제수</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-value" id="basicDailyCorrect">0</div>
                                <div class="stat-label">금일 정답수</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-value" id="basicDailyAccuracy">0%</div>
                                <div class="stat-label">금일 정답률</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 대분류학습: 전체 누적 + 카테고리별 -->
            <div id="categoryStats" style="display: none;">
                <h4>5. 대분류학습 (제목 우측에 전체 누적 통계)</h4>
                
                <!-- 5-1. 대분류학습 전체 누적 통계 -->
                <div style="background: #e7f3ff; padding: 10px; border-radius: 4px; margin-bottom: 15px;">
                    <h5>대분류학습 전체 누적 통계 (제목 우측 배치)</h5>
                    <div class="stats-grid">
                        <div class="stat-box">
                            <div class="stat-value" id="largeCategoryTotalAttempted">0</div>
                            <div class="stat-label">총 푼 문제수</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="largeCategoryTotalCorrect">0</div>
                            <div class="stat-label">총 맞은 문제수</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="largeCategoryTotalAccuracy">0%</div>
                            <div class="stat-label">전체 정답률</div>
                        </div>
                    </div>
                </div>

                <!-- 5-2. 특정 카테고리 통계 -->
                <div id="specificCategoryStats">
                    <h5 id="categoryTitle">재산보험 통계</h5>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <h6>누적현황</h6>
                            <div class="stats-grid">
                                <div class="stat-box">
                                    <div class="stat-value" id="categoryCumulativeTotal">0</div>
                                    <div class="stat-label">총 문제수</div>
                                </div>
                                <div class="stat-box">
                                    <div class="stat-value" id="categoryCumulativeCorrect">0</div>
                                    <div class="stat-label">정답수</div>
                                </div>
                                <div class="stat-box">
                                    <div class="stat-value" id="categoryCumulativeAccuracy">0%</div>
                                    <div class="stat-label">정답률</div>
                                </div>
                            </div>
                        </div>
                        <div>
                            <h6>금일현황</h6>
                            <div class="stats-grid">
                                <div class="stat-box">
                                    <div class="stat-value" id="categoryDailyTotal">0</div>
                                    <div class="stat-label">금일 문제수</div>
                                </div>
                                <div class="stat-box">
                                    <div class="stat-value" id="categoryDailyCorrect">0</div>
                                    <div class="stat-label">금일 정답수</div>
                                </div>
                                <div class="stat-box">
                                    <div class="stat-value" id="categoryDailyAccuracy">0%</div>
                                    <div class="stat-label">금일 정답률</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 문제 풀이 영역 -->
        <div class="section">
            <h3>❓ 문제 풀이 (실제 문제 + 정답 판별 + 다음 문제)</h3>
            <div class="question-area">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <div><strong>문제 <span id="currentQuestionNumber">1</span> / <span id="totalQuestionCount">10</span></strong></div>
                    <div><strong>문제코드:</strong> <span id="questionCode">Q001</span></div>
                </div>
                <div><strong>분류:</strong> <span id="questionCategory">재산보험 > 일반재산보험</span></div>
                <div><strong>유형:</strong> <span id="questionType">진위형</span></div>
                <div style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; font-size: 16px; line-height: 1.5;">
                    <span id="questionText">보험의 기본 원리는 위험의 분산이다.</span>
                </div>
                
                <!-- 답안 선택 영역 -->
                <div id="answerButtons" style="margin: 15px 0;">
                    <!-- 진위형/선택형에 따라 동적 생성 -->
                </div>
                
                <!-- 결과 표시 -->
                <div id="answerResult" style="margin: 15px 0;"></div>
                
                <!-- 네비게이션 버튼 -->
                <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                    <button onclick="prevQuestion()" class="mode-btn" style="background: #6c757d;">◀ 이전 문제</button>
                    <button id="checkAnswerBtn" onclick="checkAnswer()" class="mode-btn" style="background: #28a745;">정답 확인</button>
                    <button onclick="nextQuestion()" class="mode-btn" style="background: #007bff;">다음 문제 ▶</button>
                </div>
            </div>
        </div>

        <!-- 디버그 정보 -->
        <div class="section">
            <h3>🔍 디버그 정보 (통계 데이터 구조)</h3>
            <div class="debug" id="debugInfo">통계 데이터가 여기에 표시됩니다...</div>
        </div>

        <!-- 데이터 관리 -->
        <div class="section">
            <h3>💾 데이터 관리 (멀티디바이스 대응)</h3>
            <button onclick="exportData()">데이터 내보내기 (JSON)</button>
            <button onclick="importData()">데이터 가져오기</button>
            <button onclick="showStorageKey()">저장소 키 확인</button>
            <input type="file" id="importFile" accept=".json" style="display: none;" onchange="handleImport(event)">
        </div>
    </div>

    <script>
        // ===== 핵심 데이터 구조 (조대표님 요구사항 + 코코치 기획서) =====
        
        // ===== 문제 데이터베이스 (샘플) =====
        
        const sampleQuestions = [
            {
                code: "Q001",
                question: "보험의 기본 원리는 위험의 분산이다.",
                type: "진위형",
                category: "재산보험",
                subcategory: "일반재산보험",
                answer: "O",
                options: null
            },
            {
                code: "Q002", 
                question: "재산보험에서 보험가액은 보험사고 발생 시점의 피보험이익의 가액을 말한다.",
                type: "진위형",
                category: "재산보험",
                subcategory: "일반재산보험", 
                answer: "O",
                options: null
            },
            {
                code: "Q003",
                question: "자동차보험에서 대인배상보험의 가입은 다음 중 어느 것인가?",
                type: "선택형",
                category: "특종보험",
                subcategory: "자동차보험",
                answer: "1",
                options: ["의무가입", "임의가입", "선택가입", "조건부가입"]
            },
            {
                code: "Q004",
                question: "배상책임보험은 피보험자가 제3자에게 손해를 입힌 경우 법적 책임을 보상하는 보험이다.",
                type: "진위형", 
                category: "배상책임보험",
                subcategory: "일반배상책임",
                answer: "O",
                options: null
            },
            {
                code: "Q005",
                question: "해상보험에서 전손의 종류는 다음 중 몇 가지인가?",
                type: "선택형",
                category: "해상보험", 
                subcategory: "선박보험",
                answer: "2",
                options: ["1가지", "2가지", "3가지", "4가지"]
            },
            {
                code: "Q006",
                question: "보험료는 순보험료와 부가보험료로 구성된다.",
                type: "진위형",
                category: "재산보험",
                subcategory: "일반재산보험",
                answer: "O", 
                options: null
            },
            {
                code: "Q007",
                question: "자동차보험에서 대물배상보험의 보상한도는 다음 중 어느 것인가?",
                type: "선택형",
                category: "특종보험",
                subcategory: "자동차보험", 
                answer: "4",
                options: ["1억원", "2억원", "5억원", "무제한"]
            },
            {
                code: "Q008", 
                question: "생명보험과 손해보험의 구분은 보험목적물의 성질에 따른 것이다.",
                type: "진위형",
                category: "재산보험",
                subcategory: "일반재산보험",
                answer: "X",
                options: null
            },
            {
                code: "Q009",
                question: "해상보험에서 추정전손이 성립하기 위한 조건은 다음 중 어느 것인가?",
                type: "선택형", 
                category: "해상보험",
                subcategory: "선박보험",
                answer: "3",
                options: ["수리비가 보험가액의 50% 초과", "수리비가 보험가액의 70% 초과", "수리비가 보험가액의 80% 초과", "완전히 파괴된 경우"]
            },
            {
                code: "Q010",
                question: "보험계약자와 피보험자는 항상 동일인이어야 한다.",
                type: "진위형",
                category: "재산보험", 
                subcategory: "일반재산보험",
                answer: "X",
                options: null
            }
        ];

        // ===== 문제 풀이 관련 변수들 =====
        
        let currentQuestionIndex = 0;
        let currentQuestions = [];
        let selectedAnswer = null;
        let isAnswerChecked = false;
        
        // ACIU 통합 통계 스키마 (간소화 버전)
        const initStatistics = () => ({
            meta: {
                version: "2.0",
                userName: null,
                registeredAt: null,
                dataStartDate: null,
                lastUpdated: new Date().toISOString()
            },
            questionCounts: {
                "인스교재": 700,
                "보험중개사시험": 679,
                "total": 1379
            },
            global: {
                cumulative: { attempted: 0, correct: 0, accuracy: 0 },
                daily: { attempted: 0, correct: 0, accuracy: 0 }
            },
            modes: {
                basic: {
                    cumulative: { attempted: 0, correct: 0, accuracy: 0 },
                    daily: { attempted: 0, correct: 0, accuracy: 0 }
                },
                categories: {
                    "재산보험": {
                        cumulative: { attempted: 0, correct: 0, accuracy: 0 },
                        daily: { attempted: 0, correct: 0, accuracy: 0 }
                    },
                    "특종보험": {
                        cumulative: { attempted: 0, correct: 0, accuracy: 0 },
                        daily: { attempted: 0, correct: 0, accuracy: 0 }
                    },
                    "배상책임보험": {
                        cumulative: { attempted: 0, correct: 0, accuracy: 0 },
                        daily: { attempted: 0, correct: 0, accuracy: 0 }
                    },
                    "해상보험": {
                        cumulative: { attempted: 0, correct: 0, accuracy: 0 },
                        daily: { attempted: 0, correct: 0, accuracy: 0 }
                    }
                },
                largeCategoryTotal: {
                    cumulative: { attempted: 0, correct: 0, accuracy: 0 },
                    daily: { attempted: 0, correct: 0, accuracy: 0 }
                }
            }
        });

        let currentMode = 'basic';
        let isUserRegistered = true; // 자동 등록으로 변경
        let userStartDate = '2025-07-29T00:00:00.000Z'; // 고정 날짜

        // ===== 문제 관리 함수들 =====
        
        // 모드별 문제 필터링
        function getQuestionsForMode(mode) {
            if (mode === 'basic') {
                return sampleQuestions; // 모든 문제
            } else {
                return sampleQuestions.filter(q => q.category === mode);
            }
        }

        // 현재 문제 표시
        function displayCurrentQuestion() {
            if (currentQuestions.length === 0) {
                document.getElementById('questionText').textContent = '해당 모드의 문제가 없습니다.';
                return;
            }

            const question = currentQuestions[currentQuestionIndex];
            
            // 문제 정보 업데이트
            document.getElementById('currentQuestionNumber').textContent = currentQuestionIndex + 1;
            document.getElementById('totalQuestionCount').textContent = currentQuestions.length;
            document.getElementById('questionCode').textContent = question.code;
            document.getElementById('questionText').textContent = question.question;
            document.getElementById('questionType').textContent = question.type;
            document.getElementById('questionCategory').textContent = `${question.category} > ${question.subcategory}`;
            
            // 답안 버튼 생성
            createAnswerButtons(question);
            
            // 상태 초기화
            selectedAnswer = null;
            isAnswerChecked = false;
            document.getElementById('answerResult').innerHTML = '';
            document.getElementById('checkAnswerBtn').style.display = 'block';
            
            console.log(`문제 ${currentQuestionIndex + 1} 표시:`, question.code);
        }

        // 답안 버튼 생성
        function createAnswerButtons(question) {
            const container = document.getElementById('answerButtons');
            container.innerHTML = '';
            
            if (question.type === '진위형') {
                // O/X 버튼 생성
                const oBtn = document.createElement('button');
                oBtn.className = 'answer-btn';
                oBtn.textContent = 'O';
                oBtn.onclick = () => selectAnswer('O');
                
                const xBtn = document.createElement('button');
                xBtn.className = 'answer-btn';
                xBtn.textContent = 'X';
                xBtn.onclick = () => selectAnswer('X');
                
                container.appendChild(oBtn);
                container.appendChild(xBtn);
                
            } else if (question.type === '선택형') {
                // 1-4번 버튼 생성
                question.options.forEach((option, index) => {
                    const btn = document.createElement('button');
                    btn.className = 'answer-btn';
                    btn.innerHTML = `${index + 1}. ${option}`;
                    btn.onclick = () => selectAnswer((index + 1).toString());
                    container.appendChild(btn);
                });
            }
        }

        // 답안 선택
        function selectAnswer(answer) {
            if (isAnswerChecked) return; // 이미 확인한 경우 선택 불가
            
            selectedAnswer = answer;
            
            // 모든 버튼에서 선택 표시 제거
            document.querySelectorAll('.answer-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // 선택된 버튼에 표시
            event.target.classList.add('selected');
            
            console.log('답안 선택:', answer);
        }

        // 정답 확인
        function checkAnswer() {
            if (!selectedAnswer) {
                alert('답안을 선택해주세요.');
                return;
            }
            
            if (isAnswerChecked) {
                alert('이미 확인한 문제입니다.');
                return;
            }

            const currentQuestion = currentQuestions[currentQuestionIndex];
            const isCorrect = selectedAnswer === currentQuestion.answer;
            
            // 정답 확인 상태 설정
            isAnswerChecked = true;
            
            // 답안 버튼 색상 업데이트
            updateAnswerButtonColors(currentQuestion.answer, selectedAnswer, isCorrect);
            
            // 결과 메시지 표시
            showAnswerResult(isCorrect, currentQuestion.answer);
            
            // 통계 업데이트 (기존 함수 호출)
            updateAllStatistics(isCorrect);
            
            // 정답 확인 버튼 숨기기
            document.getElementById('checkAnswerBtn').style.display = 'none';
            
            console.log(`정답 확인: ${isCorrect ? '정답' : '오답'} (정답: ${currentQuestion.answer}, 선택: ${selectedAnswer})`);
        }

        // 답안 버튼 색상 업데이트
        function updateAnswerButtonColors(correctAnswer, selectedAnswer, isCorrect) {
            document.querySelectorAll('.answer-btn').forEach(btn => {
                const btnAnswer = btn.textContent.charAt(0); // O, X, 1, 2, 3, 4
                
                if (btnAnswer === correctAnswer) {
                    // 정답 버튼은 초록색
                    btn.classList.add('correct-answer');
                } else if (btnAnswer === selectedAnswer && !isCorrect) {
                    // 선택했지만 틀린 답은 빨간색
                    btn.classList.add('wrong-answer');
                }
                
                // 버튼 비활성화
                btn.classList.add('disabled');
            });
        }

        // 결과 메시지 표시
        function showAnswerResult(isCorrect, correctAnswer) {
            const resultDiv = document.getElementById('answerResult');
            
            if (isCorrect) {
                resultDiv.innerHTML = `
                    <div style="color: #28a745; font-weight: bold; font-size: 18px;">
                        ✅ 정답입니다!
                    </div>
                `;
            } else {
                resultDiv.innerHTML = `
                    <div style="color: #dc3545; font-weight: bold; font-size: 18px;">
                        ❌ 오답입니다. 정답은 "${correctAnswer}" 입니다.
                    </div>
                `;
            }
        }

        // 다음 문제
        function nextQuestion() {
            if (currentQuestionIndex < currentQuestions.length - 1) {
                currentQuestionIndex++;
                displayCurrentQuestion();
            } else {
                alert('마지막 문제입니다.');
            }
        }

        // 이전 문제  
        function prevQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                displayCurrentQuestion();
            } else {
                alert('첫 번째 문제입니다.');
            }
        }

        // ===== 핵심 함수들 =====

        // 빠른 등록 함수 추가
        function autoRegister() {
            document.getElementById('userName').value = '조대표';
            document.getElementById('userPhone').value = '010-1234-5678';
            registerUser();
        }

        // 사용자 등록 (조대표님 요구: 등록 시점부터 데이터 기록)
        function registerUser() {
            const userName = document.getElementById('userName').value;
            const userPhone = document.getElementById('userPhone').value;
            
            if (!userName || !userPhone) {
                alert('사용자명과 휴대폰을 입력해주세요');
                return;
            }

            // 조대표님 요구사항: 사용자 등록 시점부터 데이터 기록 시작
            isUserRegistered = true;
            userStartDate = new Date().toISOString();
            
            statistics.meta.userName = userName;
            statistics.meta.registeredAt = userStartDate;
            statistics.meta.dataStartDate = new Date().toISOString().split('T')[0];
            
            // 사용자별 저장소 키 생성 (멀티디바이스 대응)
            const userKey = `${userName}_${userPhone}`.replace(/[^a-zA-Z0-9]/g, '_');
            localStorage.setItem(`aciu_statistics_${userKey}`, JSON.stringify(statistics));
            localStorage.setItem('aciu_current_user', userKey);
            
            document.getElementById('userStatus').innerHTML = 
                `✅ ${userName}님 등록완료 (${userStartDate.split('T')[0]} 부터 데이터 기록)`;
            
            updateAllDisplays();
            console.log('사용자 등록 완료:', userName, userKey);
        }

        // 데이터 저장 (자동 등록 사용자)
        function saveStatistics() {
            console.log('=== 데이터 저장 시작 ===');
            
            const userKey = 'jo_daepyo_010_1234_5678';
            statistics.meta.lastUpdated = new Date().toISOString();
            localStorage.setItem(`aciu_statistics_${userKey}`, JSON.stringify(statistics));
            
            console.log('데이터 저장 완료:', `aciu_statistics_${userKey}`);
            console.log('저장된 통계:', statistics.global.cumulative);
        }

        // 데이터 로드 (자동 등록 사용자)
        function loadStatistics() {
            console.log('=== 데이터 로드 시작 ===');
            
            const userKey = 'jo_daepyo_010_1234_5678';
            const saved = localStorage.getItem(`aciu_statistics_${userKey}`);
            
            if (saved) {
                try {
                    const savedStats = JSON.parse(saved);
                    statistics = { ...initStatistics(), ...savedStats };
                    console.log('저장된 데이터 로드 완료');
                    console.log('로드된 통계:', statistics.global.cumulative);
                } catch (error) {
                    console.error('데이터 로드 실패:', error);
                    statistics = initStatistics();
                }
            } else {
                console.log('저장된 데이터 없음 - 새로 초기화');
                statistics = initStatistics();
            }
            
            // 메타 정보 설정
            statistics.meta.userName = '조대표';
            statistics.meta.registeredAt = userStartDate;
            statistics.meta.dataStartDate = '2025-07-29';
        }

        // 정답률 계산 유틸리티
        function calculateAccuracy(correct, total) {
            return total === 0 ? 0 : Math.round((correct / total) * 100);
        }

        // 진도율 계산
        function calculateProgress(completed, total) {
            return total === 0 ? 0 : Math.round((completed / total) * 100);
        }

        // ===== 핵심 이벤트: 문제 답안 클릭 =====
        function answerQuestion(isCorrect) {
            if (!isUserRegistered) {
                alert('먼저 사용자를 등록해주세요 (데이터 기록을 위해)');
                return;
            }

            console.log('=== 답안 클릭 이벤트 처리 시작 ===');
            console.log('정답여부:', isCorrect, '현재모드:', currentMode);

            // 1. 글로벌 통계 업데이트
            updateGlobalStatistics(isCorrect);

            // 2. 모드별 통계 업데이트
            if (currentMode === 'basic') {
                updateBasicStatistics(isCorrect);
            } else {
                updateCategoryStatistics(currentMode, isCorrect);
                updateLargeCategoryTotalStatistics(isCorrect);
            }

            // 3. 오늘 날짜 기준 일일 통계 업데이트
            updateDailyStatistics(isCorrect);

            // 4. 데이터 저장
            saveStatistics();

            // 5. 화면 업데이트
            updateAllDisplays();

            // 6. 답안 피드백 표시
            showAnswerFeedback(isCorrect);

            console.log('=== 답안 클릭 이벤트 처리 완료 ===');
        }

        // 글로벌 통계 업데이트 (조대표님 요구: 대문 통계)
        function updateGlobalStatistics(isCorrect) {
            statistics.global.cumulative.attempted++;
            if (isCorrect) statistics.global.cumulative.correct++;
            statistics.global.cumulative.accuracy = calculateAccuracy(
                statistics.global.cumulative.correct,
                statistics.global.cumulative.attempted
            );

            statistics.global.daily.attempted++;
            if (isCorrect) statistics.global.daily.correct++;
            statistics.global.daily.accuracy = calculateAccuracy(
                statistics.global.daily.correct,
                statistics.global.daily.attempted
            );
        }

        // 기본학습 통계 업데이트
        function updateBasicStatistics(isCorrect) {
            statistics.modes.basic.cumulative.attempted++;
            if (isCorrect) statistics.modes.basic.cumulative.correct++;
            statistics.modes.basic.cumulative.accuracy = calculateAccuracy(
                statistics.modes.basic.cumulative.correct,
                statistics.modes.basic.cumulative.attempted
            );

            statistics.modes.basic.daily.attempted++;
            if (isCorrect) statistics.modes.basic.daily.correct++;
            statistics.modes.basic.daily.accuracy = calculateAccuracy(
                statistics.modes.basic.daily.correct,
                statistics.modes.basic.daily.attempted
            );
        }

        // 카테고리별 통계 업데이트 (대분류학습)
        function updateCategoryStatistics(category, isCorrect) {
            if (!statistics.modes.categories[category]) {
                statistics.modes.categories[category] = {
                    cumulative: { attempted: 0, correct: 0, accuracy: 0 },
                    daily: { attempted: 0, correct: 0, accuracy: 0 }
                };
            }

            const cat = statistics.modes.categories[category];
            cat.cumulative.attempted++;
            if (isCorrect) cat.cumulative.correct++;
            cat.cumulative.accuracy = calculateAccuracy(cat.cumulative.correct, cat.cumulative.attempted);

            cat.daily.attempted++;
            if (isCorrect) cat.daily.correct++;
            cat.daily.accuracy = calculateAccuracy(cat.daily.correct, cat.daily.attempted);
        }

        // 대분류학습 전체 누적 통계 업데이트
        function updateLargeCategoryTotalStatistics(isCorrect) {
            statistics.modes.largeCategoryTotal.cumulative.attempted++;
            if (isCorrect) statistics.modes.largeCategoryTotal.cumulative.correct++;
            statistics.modes.largeCategoryTotal.cumulative.accuracy = calculateAccuracy(
                statistics.modes.largeCategoryTotal.cumulative.correct,
                statistics.modes.largeCategoryTotal.cumulative.attempted
            );

            statistics.modes.largeCategoryTotal.daily.attempted++;
            if (isCorrect) statistics.modes.largeCategoryTotal.daily.correct++;
            statistics.modes.largeCategoryTotal.daily.accuracy = calculateAccuracy(
                statistics.modes.largeCategoryTotal.daily.correct,
                statistics.modes.largeCategoryTotal.daily.attempted
            );
        }

        // 일일 통계 업데이트 (매일 자정에 리셋되어야 함 - 여기서는 간소화)
        function updateDailyStatistics(isCorrect) {
            // 실제 구현에서는 날짜 체크 후 자정에 daily 통계 리셋 필요
            console.log('일일 통계 업데이트 완료');
        }

        // ===== 화면 업데이트 함수들 =====
        
        // 모든 화면 업데이트
        function updateAllDisplays() {
            updateHomeStatistics();
            updateModeStatistics();
            updateDebugInfo();
        }

        // 대문 통계 업데이트 (조대표님 요구사항) - 로그 추가
        function updateHomeStatistics() {
            console.log('=== 대문 통계 업데이트 시작 ===');
            
            // 1. 보유문제수 현황
            document.getElementById('insQuestions').textContent = statistics.questionCounts["인스교재"];
            document.getElementById('examQuestions').textContent = statistics.questionCounts["보험중개사시험"];
            document.getElementById('totalQuestions').textContent = statistics.questionCounts.total;

            // 2. 학습진도 현황
            const global = statistics.global.cumulative;
            document.getElementById('completedQuestions').textContent = global.attempted;
            document.getElementById('overallProgress').textContent = 
                calculateProgress(global.attempted, statistics.questionCounts.total) + '%';
            document.getElementById('overallAccuracy').textContent = global.accuracy + '%';

            // 3. 금일 학습현황 (조대표님 요구: 별도 박스)
            const daily = statistics.global.daily;
            document.getElementById('todayTotal').textContent = daily.attempted;
            document.getElementById('todayCorrect').textContent = daily.correct;
            document.getElementById('todayAccuracy').textContent = daily.accuracy + '%';
            
            console.log('대문 통계 업데이트 완료:');
            console.log('- 완료한 문제:', global.attempted);
            console.log('- 전체 정답률:', global.accuracy + '%');
            console.log('- 오늘 문제:', daily.attempted);
        }

        // 모드별 통계 업데이트
        function updateModeStatistics() {
            if (currentMode === 'basic') {
                document.getElementById('basicStats').style.display = 'block';
                document.getElementById('categoryStats').style.display = 'none';
                
                // 기본학습 누적현황
                const basic = statistics.modes.basic;
                document.getElementById('basicCumulativeTotal').textContent = basic.cumulative.attempted;
                document.getElementById('basicCumulativeCorrect').textContent = basic.cumulative.correct;
                document.getElementById('basicCumulativeAccuracy').textContent = basic.cumulative.accuracy + '%';
                
                // 기본학습 금일현황
                document.getElementById('basicDailyTotal').textContent = basic.daily.attempted;
                document.getElementById('basicDailyCorrect').textContent = basic.daily.correct;
                document.getElementById('basicDailyAccuracy').textContent = basic.daily.accuracy + '%';
                
            } else {
                document.getElementById('basicStats').style.display = 'none';
                document.getElementById('categoryStats').style.display = 'block';
                
                // 대분류학습 전체 누적 통계
                const largeCategoryTotal = statistics.modes.largeCategoryTotal.cumulative;
                document.getElementById('largeCategoryTotalAttempted').textContent = largeCategoryTotal.attempted;
                document.getElementById('largeCategoryTotalCorrect').textContent = largeCategoryTotal.correct;
                document.getElementById('largeCategoryTotalAccuracy').textContent = largeCategoryTotal.accuracy + '%';
                
                // 특정 카테고리 통계
                document.getElementById('categoryTitle').textContent = currentMode + ' 통계';
                const category = statistics.modes.categories[currentMode];
                if (category) {
                    // 누적현황
                    document.getElementById('categoryCumulativeTotal').textContent = category.cumulative.attempted;
                    document.getElementById('categoryCumulativeCorrect').textContent = category.cumulative.correct;
                    document.getElementById('categoryCumulativeAccuracy').textContent = category.cumulative.accuracy + '%';
                    
                    // 금일현황
                    document.getElementById('categoryDailyTotal').textContent = category.daily.attempted;
                    document.getElementById('categoryDailyCorrect').textContent = category.daily.correct;
                    document.getElementById('categoryDailyAccuracy').textContent = category.daily.accuracy + '%';
                }
            }
        }

        // 디버그 정보 업데이트
        function updateDebugInfo() {
            const debugData = {
                현재모드: currentMode,
                사용자등록: isUserRegistered,
                등록시점: userStartDate,
                전체통계: statistics.global,
                모드통계: currentMode === 'basic' ? statistics.modes.basic : statistics.modes.categories[currentMode],
                저장소키: localStorage.getItem('aciu_current_user')
            };
            document.getElementById('debugInfo').textContent = JSON.stringify(debugData, null, 2);
        }

        // 답안 피드백 표시
        function showAnswerFeedback(isCorrect) {
            const resultDiv = document.getElementById('answerResult');
            const buttons = document.querySelectorAll('.answer-btn');
            
            buttons.forEach(btn => {
                btn.className = 'answer-btn ' + (isCorrect ? 'correct' : 'incorrect');
            });
            
            resultDiv.innerHTML = isCorrect ? 
                '<div style="color: #28a745; font-weight: bold;">✅ 정답입니다!</div>' :
                '<div style="color: #dc3545; font-weight: bold;">❌ 오답입니다!</div>';
            
            // 3초 후 버튼 색상 원복
            setTimeout(() => {
                buttons.forEach(btn => btn.className = 'answer-btn neutral');
                resultDiv.innerHTML = '';
            }, 2000);
        }

        // 모드 설정 함수 수정 (문제 로드 추가)
        function setMode(mode) {
            currentMode = mode;
            document.getElementById('currentMode').textContent = mode;
            
            // 해당 모드의 문제들 로드
            currentQuestions = getQuestionsForMode(mode);
            currentQuestionIndex = 0;
            
            // 첫 번째 문제 표시
            displayCurrentQuestion();
            
            updateModeStatistics();
            console.log('모드 변경:', mode, '문제 수:', currentQuestions.length);
        }

        // ===== 데이터 관리 (멀티디바이스 대응) =====
        
        function exportData() {
            const dataStr = JSON.stringify(statistics, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `aciu_statistics_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            console.log('데이터 내보내기 완료');
        }

        function importData() {
            document.getElementById('importFile').click();
        }

        function handleImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    statistics = { ...initStatistics(), ...importedData };
                    isUserRegistered = !!statistics.meta.userName;
                    
                    if (isUserRegistered) {
                        document.getElementById('userName').value = statistics.meta.userName;
                        document.getElementById('userStatus').innerHTML = 
                            `✅ ${statistics.meta.userName}님 데이터 가져오기 완료`;
                    }
                    
                    updateAllDisplays();
                    console.log('데이터 가져오기 완료');
                    alert('데이터를 성공적으로 가져왔습니다!');
                } catch (error) {
                    console.error('데이터 가져오기 실패:', error);
                    alert('잘못된 데이터 파일입니다.');
                }
            };
            reader.readAsText(file);
        }

        function showStorageKey() {
            const userKey = localStorage.getItem('aciu_current_user');
            const allKeys = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('aciu_')) {
                    allKeys.push(key);
                }
            }
            
            alert(`현재 사용자 키: ${userKey}\n\n모든 ACIU 저장소 키:\n${allKeys.join('\n')}`);
        }

        function resetAllData() {
            if (confirm('정말로 모든 데이터를 초기화하시겠습니까?\n\n이 작업은 되돌릴 수 없습니다.')) {
                // 모든 aciu 관련 localStorage 데이터 삭제
                const keysToRemove = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith('aciu_')) {
                        keysToRemove.push(key);
                    }
                }
                
                keysToRemove.forEach(key => localStorage.removeItem(key));
                
                // 변수 초기화
                statistics = initStatistics();
                isUserRegistered = false;
                userStartDate = null;
                currentMode = 'basic';
                
                // UI 초기화
                document.getElementById('userName').value = '';
                document.getElementById('userPhone').value = '';
                document.getElementById('userStatus').innerHTML = '미등록 상태 (데이터 기록 안됨)';
                document.getElementById('currentMode').textContent = 'basic';
                
                updateAllDisplays();
                console.log('모든 데이터 초기화 완료');
                alert('모든 데이터가 초기화되었습니다.');
            }
        }

        // 앱 초기화 함수 수정 (자동 등록 포함)
        function initApp() {
            console.log('=== ACIU 샘플앱 초기화 ===');
            
            // 1. 자동 사용자 등록 (7월 29일 고정)
            autoInitializeUser();
            
            // 2. 저장된 사용자 데이터 로드 시도
            loadStatistics();
            
            // 3. 초기 화면 업데이트
            updateAllDisplays();
            
            // 4. 기본 모드 설정 및 첫 문제 로드
            setMode('basic');
            
            console.log('앱 초기화 완료 - 자동 등록된 사용자:', statistics.meta.userName);
            console.log('현재 통계 상태:', statistics.global.cumulative);
        }

        // 페이지 로드 시 앱 초기화
        window.onload = initApp;

        // ===== 자동 저장 (30초마다) =====
        setInterval(() => {
            if (isUserRegistered) {
                saveStatistics();
            }
        }, 30000);

        // 페이지 언로드 시 데이터 저장
        window.addEventListener('beforeunload', () => {
            if (isUserRegistered) {
                saveStatistics();
            }
        });

        // ===== 추가 유틸리티 함수들 =====
        
        // 오늘 날짜 키 생성
        function getTodayKey() {
            return new Date().toISOString().split('T')[0];
        }
        
        // 일일 데이터 리셋 체크 (실제 앱에서는 자정마다 실행)
        function checkDailyReset() {
            const today = getTodayKey();
            const lastDate = localStorage.getItem('aciu_last_date');
            
            if (lastDate !== today) {
                // 새로운 날짜 - 일일 통계 리셋
                statistics.global.daily = { attempted: 0, correct: 0, accuracy: 0 };
                statistics.modes.basic.daily = { attempted: 0, correct: 0, accuracy: 0 };
                
                Object.keys(statistics.modes.categories).forEach(category => {
                    statistics.modes.categories[category].daily = { attempted: 0, correct: 0, accuracy: 0 };
                });
                
                statistics.modes.largeCategoryTotal.daily = { attempted: 0, correct: 0, accuracy: 0 };
                
                localStorage.setItem('aciu_last_date', today);
                console.log('일일 통계 리셋 완료:', today);
            }
        }

        // 페이지 로드 시 일일 리셋 체크
        document.addEventListener('DOMContentLoaded', checkDailyReset);

    </script>
</body>
</html>